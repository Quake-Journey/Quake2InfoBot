const { Telegraf } = require('telegraf');
const Table = require('cli-table3');
const { getUserSettings, updateUserSettings, getUserSettingsString, getAllUsers, getBannedUsers, banUser, unbanUser, addAdmin, removeAdmin, getAdmins, deleteUser, deleteAllUsers, banCheck } = require('./db'); // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ —ç—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤ db.js
const { getServerListQ2, queryServerQ2 } = require('./quake2');
const { getServerListQW, queryServerQW } = require('./qw');
const config = require('./config');

const bot = new Telegraf(config.TELEGRAM_TOKEN);
const ownerId = config.OWNER_ID; // ID –≤–ª–∞–¥–µ–ª—å—Ü–∞ –±–æ—Ç–∞
const userTimers = {};
const userContexts = {}; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
const messageIds = {}; // –û–±—ä–µ–∫—Ç –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è ID —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ –∏–≥—Ä–æ–≤—ã–º —Å–µ—Ä–≤–µ—Ä–∞–º
const heuristicHistoryScores = {}; // –ú–∞—Å—Å–∏–≤ –¥–ª—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∏
const heuristicHistoryMaps = {}; // –ú–∞—Å—Å–∏–≤ –¥–ª—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∏
const heuristicHistoryPlayers = {}; // –ú–∞—Å—Å–∏–≤ –¥–ª—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∏
const heuristicHistoryPlayersScores = {}; // –ú–∞—Å—Å–∏–≤ –¥–ª—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∏

// üîÅ –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∫—ç—à –¥–∞–Ω–Ω—ã—Ö –ø–æ —Å–µ—Ä–≤–µ—Ä–∞–º (–≤ –ø–∞–º—è—Ç–∏ –±–æ—Ç–∞)
const globalServerCache = {
  q2: {},   // key: "ip:port" ‚Üí { serverInfo, serverPlayers, lastUpdated, game, ip, port }
  qw: {}
};

// –¢–∞–π–º–µ—Ä –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –æ–ø—Ä–æ—Å–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤
let globalServerTimer = null;
let isGlobalServerCacheRefreshing = false; // üëà –∑–∞—â–∏—Ç–∞ –æ—Ç –Ω–∞–ª–æ–∂–µ–Ω–∏–π

let botName;
let botId;
bot.telegram.getMe().then(botInfo => {
  botName = botInfo.username;
  botId = botInfo.id;
});

//–ø–æ–≥–ª—è–¥–µ—Ç—å https://github.com/kraloveckey/getids-bot/blob/main/treeify.js
//–ø–æ–≥–ª—è–¥–µ—Ç—å https://habr.com/ru/articles/778620/

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

function CheckBan(user) {
  //banned
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∫—É–¥–∞ –¥–æ–±–∞–≤–ª—ë–Ω –±–æ—Ç
function getKind(ctx) {
  try {
    let kind;
    if (ctx.chat.type === 'private') {
      kind = 'private';
    } else if (ctx.chat.type === 'supergroup' || ctx.chat.type === 'group') {
      kind = ctx.chat.type;
    } else {
      kind = ctx.chat.type;
    }
    log('kind=', kind);
    return kind;
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞:', error);
    return 'error';
  }
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

function getUserID(ctx) {
  const kind = getKind(ctx);
  let userId;

  if (kind === 'private') {
    userId = ctx.from.id;
  } else if (kind === 'supergroup' || kind === 'group') {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Ç–µ–º—ã
    const message = ctx.callbackQuery ? ctx.callbackQuery.message : ctx.message;
    const themeId = message.message_thread_id;
    userId = themeId ? ctx.chat.id * themeId : ctx.chat.id;
    if (themeId) updateUserSettings(userId, { themeId: themeId });
  } else {
    userId = ctx.chat.id; // –î–ª—è –∫–∞–Ω–∞–ª–æ–≤ –∏ –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ —á–∞—Ç–æ–≤
  }
  // log('getUserID. kind=' + kind + ', userId=' + userId + ', ctx.chat.id=' + ctx.chat.id + ', message_thread_id=' + message.message_thread_id);



  return userId;
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

bot.start(async (ctx) => {
  try {
    const welcomeMessage = `
üéÆ *–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Quake2InfoBot!*

ü§ñ *@${botName}* - –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –±–æ—Ç –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏–≥—Ä–æ–∫–æ–≤, —Å–µ—Ä–≤–µ—Ä–æ–≤ –∏ –∫–∞—Ä—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞—Ö.
–í   –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –∏–≥—Ä—ã: ${config.GAMES_SUPPORT}, –≤ –±—É–¥—É—â–µ–º –ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø—Ä–æ—á–∏–º–∏ –∏–≥—Ä–∞–º–∏ –≤ —Å–µ—Ä–∏–∏ Quake.

*–û–ø–∏—Å–∞–Ω–∏–µ:*
–ë–æ—Ç –ø–æ–∑–≤–æ–ª—è–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –∏–≥—Ä–æ–∫–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞—Ö, –∞–Ω–∞–ª–∏–∑–∏—Ä—É—è –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–ª—è –±–æ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞, –ø–æ–ª—É—á–∞–µ–º—ã–µ –∏–∑ –≤–Ω–µ—à–Ω–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤.
–ö—Ä–æ–º–µ —Ç–æ–≥–æ, –≤—ã –º–æ–∂–µ—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä—ã –∏ –≤–µ—Å—Ç–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤.
–í—ã —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ—Ç–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–∞—Ä—Ç, –∫–æ—Ç–æ—Ä—ã–µ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É—é—Ç –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Ö –∫–∞–∫ —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞.
–ù–∞–∫–æ–Ω–µ—Ü, –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞–¥–∞–≤–∞—Ç—å —Ç–∞–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –∫–∞–∫ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –∞ —Ç–∞–∫–∂–µ –≤–∫–ª—é—á–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –±–æ—Ç–æ–≤ —Ç–∏–ø–∞ WallFly –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –ø–æ–∏—Å–∫ –±—ã–ª –Ω–∞–∏–±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–µ–Ω.

‚ú® *–ö–∞–∫ –±—ã—Å—Ç—Ä–æ –Ω–∞—á–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º:*
 1) –í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É /siq2 –∏–ª–∏ /siqw –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ –∞–∫—Ç–∏–≤–Ω—ã–º —Å–µ—Ä–≤–µ—Ä–∞–º (—Ç–∞–∫–∏–º, –Ω–∞ –∫–æ—Ç–æ—Ä—ã—Ö –∏–º–µ–µ—Ç—Å—è –Ω–µ –º–µ–Ω–µ–µ –æ–¥–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞)
 2) –í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É /sq2 –∏–ª–∏ /sqw –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –∏–≥—Ä–æ–≤—ã–º —Å–µ—Ä–≤–µ—Ä–∞–º
 3) –í–≤–µ–¥–∏—Ç–∏–µ –∫–æ–º–∞–Ω–¥—É /fq2 <—Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞> –∏–ª–∏ /fqw <—Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞> –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ —á—Ç–æ –ª–∏–±–æ. –ù–∞–ø—Ä–∏–º–µ—Ä, /fq2 playground
 4) –í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É /addgame <–Ω–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã> –∏–ª–∏ /ag, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä—É –≤ —Å–ø–∏—Å–æ–∫ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö –±–æ—Ç–æ–º. –ù–∞–∑–≤–∞–Ω–∏—è –∏–≥—Ä, –∫–æ—Ç–æ—Ä—ã–µ –≤–∞–º –¥–æ—Å—Ç—É–ø–Ω—ã: ${config.GAMES}
 5) –í–∫–ª—é—á–∏—Ç–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π GUI –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö –ø–æ–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥–æ–π /ac 1
 6) –í–∫–ª—é—á–∏—Ç–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ –∏–≥—Ä–æ–∫–∞–º –∫–æ–º–∞–Ω–¥–æ–π /am 1
 7) –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∏—Å–∫–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ —Å–µ—Ä–≤–µ—Ä–∞–º –∫–æ–º–∞–Ω–¥–æ–π /ssq2 –¥–ª—è q2 –∏–ª–∏ /ssqw –¥–ª—è qw , –∞ —Ç–∞–∫–∂–µ –ø–æ –∫–∞—Ä—Ç–∞–º –∫–æ–º–∞–Ω–¥–æ–π /smq2 \\*dm\\* \\*rdm\\* \\*duel\\* –¥–ª—è q2 –∏–ª–∏ /smqw \\*dm\\* –¥–ª—è QuakeWord
 8) –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–π –≤–∞—Å —Å–µ—Ä–≤–µ—Ä –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫–∏ GUI –≤ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –±–æ—Ç–æ–º —Å–µ—Ä–≤–µ—Ä–∞—Ö –∏–ª–∏ —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—ã /asq2 –∏–ª–∏ /asqw
 9) –í–∫–ª—é—á–∏—Ç–µ —Ç–∞–π–º–µ—Ä –∫–æ–º–∞–Ω–¥–æ–π /timer –∏–ª–∏ /t, –Ω–∞–ø—Ä–∏–º–µ—Ä /t 30
 10) –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∏—Å–∫–∞—Ç—å –∏–≥—Ä–æ–∫–∞ –∫–æ–º–∞–Ω–¥–æ–π /sp , –Ω–∞–ø—Ä–∏–º–µ—Ä /sp \\*para\\* –∏–ª–∏ /sp \\*player\\*
 11) –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä–æ–∫–∞ –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —á–µ—Ä–µ–∑ GUI –≤ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –±–æ—Ç–æ–º –∏–≥—Ä–æ–∫–∞—Ö –∏–ª–∏ –∫–æ–º–∞–Ω–¥–æ–π /ap
 12) –ó–∞–ø—É—Å—Ç–∏—Ç–µ –≤—Ä—É—á–Ω—É—é –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–º –≤–∞–º–∏ –∏–≥—Ä–æ–∫–∞–º –∫–æ–º–∞–Ω–¥–æ–π /rp –∏ —Å–µ—Ä–≤–µ—Ä–∞–º –∫–æ–º–∞–Ω–¥–æ–π /rs
 13) –í–∫–ª—é—á–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É /adh 1 –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–∞—Ö / —Å–µ—Ä–≤–µ—Ä–∞—Ö
 14) –í–∫–ª—é—á–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É /hm 1 –¥–ª—è –±–∞–∑–æ–≤–æ–≥–æ —ç–≤—Ä–∏—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∏–≥—Ä–æ–∫–æ–≤ –∏ —Å–µ—Ä–≤–µ—Ä–æ–≤ –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–µ (–±—É–¥—É—Ç –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–≥—Ä–æ–∫–æ–≤ –∏ —Å—á–µ—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)

üìå /info - –≤—ã–¥–∞—ë—Ç –≤–∞—à–∏ —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏. 
      /i - —Å–æ–∫—Ä–∞—â—ë–Ω–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã

üìú *–ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥:*
- –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥–∞—Ö, –≤–≤–µ–¥–∏—Ç–µ /help.

üïµÔ∏è –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /addplayer <–∏–º—è –∏–≥—Ä–æ–∫–∞> –∏–ª–∏ /ap, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä–æ–∫–æ–≤ –≤ —Å–ø–∏—Å–æ–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.
üïµÔ∏è –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /addplayerfilter <–∏–º—è –∏–≥—Ä–æ–∫–∞> –∏–ª–∏ /apf, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä–æ–∫–æ–≤ –≤ —Å–ø–∏—Å–æ–∫ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.
üñ•Ô∏èüïµÔ∏è –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /aspf <address:port> <–∏–º—è –∏–≥—Ä–æ–∫–∞>, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –≤ —Ñ–∏–ª—å—Ç—Ä –ø–∞—Ä—É —Å–µ—Ä–≤–µ—Ä - –∏–≥—Ä–æ–∫

üñ•Ô∏è –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /addserverq2 <address:port> –∏–ª–∏ /asq2, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä Quake 2 –≤ —Å–ø–∏—Å–æ–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.
üñ•Ô∏è –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /addserverqw <address:port> –∏–ª–∏ /asqw, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä QuakeWorld –≤ —Å–ø–∏—Å–æ–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /addmapq2 <–Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã> –∏–ª–∏ /amq2, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç—É Q2 –≤ —Å–ø–∏—Å–æ–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /addmapqw <–Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã> –∏–ª–∏ /amqw, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç—É QuakeWorld –≤ —Å–ø–∏—Å–æ–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
üàÅ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /advcontrols –∏–ª–∏ /ac –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å –∏–ª–∏ –≤—ã–∫–ª—é—á–∏—Ç—å —Å–µ—Ä–≤—Å–∏—Å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö –ø–æ–∏—Å–∫–∞ –¥–ª—è –≤–∞—à–µ–≥–æ —É–¥–æ–±—Å—Ç–≤–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /advmode –∏–ª–∏ /am –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–µ–∂–∏–º—ã –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö –ø–æ–∏—Å–∫–∞ (–≤–∫–ª—é—á–∏—Ç—å / –≤—ã–∫–ª—é—á–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ—Ä–≤–µ—Ä–µ –∏ –∏–≥—Ä–æ–∫–∞—Ö)
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /altview –∏–ª–∏ /av –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π (–∫–æ–º–ø–∞–∫—Ç–Ω—ã–π) —Ä–µ–∂–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /heuristicmode –∏–ª–∏ /hm –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —ç–≤—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–µ
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /minplayers –∏–ª–∏ /mp –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª-–≤–æ –∏–≥—Ä–æ–∫–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∏ —Å–µ—Ä–≤–µ—Ä –±—ã–ª –≤–∫–ª—é—á—ë–Ω –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–∏—Å–∫–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é = 1)
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /minplayerscore –∏–ª–∏ /mp –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª-–≤–æ –æ—á–∫–æ–≤ –∏–≥—Ä–æ–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –∏–≥—Ä–æ–∫ –±—ã–ª –≤–∫–ª—é—á—ë–Ω –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–∏—Å–∫–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é = 0)

üîç –ó–∞–ø—É—Å–∫–∞–π—Ç–µ –ø–æ–∏—Å–∫ / –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∫–æ–º–∞–Ω–¥–∞–º–∏ /refresh, /rp, /rs.
üïì –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª –æ–ø—Ä–æ—Å–∞ —Å –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥—ã /timer <—Å–µ–∫—É–Ω–¥—ã> –µ—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã –±–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–ª —Å–µ—Ä–≤–µ—Ä–∞ –ø–æ –≤–∞—à–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º.
üìö –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ /advmode –≤ —Å–ª—É—á–∞–µ, –µ—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é —Å —Å–µ—Ä–≤–µ—Ä–æ–≤

üîç –î–ª—è —Ä–∞–∑–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞ –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –∫–æ–º–∞–Ω–¥–∞–º–∏:
    - /sp - –æ–Ω–∞ –∏—â–µ—Ç –∏–≥—Ä–æ–∫–æ–≤ –ø–æ –≤—Å–µ–º –≤–∞—à–∏–º –∏–≥—Ä–∞–º —Å—Ä–∞–∑—É
    - /siq2, /ssq2 –∏ /smq2 - –ø–æ–∏—Å–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤ –∏ –∫–∞—Ä—Ç –≤ Quake2
    - /siqw, /ssqw –∏ /smqw - –ø–æ–∏—Å–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤ –∏ –∫–∞—Ä—Ç –≤ QuakeWorld
    - /fq2, /fqw = –ø–æ–∏—Å–∫ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–π –∏–Ω—Ñ—ã
    - /stats, /sq2 –∏ /sqw - –ø—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    - /sq2m –∏ /sqwm - –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤. 

üìú *–ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥:*
- –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥–∞—Ö, –≤–≤–µ–¥–∏—Ç–µ /help.

üí°–ò–¥–µ—è, —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –±–æ—Ç–∞: ly (@QuakeJourney).
–ö–≤–µ–π–∫ –≤–∏–¥–µ–æ: @QuakeVideos, @QuakeChampionsVideos.

üéÆ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –±–æ—Ç–æ–º –∏–≥—Ä—ã: *${config.GAMES_SUPPORT}*

–í–µ—Ä—Å–∏—è –±–æ—Ç–∞: *${config.VERSION}*

`;

    const chunks = welcomeMessage.match(/(.|[\n\r]){1,4096}/g);
    for (const chunk of chunks) {
      // console.log(chunk);
      try {
        await ctx.reply(chunk, { parse_mode: 'Markdown' });
      }
      catch (error) {
        console.log(`–û—à–∏–±–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: `, error);
      }
    }
    const userId = getUserID(ctx);
    const chatId = ctx.chat.id;
    await updateUserSettings(userId, { chatId: chatId });
    userContexts[userId] = ctx; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, –µ—Å–ª–∏ timer —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
    const userSettings = await getUserSettings(userId);

    if (ctx.message.message_thread_id) updateUserSettings(userId, { themeId: ctx.message.message_thread_id });

    if (userSettings && userSettings.timer > 0 && userSettings.timerEnabled == 1) {
      await startAutoSearch(userId, userSettings.timer);
    }
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error) };
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞
//initializeAutoServersUpdate();
console.log('–ó–∞–ø—É—Å–∫ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–ø—Ä–æ—Å–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤...');
startGlobalServerPolling();    // üîÅ –Ω–æ–≤—ã–π –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–ø—Ä–æ—Å —Å–µ—Ä–≤–µ—Ä–æ–≤ –∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∫—ç—à–∞ –≤ –ø–∞–º—è—Ç–∏
console.log('–ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞ –ø–æ –¥–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...');
initializeAutoSearch(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

/*
bot.on('message', (msg) => {
  const text = msg.text;
  const isCommand = false;

  bot.hears(text.replace('/',''), (ctx) => {
    console.log('–ö–æ–º–∞–Ω–¥–∞ /helpadmin –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞!');
    isCommand = true;
  });

  if (!isCommand) {
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è, –Ω–µ —è–≤–ª—è—é—â–µ–≥–æ—Å—è –∫–æ–º–∞–Ω–¥–æ–π
    log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–ø–∏—Å–∞–ª:', text);
    bot.telegram.sendMessage(msg.chat.id, '–Ø –Ω–µ –ø–æ–Ω–∏–º–∞—é —Ç–æ, —á—Ç–æ –≤—ã –Ω–∞–ø–∏—Å–∞–ª–∏ ü¶ä.\n–°–ø–∏—Å–æ–∫ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö –∫–æ–º–∞–Ω–¥: üìú /help');
  }
});
*/
/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

async function helpAdmin(ctx) {
  try {
    const userId = getUserID(ctx);
    userContexts[userId] = ctx; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    console.log('ctx.chat.type=', ctx.chat.type);
    const info = `
ü§ñ *@${botName}* - –±–æ—Ç –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏–≥—Ä–æ–∫–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞—Ö.
    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –∏–≥—Ä—ã: ${config.GAMES_SUPPORT}, –≤ –±—É–¥—É—â–µ–º –ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø—Ä–æ—á–∏–º–∏ –∏–≥—Ä–∞–º–∏ –≤ —Å–µ—Ä–∏–∏ Quake.

üîç *–û–ø–∏—Å–∞–Ω–∏–µ:*
–ë–æ—Ç –ø–æ–∑–≤–æ–ª—è–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –∏–≥—Ä–æ–∫–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞—Ö, –∞–Ω–∞–ª–∏–∑–∏—Ä—É—è –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–ª—è –±–æ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞, –ø–æ–ª—É—á–∞–µ–º—ã–µ –∏–∑ –≤–Ω–µ—à–Ω–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –ª–∏–±–æ –≤–µ–¥–æ–º—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –±–æ—Ç–∞.

üìã *–ö–æ–º–∞–Ω–¥—ã:*

- /help - –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

üìã *–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*

- /users - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö –±–æ—Ç–∞

- /user <userId> - —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –±–æ—Ç–∞ —Å —Ç–∞–∫–∏–º Telegram ID

- /deluser <userId> - —É–¥–∞–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–æ—Ç–∞ (—Å –æ—á–∏—â–µ–Ω–∏–µ–º –µ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫), –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ –±–æ—Ç–∞.

- delallusers - —É–¥–∞–ª—è–µ—Ç –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–æ—Ç–∞ (—Å –æ—á–∏—â–µ–Ω–∏–µ–º –∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫), –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ –±–æ—Ç–∞.

- /ban <userId> - –±–∞–Ω–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–æ—Ç–∞ —Å —Ç–∞–∫–∏–º Telegram ID

- /unban <userId> - —Ä–∞–∑–±–∞–Ω–∏–≤–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–æ—Ç–∞ —Å —Ç–∞–∫–∏–º Telegram ID

- /banlist - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –±–∞–Ω–æ–≤

- /addadm <userId> - –¥–µ–ª–∞–µ—Ç –∞–¥–º–∏–Ω–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–æ—Ç–∞ (–¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–º –∫–æ–º–∞–Ω–¥–∞–º, –∫—Ä–æ–º–µ /deluser –∏ /delallusers)

- /deladm <userID> - —É–¥–∞–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –±–æ—Ç–∞

- /admlist - –ø–æ–∫–∞–∑—ã–≤–µ—Ç —Å–ø–∏—Å–æ–∫ –∞–¥–º–∏–Ω–æ–≤ –±–æ—Ç–∞

- /setbotfilter - –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —Ñ–∏–ª—å—Ç—Ä –ø—Ä–æ—Ç–∏–≤ –±–æ—Ç–æ–≤ —Ç–∏–ø–∞ WallFly —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω–∏ –Ω–µ –º–µ—à–∞–ª–∏ —É—Å–ª–æ–≤–∏—è–º –ø–æ–∏—Å–∫–∞ /minplayers –∏–ª–∏ /mp.

üí° –ò–¥–µ—è, —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –±–æ—Ç–∞: ly (@QuakeJourney).
–ö–≤–µ–π–∫ –≤–∏–¥–µ–æ: @QuakeVideos, @QuakeChampionsVideos.

üéÆ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –±–æ—Ç–æ–º –∏–≥—Ä—ã: *${config.GAMES_SUPPORT}*

–í–µ—Ä—Å–∏—è –±–æ—Ç–∞: *${config.VERSION}*
`;

    ctx.reply(info, { parse_mode: 'Markdown' });
    const chatId = ctx.chat.id;
    await updateUserSettings(userId, { chatId: chatId });

  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error) };
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

bot.command('helpadmin', async (ctx) => {
  try {
    await helpAdmin(ctx);
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error) };
}
);

bot.command('ha', async (ctx) => {
  try {
    await helpAdmin(ctx);
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error) };
}
);

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

async function help(ctx) {
  try {
    const userId = getUserID(ctx);
    userContexts[userId] = ctx; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    const info = `
ü§ñ *@${botName}* - –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –±–æ—Ç –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏–≥—Ä–æ–∫–æ–≤, —Å–µ—Ä–≤–µ—Ä–æ–≤ –∏ –∫–∞—Ä—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞—Ö.
    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –∏–≥—Ä—ã: ${config.GAMES_SUPPORT}, –≤ –±—É–¥—É—â–µ–º –ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø—Ä–æ—á–∏–º–∏ –∏–≥—Ä–∞–º–∏ –≤ —Å–µ—Ä–∏–∏ Quake.

üîç *–û–ø–∏—Å–∞–Ω–∏–µ:*
–ë–æ—Ç –ø–æ–∑–≤–æ–ª—è–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –∏–≥—Ä–æ–∫–æ–≤, —Å–µ—Ä–≤–µ—Ä–∞ –∏ –∏–≥—Ä–æ–≤—ã–µ –∫–∞—Ä—Ç—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞—Ö.
–ö—Ä–æ–º–µ —Ç–æ–≥–æ, –≤—ã –º–æ–∂–µ—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä—ã –∏ –≤–µ—Å—Ç–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è –∏–≥—Ä—ã Quake II –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –±–æ—Ç –ø–æ–ª—É—á–∞–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ —Å —Å–∞–π—Ç–∞ q2server.com).
–í—ã —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ—Ç–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–∞—Ä—Ç, –∫–æ—Ç–æ—Ä—ã–µ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É—é—Ç –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Ö –∫–∞–∫ —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞.
–ù–∞–∫–æ–Ω–µ—Ü, –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞–¥–∞–≤–∞—Ç—å —Ç–∞–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –∫–∞–∫ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –∞ —Ç–∞–∫–∂–µ –≤–∫–ª—é—á–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –±–æ—Ç–æ–≤ —Ç–∏–ø–∞ WallFly –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –ø–æ–∏—Å–∫ –±—ã–ª –Ω–∞–∏–±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–µ–Ω.

‚ú® *–ö–∞–∫ –±—ã—Å—Ç—Ä–æ –Ω–∞—á–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º:*
 1) –í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É /siq2 –∏–ª–∏ /siqw –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ –∞–∫—Ç–∏–≤–Ω—ã–º —Å–µ—Ä–≤–µ—Ä–∞–º (—Ç–∞–∫–∏–º, –Ω–∞ –∫–æ—Ç–æ—Ä—ã—Ö –∏–º–µ–µ—Ç—Å—è –Ω–µ –º–µ–Ω–µ–µ –æ–¥–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞)
 2) –í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É /sq2 –∏–ª–∏ /sqw –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –∏–≥—Ä–æ–≤—ã–º —Å–µ—Ä–≤–µ—Ä–∞–º
 3) –í–≤–µ–¥–∏—Ç–∏–µ –∫–æ–º–∞–Ω–¥—É /fq2 <—Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞> –∏–ª–∏ /fqw <—Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞> –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ —á—Ç–æ –ª–∏–±–æ. –ù–∞–ø—Ä–∏–º–µ—Ä, /fq2 playground
 4) –í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É /addgame <–Ω–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã> –∏–ª–∏ /ag, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä—É –≤ —Å–ø–∏—Å–æ–∫ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö –±–æ—Ç–æ–º. –ù–∞–∑–≤–∞–Ω–∏—è –∏–≥—Ä, –∫–æ—Ç–æ—Ä—ã–µ –≤–∞–º –¥–æ—Å—Ç—É–ø–Ω—ã: ${config.GAMES}
 5) –í–∫–ª—é—á–∏—Ç–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π GUI –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö –ø–æ–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥–æ–π /ac 1
 6) –í–∫–ª—é—á–∏—Ç–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ –∏–≥—Ä–æ–∫–∞–º –∫–æ–º–∞–Ω–¥–æ–π /am 1
 7) –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∏—Å–∫–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ —Å–µ—Ä–≤–µ—Ä–∞–º –∫–æ–º–∞–Ω–¥–æ–π /ssq2 –¥–ª—è q2 –∏–ª–∏ /ssqw –¥–ª—è qw , –∞ —Ç–∞–∫–∂–µ –ø–æ –∫–∞—Ä—Ç–∞–º –∫–æ–º–∞–Ω–¥–æ–π /smq2 \\*dm\\* \\*rdm\\* \\*duel\\* –¥–ª—è q2 –∏–ª–∏ /smqw \\*dm\\* –¥–ª—è QuakeWord
 8) –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–π –≤–∞—Å —Å–µ—Ä–≤–µ—Ä –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫–∏ GUI –≤ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –±–æ—Ç–æ–º —Å–µ—Ä–≤–µ—Ä–∞—Ö –∏–ª–∏ —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—ã /asq2 –∏–ª–∏ /asqw
 9) –í–∫–ª—é—á–∏—Ç–µ —Ç–∞–π–º–µ—Ä –∫–æ–º–∞–Ω–¥–æ–π /timer –∏–ª–∏ /t, –Ω–∞–ø—Ä–∏–º–µ—Ä /t 30
 10) –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∏—Å–∫–∞—Ç—å –∏–≥—Ä–æ–∫–∞ –∫–æ–º–∞–Ω–¥–æ–π /sp , –Ω–∞–ø—Ä–∏–º–µ—Ä /sp \\*para\\* –∏–ª–∏ /sp \\*player\\*
 11) –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä–æ–∫–∞ –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —á–µ—Ä–µ–∑ GUI –≤ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –±–æ—Ç–æ–º –∏–≥—Ä–æ–∫–∞—Ö –∏–ª–∏ –∫–æ–º–∞–Ω–¥–æ–π /ap
 12) –í–∫–ª—é—á–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É /hm 1 –¥–ª—è –±–∞–∑–æ–≤–æ–≥–æ —ç–≤—Ä–∏—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∏–≥—Ä–æ–∫–æ–≤ –∏ —Å–µ—Ä–≤–µ—Ä–æ–≤ –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–µ (–±—É–¥—É—Ç –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–≥—Ä–æ–∫–æ–≤ –∏ —Å—á–µ—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)

üìã *–ö–æ–º–∞–Ω–¥—ã:*

üìå /start - —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ –æ–∫–Ω–æ –±–æ—Ç–∞

üìå /help - —Å–ø—Ä–∞–≤–æ—á–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º (—Ä–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è)
      /h - —Å–æ–∫—Ä–∞—â—ë–Ω–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã.
      
üìå /addgame <–Ω–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã) - –¥–æ–±–∞–≤–ª—è–µ—Ç –∏–≥—Ä—É –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É —Ä–∞–±–æ—Ç—ã –±–æ—Ç–æ–º. –î–æ—Å—Ç—É–ø–Ω—ã–µ –∏–≥—Ä—ã: ${config.GAMES}
      –ù–∞–ø—Ä–∏–º–µ—Ä, /addgame qw –¥–æ–±–∞–≤–ª—è–µ—Ç –∏–≥—Ä—É QuakeWorld
      /ag - —Å–æ–∫—Ä–∞—â—ë–Ω–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã.

üïµÔ∏è /addplayer <–Ω–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–∞> - –¥–æ–±–∞–≤–ª—è–µ—Ç –∏–≥—Ä–æ–∫–∞ –≤ —Å–ø–∏—Å–æ–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –±–æ—Ç–æ–º. 
      –ù–∞–ø—Ä–∏–º–µ—Ä, /addplayer \\*David\\* (–æ–±—Ä–∞–º–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∑–≤–µ–∑–¥–æ—á–∫–∞–º–∏) –Ω–∞–π–¥–µ—Ç –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤, –≤ –∏–º–µ–Ω–∏ –∫–æ—Ç–æ—Ä—ã—Ö –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è –ø–æ–¥—Å—Ç—Ä–æ–∫–∞ David –ª–∏–±–æ david –ª–∏–±–æ daVid –∏ —Ç.–¥.
      /ap = —Å–æ–∫—Ä–∞—à—ë–Ω–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã.
  üí°–í–ê–ñ–ù–û: –ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –∏—Å–∫–∞—Ç—å –∏–≥—Ä–æ–∫–æ–≤, –≤ –∏–º–µ–Ω–∏ –∫–æ—Ç–æ—Ä—ã—Ö –∏–º–µ—é—Ç—Å—è –ø—Ä–æ–±–µ–ª—ã, –æ–±—Ä–∞–º–ª—è–π—Ç–µ –∏–º—è –∫–∞–≤—ã—á–∫–∞–º–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä, /addplayer "\\*Q u a d\\*" –∏ /addplayer "Q u a d e r" - —Å —Ç–∞–∫–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –≤—ã —Å–º–æ–∂–µ—Ç–µ –Ω–∞–π—Ç–∏ –∑–∞—Ç–µ–º –∏–≥—Ä–æ–∫–∞ —Å –Ω–∏–∫–æ–º Q u a D e R. 
  üí°–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–º–≤–æ–ª–∞(–æ–≤) –ø—Ä–∏ —É–∫–∞–∑–∞–Ω–∏–∏ –∏–º–µ–Ω–∏ –∏–≥—Ä–æ–∫–∞ –±–µ–∑ –º–∞—Å–∫–∏: ${config.PLAYERS_NICK_NAME_LIMIT}.
  üí°–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–º–≤–æ–ª–∞(–æ–≤) –ø—Ä–∏ —É–∫–∞–∑–∞–Ω–∏–∏ –∏–º–µ–Ω–∏ –∏–≥—Ä–æ–∫–∞ —Å –º–∞—Å–∫–æ–π: ${config.PLAYERS_NICK_NAME_MASK_LIMIT}.
  üí°–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å: ${config.PLAYERS_COUNT_LIMIT}.
  üí°–í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–ª—è—Ç—å —Å—Ä–∞–∑—É –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–≥—Ä–æ–∫–æ–≤, —Ä–∞–∑–¥–µ–ª—è—è –∏—Ö –ø—Ä–æ–±–µ–ª–∞–º–∏ - –Ω–∞–ø—Ä–∏–º–µ—Ä: /addplayer *David* *purri* *syanid*

üïµÔ∏è /addplayerfilter <–Ω–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–∞> - –¥–æ–±–∞–≤–ª—è–µ—Ç –∏–≥—Ä–æ–∫–∞ –≤ —Å–ø–∏—Å–æ–∫ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –±–æ—Ç–æ–º.
  üí°–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è —Ç–∞–∫–∏–µ –∂–µ –∫–∞–∫ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã /addplayer.
      /apf = —Å–æ–∫—Ä–∞—â—ë–Ω–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã.

üñ•Ô∏èüïµÔ∏è /aspf <IPAddress:Port –ª–∏–±–æ Domen:Port> <–Ω–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–∞> - –¥–æ–±–∞–≤–ª—è–µ—Ç –ø–∞—Ä—É —Å–µ—Ä–≤–µ—Ä - –∏–≥—Ä–æ–∫ –≤ —Å–ø–∏—Å–æ–∫ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –±–æ—Ç–æ–º.
  üí°–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –¥–ª—è —É–∫–∞–∑–∞–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞ —Ç–∞–∫–∏–µ –∂–µ –∫–∞–∫ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã /addserverq2 –∏ /addserverqw.
  üí°–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏—è –∏–≥—Ä–æ–∫–∞ —Ç–∞–∫–∏–µ –∂–µ –∫–∞–∫ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã /addplayer.

üñ•Ô∏è /addserverq2 <IPAddress:Port –ª–∏–±–æ Domen:Port> –ª–∏–±–æ /addserverqw –¥–ª—è QW - –¥–æ–±–∞–≤–ª—è–µ—Ç —Å–µ—Ä–≤–µ—Ä –≤ —Å–ø–∏—Å–æ–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –±–æ—Ç–æ–º. –ù–∞–ø—Ä–∏–º–µ—Ä, /addserverq2 q2.playground.ru:27910
  üí°–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ—Ä–≤–µ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å: ${config.SERVERS_COUNT_LIMIT}.
  üí°–í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–ª—è—Ç—å —Å—Ä–∞–∑—É –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ—Ä–≤–µ—Ä–æ–≤, —Ä–∞–∑–¥–µ–ª—è—è –∏—Ö –ø—Ä–æ–±–µ–ª–∞–º–∏ - –Ω–∞–ø—Ä–∏–º–µ—Ä: /addserverq2 q2.playground.ru:27910 104.15.247.5:27910
      /asq2 –∏ /asqw - —Å–æ–∫—Ä–∞—â—ë–Ω–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã.

üìå /addmapq2 <–Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã> –¥–ª—è Q2 –ª–∏–±–æ /addmapqw –¥–ª—è QW - –¥–æ–±–∞–≤–ª—è–µ—Ç –∏–≥—Ä–æ–≤—É—é –∫–∞—Ä—Ç—É –≤ —Å–ø–∏—Å–æ–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –±–æ—Ç–æ–º.
  üí°–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ñ–æ—Ä–º–∞—Ç—É –Ω–∞–∑–≤–∞–Ω–∏—è –∫–∞—Ä—Ç—ã —Ç–∞–∫–∏–µ –∂–µ –∫–∞–∫ –¥–ª—è –∏–º–µ–Ω –∏–≥—Ä–æ–∫–æ–≤ –≤ –∫–æ–º–∞–Ω–¥–µ /addplayer.
      /amq2 –ª–∏–±–æ /amqw - —Å–æ–∫—Ä–∞—â—ë–Ω–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã.

üïµÔ∏è /delplayer <–Ω–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–∞> - —É–¥–∞–ª—è–µ—Ç –∏–≥—Ä–æ–∫–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –±–æ—Ç–æ–º. –ù–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ —Ä–∞–Ω–µ–µ –∑–∞–≤–æ–¥–∏–ª–∏ \\*David\\*, —Ç–æ –Ω—É–∂–Ω–æ –ø–∏—Å–∞—Ç—å /delplayer \\*David\\*, –∞ –µ—Å–ª–∏ –∑–∞–≤–æ–¥–∏–ª–∏ "\\*Q u a d*\\*", —Ç–æ –Ω–∞–¥–æ –∏ –ø–∏—Å–∞—Ç—å /delplayer "\\*Q u a d*\\*"
      /dp - —Å–æ–∫—Ä–∞—â—ë–Ω–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã.

üïµÔ∏è /delplayerfilter <–Ω–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–∞> - —É–¥–∞–ª—è–µ—Ç  –∏–≥—Ä–æ–∫–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –±–æ—Ç–æ–º.
  üí°–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è —Ç–∞–∫–∏–µ –∂–µ –∫–∞–∫ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã /delplayer.
      /dpf = —Å–æ–∫—Ä–∞—â—ë–Ω–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã.

üñ•Ô∏è /delserverq2 <IPAddress:Port –¥–ª—è Q2 –ª–∏–±–æ Domen:Port> –ª–∏–±–æ /delserverqw –¥–ª—è QW - —É–¥–∞–ª—è–µ—Ç —Å–µ—Ä–≤–µ—Ä –∏–∑ —Å–ø–∏—Å–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –±–æ—Ç–æ–º 
     /dsq2 –ª–∏–±–æ /dsqw - —Å–æ–∫—Ä–∞—â—ë–Ω–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã.

üìå /delmapq2 <IPAddress:Port –¥–ª—è Q2 –ª–∏–±–æ Domen:Port> –ª–∏–±–æ /delmapqw –¥–ª—è QW - —É–¥–∞–ª—è–µ—Ç –∫–∞—Ä—Ç—É –∏–∑ —Å–ø–∏—Å–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –±–æ—Ç–æ–º 
     /dmq2 –ª–∏–±–æ /dmqw - —Å–æ–∫—Ä–∞—â—ë–Ω–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã.

üìå delall - —É–¥–∞–ª—è–µ—Ç –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–∏—Å–∫–∞. –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –∫–æ–º–∞–Ω–¥–∞ —É–¥–∞–ª—è–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π. 
  ‚ö†Ô∏è–î–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É delallp, —Ñ–∏–ª—å—Ç—Ä–∞ –∏–≥—Ä–æ–∫–æ–≤ - –∫–æ–º–∞–Ω–¥—É delallpf,  —Å–µ—Ä–≤–µ—Ä–æ–≤ - –∫–æ–º–∞–Ω–¥—É delalls, –∫–∞—Ä—Ç - –∫–æ–º–∞–Ω–¥—É delallm (–ø–æ—Å—Ç–∞–≤—å—Ç–µ —Å–∏–º–≤–æ–ª / –ø–µ—Ä–µ–¥ –Ω–∞–∑–≤–∞–Ω–∏–µ–º –∫–æ–º–∞–Ω–¥—ã).

üïµÔ∏è /minplayers - –∑–∞–¥–∞—ë—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª-–≤–æ –∏–≥—Ä–æ–∫–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã —Å–µ—Ä–≤–µ—Ä –±—ã–ª –≤–∫–ª—é—á—ë–Ω –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–∏—Å–∫–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é = 1)
      /mp - —Å–æ–∫—Ä–∞—â—ë–Ω–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã

üïµÔ∏è /minplayerscore - –∑–∞–¥–∞—ë—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª-–≤–æ –æ—á–∫–æ–≤ –∏–≥—Ä–æ–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –∏–≥—Ä–æ–∫ –±—ã–ª –≤–∫–ª—é—á—ë–Ω –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–∏—Å–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é = 0)
      /mps - —Å–æ–∫—Ä–∞—â—ë–Ω–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã      

üìå /botfilter - –≤–∫–ª—é—á–∞–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –±–æ—Ç–æ–≤ —Å–µ—Ä–≤–µ—Ä–æ–≤ —Ç–∏–ø–∞ "–∏–≥—Ä–æ–∫–æ–≤" —Å –∏–º–µ–Ω–µ–º WallFly[BZZZ] —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω–∏ –Ω–µ –≤–ª–∏—è–ª–∏ –Ω–∞ /minplayers. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ñ–∏–ª—å—Ç—Ä –≤–∫–ª—é—á—ë–Ω.
  üí°–î–ª—è –ø—Ä–∏–º–µ—Ä–∞, –µ—Å–ª–∏ –≤—ã –∑–∞–¥–∞–¥–∏—Ç–µ /minplayers 1 –∏ –≤–∫–ª—é—á–∏—Ç–µ —Ñ–∏–ª—å—Ç—Ä –±–æ—Ç–æ–≤ –∫–æ–º–∞–Ω–¥–æ–π /botfilter 1, —Ç–æ —Ç–∞–∫–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ –≤–∫–ª—é—á–∞—Ç—Å—è –≤ –ø–æ–∏—Å–∫ –≤ —Å–ª—É—á–∞–µ –µ—Å–ª–∏ –Ω–∞ –Ω–∏—Ö –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –∏–≥—Ä–æ–∫ —Å –∏–º–µ–Ω–µ–º WallFly[BZZZ] –∫–æ–≥–¥–∞ –≤—ã –±—É–¥–µ—Ç–µ –∏—Å–∫–∞—Ç—å —Å–µ—Ä–≤–µ—Ä–∞ –ø–æ –∏–≥—Ä–æ–≤—ã–º –∫–∞—Ä—Ç–∞–º –∫–æ–º–∞–Ω–¥–æ–π /smq2.
      /bf - —Å–æ–∫—Ä–∞—â—ë–Ω–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã

üìå /info - –≤—ã–¥–∞—ë—Ç –≤–∞—à–∏ —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏. 
      /i - —Å–æ–∫—Ä–∞—â—ë–Ω–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã

üïì /timer <—Å–µ–∫—É–Ω–¥—ã> - –∏–Ω—Ç–µ—Ä–≤–∞–ª –∑–∞–ø—É—Å–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –Ω–∞–ª–∏—á–∏—è –∏–≥—Ä–æ–∫–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞—Ö. –ü—Ä–∏ /timer 0 –æ—Ç–∫–ª—é—á–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ. –í–∞–∂–Ω–æ: –Ω–µ –∑–∞–¥–∞–≤–∞–π—Ç–µ —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è, —ç—Ç–æ –º–æ–∂–µ—Ç —É–≤–µ–ª–∏—á–∏—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∑–∞—Å—ã–ø–∞—Ç—å –≤–∞—Å —Å–ø–∞–º-—Å–æ–æ–±—â–µ–Ω–∏—è–º–∏. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ - –æ—Ç 60 —Å–µ–∫—É–Ω–¥ –∏ –±–æ–ª–µ–µ. –ù–∞–ø—Ä–∏–º–µ—Ä, /timer 600 - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ 1 —Ä–∞–∑ –≤ 600 —Å–µ–∫—É–Ω–¥ (—Ç.–µ., 10 –º–∏–Ω—É—Ç).
  üí°–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: ${config.MIN_TIMER} —Å–µ–∫—É–Ω–¥(—ã).
      /t - —Å–æ–∫—Ä–∞—â—ë–Ω–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã

üìå /sleeptime <–≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞-–≤—Ä–µ–º—è –∫–æ–Ω—Ü–∞> - –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è —Å–Ω–∞, –≤–æ –≤—Ä–µ–º—è –∫–æ—Ç–æ—Ä–æ–≥–æ –±–æ—Ç –Ω–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏–≥—Ä–æ–∫–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞—Ö. –ù–∞–ø—Ä–∏–º–µ—Ä, /sleeptime 23:00-11:00.
      /st - —Å–æ–∫—Ä–∞—â—ë–Ω–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã

üìå /refresh - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ - –∏–≥—Ä–æ–∫–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ /timer –∏ /sleeptime.
      /r - —Å–æ–∫—Ä–∞—â—ë–Ω–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã

üìå /rp - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ –ø–æ–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–¥–∞–Ω—ã –≤ –≤–∞—à–∏—Ö –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ /timer –∏ /sleeptime.

üìå /rs - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ –∞–ø–¥–µ–π—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–¥–∞–Ω—ã –≤ –≤–∞—à–∏—Ö –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ /timer–∏ /sleeptime.

üìö /advmode - –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ —Å –Ω–∞–π–¥–µ–Ω–Ω—ã–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∏–≥—Ä–æ–∫–æ–º (0 - –æ—Ç–∫–ª—é—á–µ–Ω–æ, 1 - –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–µ–∫—É—â–µ–º —Å—á–µ—Ç–µ –∏ –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–∞—Ö, 2 - –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö —Å–µ—Ä–≤–µ—Ä–∞, 3 - –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Å–µ–π –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏).
      /am - —Å–æ–∫—Ä–∞—â—ë–Ω–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã

üàÅ /advcontrols - –≤–∫–ª—é—á–∞–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö –ø–æ–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤ (0 - –æ—Ç–∫–ª—é—á–µ–Ω–æ, 1 - –≤–∫–ª—é—á–µ–Ω–æ).
      /ac - —Å–æ–∫—Ä–∞—â—ë–Ω–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã

üìå /altview - –≤–∫–ª—é—á–∞–µ—Ç –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π (–∫–æ–º–ø–∞–∫—Ç–Ω—ã–π) —Ä–µ–∂–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (0 - –æ—Ç–∫–ª—é—á–µ–Ω–æ, 1 - –≤–∫–ª—é—á–µ–Ω–æ).
      /av - —Å–æ–∫—Ä–∞—â—ë–Ω–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã

üìå /autodelhistory - –≤–∫–ª—é—á–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–∞—Ö / —Å–µ—Ä–≤–µ—Ä–∞—Ö (0 - –æ—Ç–∫–ª—é—á–µ–Ω–æ, 1 - –≤–∫–ª—é—á–µ–Ω–æ).
      /adh - —Å–æ–∫—Ä–∞—â—ë–Ω–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã      

üßä /heuristicmode - –í–∫–ª—é—á–∞–µ—Ç –±–∞–∑–æ–≤—ã–π —ç–≤—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∏–≥—Ä–æ–∫–æ–≤ –∏ —Å–µ—Ä–≤–µ—Ä–æ–≤ (–±—É–¥—É—Ç –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–≥—Ä–æ–∫–æ–≤ –∏ —Å—á–µ—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ) (0 - –æ—Ç–∫–ª—é—á–µ–Ω–æ, 1 - –≤–∫–ª—é—á–µ–Ω–æ).
      /hm - —Å–æ–∫—Ä–∞—â—ë–Ω–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã         


üìå /sp <–∏–º—è –∏–≥—Ä–æ–∫–∞> - —Ä–∞–∑–æ–≤—ã–π –ø–æ–∏—Å–∫ –∏–≥—Ä–æ–∫–∞ –±–µ–∑ —É—á–µ—Ç–∞ –ø—Ä–æ—á–∏—Ö –≤–∞—à–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞ –ø–æ –º–∞—Å–∫–µ —Ç–∞–∫–∏–µ –∂–µ, –∫–∞–∫ –æ–ø–∏—Å–∞–Ω–æ –≤—ã—à–µ –ø–æ –∫–æ–º–∞–Ω–¥–µ /addplayer)
  üí°–í–ê–ñ–ù–û: –ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –∏—Å–∫–∞—Ç—å –∏–≥—Ä–æ–∫–æ–≤, –≤ –∏–º–µ–Ω–∏ –∫–æ—Ç–æ—Ä—ã—Ö –∏–º–µ—é—Ç—Å—è –ø—Ä–æ–±–µ–ª—ã, –æ–±—Ä–∞–º–ª—è–π—Ç–µ –∏–º—è –∫–æ–≤—ã—á–∫–∞–º–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä, /sp "\\*Q u a d\\*" –∏ /sp "Q u a d e r" –Ω–∞–π–¥–µ—Ç –∏–≥—Ä–æ–∫–∞ —Å –Ω–∏–∫–æ–º Q u a D e R. –∞ 

üìå /siq2 - –æ—Ç—á—ë—Ç –Ω–∞–ª–∏—á–∏—è –∏–≥—Ä–æ–∫–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞—Ö Q2 —Å —É—á–µ—Ç–æ–º –Ω–∞—Å—Ç—Ä–æ–µ–∫ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª-–≤–∞ –∏–≥—Ä–æ–∫–æ–≤ /mp –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –±–æ—Ç–æ–≤ /bf. 
üìå /siqw - –æ—Ç—á—ë—Ç –Ω–∞–ª–∏—á–∏—è –∏–≥—Ä–æ–∫–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞—Ö QW —Å —É—á–µ—Ç–æ–º –Ω–∞—Å—Ç—Ä–æ–µ–∫ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª-–≤–∞ –∏–≥—Ä–æ–∫–æ–≤ /mp –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –±–æ—Ç–æ–≤ /bf. 

üìå /stats, /sq2 –∏ /sqw - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤. 
üìå /sq2m –∏ /sqwm - –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤. 
üìå /fq2 <—Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞> –∏ /fqw <—Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞> - –ø–æ–∏—Å–∫ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–π –∏–Ω—Ñ—ã. –ù–∞–ø—Ä–∏–º–µ—Ä, /fq2 playground

üìå /ssq2 - —Ä–∞–∑–æ–≤—ã–π –ø–æ–∏—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ Q2 –±–µ–∑ —É—á–µ—Ç–∞ –ø—Ä–æ—á–∏—Ö –≤–∞—à–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫—Ä–æ–º–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–∞—Ä—Ç –µ—Å–ª–∏ (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞—Ç–∞–∫–∏–µ –∂–µ, –∫–∞–∫ –æ–ø–∏—Å–∞–Ω–æ –≤—ã—à–µ –ø–æ –∫–æ–º–∞–Ω–¥–µ /addserverq2).
üìå /ssqw - —Ä–∞–∑–æ–≤—ã–π –ø–æ–∏—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ QW –±–µ–∑ —É—á–µ—Ç–∞ –ø—Ä–æ—á–∏—Ö –≤–∞—à–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫—Ä–æ–º–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–∞—Ä—Ç –µ—Å–ª–∏ (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞—Ç–∞–∫–∏–µ –∂–µ, –∫–∞–∫ –æ–ø–∏—Å–∞–Ω–æ –≤—ã—à–µ –ø–æ –∫–æ–º–∞–Ω–¥–µ /addserverqw).

üìå /smq2 - —Ä–∞–∑–æ–≤—ã–π –ø–æ–∏—Å–∫ –∫–∞—Ä—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞—Ö Q2 –±–µ–∑ —É—á–µ—Ç–∞ –ø—Ä–æ—á–∏—Ö –≤–∞—à–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞—Ç–∞–∫–∏–µ –∂–µ, –∫–∞–∫ –æ–ø–∏—Å–∞–Ω–æ –≤—ã—à–µ –ø–æ –∫–æ–º–∞–Ω–¥–µ /addserverq2).
  üí° –í—ã –º–æ–∂–µ—Ç–µ —É–∫–∞–∑—ã–≤–∞—Ç—å –≤ –ø–æ–∏—Å–∫–µ —Å—Ä–∞–∑—É –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–∞—Ä—Ç - –Ω–∞–ø—Ä–∏–º–µ—Ä, /smq2 \\*q2dm\\* \\*q2rdm\\* q2duel5 
üìå /smqw - —Ä–∞–∑–æ–≤—ã–π –ø–æ–∏—Å–∫ –∫–∞—Ä—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞—Ö QW –±–µ–∑ —É—á–µ—Ç–∞ –ø—Ä–æ—á–∏—Ö –≤–∞—à–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞—Ç–∞–∫–∏–µ –∂–µ, –∫–∞–∫ –æ–ø–∏—Å–∞–Ω–æ –≤—ã—à–µ –ø–æ –∫–æ–º–∞–Ω–¥–µ /addserverqw).

üìã *–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*

- /helpadmin - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–º–æ—â—å –ø–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–º –∫–æ–º–∞–Ω–¥–∞–º
      /ha - —Å–æ–∫—Ä–∞—â—ë–Ω–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã

üí° –ò–¥–µ—è, —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –±–æ—Ç–∞: ly (@QuakeJourney).
–ö–≤–µ–π–∫ –≤–∏–¥–µ–æ: @QuakeVideos, @QuakeChampionsVideos.

üéÆ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –±–æ—Ç–æ–º –∏–≥—Ä—ã: *${config.GAMES_SUPPORT}*

–í–µ—Ä—Å–∏—è –±–æ—Ç–∞: *${config.VERSION}*
`;

    const chunks = info.match(/(.|[\n\r]){1,4096}/g);
    for (const chunk of chunks) {
      console.log('chunk.length = ' + chunk.length);
      try {
        await ctx.reply(chunk, { parse_mode: 'Markdown' });
      }
      catch (error) {
        console.log(`–û—à–∏–±–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: ${error.message}`);
      }
    }

    const chatId = ctx.chat.id;
    await updateUserSettings(userId, { chatId: chatId });

  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error) };
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

bot.command('help', async (ctx) => {
  try {
    await help(ctx);
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error) };
}
);

bot.command('h', async (ctx) => {
  try {
    await help(ctx);
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error) };
}
);

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ü—Ä–æ–≤–µ—Ä–∫–∞, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º –∏–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
async function isAdmin(userId) {
  try {
    const admins = await getAdmins(); // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
    return userId === ownerId || admins.includes(userId);
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error) };
}


/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

function isValidGames(games) {
  const allowedGames = config.GAMES.toLowerCase().split(','); // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º GAMES –≤ –Ω–∏–∂–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä
  try {
    for (const game of games) {
      if (!allowedGames.includes(game.toLowerCase())) { // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º game –≤ –Ω–∏–∂–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä
        return false;
      }
    }
    return true;
  } catch (error) {
    console.log(`–û—à–∏–±–∫–∞ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ isValidGames: `, error);
    return false;
  };
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —É–∫–∞–∑–∞–Ω–∏—è –∏–≥—Ä, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –±–æ—Ç
async function addGames(ctx, games) {

  try {
    const userId = getUserID(ctx);
    const chatId = ctx.chat.id;
    await updateUserSettings(userId, { chatId: chatId });

    const userSettings = await getUserSettings(userId);
    let existingGames;

    existingGames = userSettings && userSettings.games != undefined ? userSettings.games : [];
    //console.log('existingGames=' + existingGames.join(', '));
    if (games.length == 0 || !isValidGames(games)) {
      return ctx.reply(`–î–æ—Å—Ç—É–ø–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –∏–≥—Ä—ã: ${config.GAMES}.\n–í–∞—à–∏ –∏–≥—Ä—ã: ${existingGames.join(', ')}`);
    }

    for (let game of games) {

      game = formatName(game);

      if (!isValidPlayerName(game)) {
        return ctx.reply(`–ù–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã –º–æ–∂–µ—Ç –æ–¥–Ω–æ–π –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∏–∑ —Å–ø–∏—Å–∫–∞: ${config.GAMES}.`);
      }
      if (existingGames.some(existingGame => matchPlayer(existingGame, game))) {
        return ctx.reply(`–ò–≥—Ä–∞ ${game} —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞. –í–∞—à–∏ –∏–≥—Ä—ã: ${existingGames.join(', ')}`);
      }

      existingGames.push(game.toLowerCase());
    }

    updateUserSettings(userId, { games: existingGames });

    let timerEnabled = userSettings.timerEnabled && userSettings.timerEnabled != undefined ? 0 : userSettings.timerEnabled;
    let monitoringEnabledText = "";

    if (await checkCanTimer(userId)) {
      await updateUserSettings(userId, { timerEnabled: 1 });
      await startAutoSearch(userId);
      monitoringEnabledText = `–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤–∫–ª—é—á—ë–Ω.\n`;
    }

    ctx.reply(`–ò–≥—Ä—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã: ${existingGames.join(', ')}
${monitoringEnabledText}
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /ag –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–≥—Ä –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ /ap –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–≥—Ä–æ–∫–æ–≤ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞,
üïì /timer –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø–æ –∑–∞–¥–∞–Ω–Ω—ã–º –≤–∞–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º.
–ü—Ä–æ—Å–º–æ—Ç—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ –≤–∞—à–∏–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º: /info`);
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error) };
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —É–∫–∞–∑–∞–Ω–∏—è –∏–≥—Ä, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –±–æ—Ç
bot.command('addgame', async (ctx) => {
  try {
    games = prepareParam(ctx);
    if (games && games != undefined) {
      await addGames(ctx, games);
    }
  } catch (error) {
    console.log('–û—à–∏–±–∫–∞:', error.message);
  }
});

bot.command('ag', async (ctx) => {
  try {
    games = prepareParam(ctx);
    if (games && games != undefined) {
      await addGames(ctx, games);
    }
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error) };
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

async function checkCanTimer(userId) {
  try {
    let userSettings = await getUserSettings(userId);
    if (!userSettings) return false;
    const isGames = !(userSettings.games === undefined || userSettings.games.join("").trim() === '');
    //console.log('games: ', userSettings.games.join("").trim());
    const isPlayers = !(userSettings.players === undefined || userSettings.players.join("").trim() === '');
    const isQ2Settings = !((userSettings.q2servers === undefined || userSettings.q2servers.join("").trim() === '') && (userSettings.q2maps === undefined || userSettings.q2maps.join("").trim() === ''));
    const isQWSettings = !((userSettings.qwservers === undefined || userSettings.qwservers.join("").trim() === '') && (userSettings.qwmaps === undefined || userSettings.qwmaps.join("").trim() === ''));
    const isTimer = !(userSettings.timer === undefined || userSettings.timer == '' || userSettings.timer == 0);
    const statsMonitoringQ2 = userSettings && userSettings.sq2m != undefined ? userSettings.sq2m : 0;
    const statsMonitoringQW = userSettings && userSettings.sqwm != undefined ? userSettings.sqwm : 0;
    console.log('userId: ', userId);
    console.log('isGames: ', isGames);
    console.log('isPlayers: ', isPlayers);
    console.log('isQ2Settings: ', isQ2Settings);
    console.log('isQWSettings: ', isQWSettings);
    if ((!statsMonitoringQ2 && !statsMonitoringQW) && (!isGames || !isTimer || (isPlayers == false && isQ2Settings == false && isQWSettings == false))) return false; //–î–æ—Ä–∞–±–æ—Ç–∞—Ç—å —á—Ç–æ–±—ã —É—á–∏—Ç—ã–≤–∞–ª–∏—Å—å –∏–≥—Ä–∞ —Å–æ–≤–º–µ—Å—Ç–Ω–æ —Å —Å–µ—Ä–≤–µ—Ä–∞–º–∏/–∏–≥—Ä–æ–∫–∞–º–∏ –≤ –∏–≥—Ä–∞—Ö
    else return true;
  } catch (error) {
    console.log(`–û—à–∏–±–∫–∞: `, error);
    return false;
  }
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∏–≥—Ä
async function delGame(ctx, games) {
  try {
    const userId = getUserID(ctx);
    const chatId = ctx.chat.id;
    await updateUserSettings(userId, { chatId: chatId });
    // console.log('player=' + players.length);
    //let playerWithoutQuotes = player.replace(/"/g, '');

    let userSettings = await getUserSettings(userId);

    if (games == undefined || games.length == 0) {
      //console.log(userSettings.players);
      return ctx.reply(`–£–∫–∞–∂–∏—Ç–µ –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö –∫–æ–º–∞–Ω–¥—ã –∏–≥—Ä—É, –∫–æ—Ç–æ—Ä—É—é —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å.`);
    }

    console.log('0');
    console.log(games);
    let existingGames = userSettings.games || [];

    if (!userSettings || existingGames == undefined || existingGames.length == 0) {
      //console.log(userSettings.players);
      return ctx.reply(`–£ –≤–∞—Å –Ω–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–≥—Ä (–Ω–µ—á–µ–≥–æ —É–¥–∞–ª—è—Ç—å).`);
    }

    console.log("1");
    console.log(existingGames);
    //console.log('players='+players);

    for (let i = 0; i < games.length; i++) {
      let game = games[i];
      if (!existingGames.includes(game.toLowerCase())) {
        //console.log(userSettings.players);
        return ctx.reply(`–ò–≥—Ä–∞(—ã) ${game} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞(—ã) –≤ –≤–∞—à–∏—Ö –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.\n–í–∞—à–∏ –∏–≥—Ä—ã: ${existingGames.join(', ')}`);
      }
      existingGames = existingGames.filter(p => p.toLowerCase() !== game.toLowerCase());
    };

    console.log("2");
    console.log(existingGames);

    await updateUserSettings(userId, { games: existingGames });

    console.log("3");

    await ctx.reply(`–ò–≥—Ä–∞(—ã) —É–¥–∞–ª–µ–Ω–∞(—ã): ${games.join(', ')}`);

    if (!await checkCanTimer(userId)) {
      await updateUserSettings(userId, { timerEnabled: 0 });
      await stopAutoSearch(userId);
      await ctx.reply(`–ò–≥—Ä (/ag) –∏–ª–∏ –∏–≥—Ä–æ–∫–æ–≤ (/ap) –∏ —Å–µ—Ä–≤–µ—Ä–æ–≤ (/asq2 /asqw) –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –±–æ–ª—å—à–µ –Ω–µ—Ç, –∏–ª–∏ –≤–∞—à —Ç–∞–π–º–µ—Ä –≤—ã–∫–ª—é—á–µ–Ω (/t), –ø–æ—ç—Ç–æ–º—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Ç–∫–ª—é—á—ë–Ω.`);
    }
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∏–≥—Ä
bot.command('delgame', async (ctx) => {
  try {

    games = prepareParam(ctx);
    if (games && games != undefined) {
      await delGame(ctx, games);
    }

  } catch (error) {
    console.log('–û—à–∏–±–∫–∞:', error.message);
  }
});

bot.command('dg', async (ctx) => {
  try {

    games = prepareParam(ctx);
    if (games && games != undefined) {
      await delGame(ctx, games);
    }

  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ /users
bot.command('users', async (ctx) => {
  try {
    if (!await isAdmin(ctx.from.id)) {
      return ctx.reply('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.');
    }

    const users = await getAllUsers();
    if (users.length === 0) {
      return ctx.reply('–ù–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.');
    }

    let message = '–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:\n';

    for (const user of users) {
      try {
        const chat = await ctx.telegram.getChat(user.userId);
        const username = chat.username || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ';
        const telegramUsername = chat.first_name || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'; // –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å last_name –∏–ª–∏ –¥—Ä—É–≥–∏–µ –ø–æ–ª—è
        const isAdmin = user.isAdmin || false;
        const isOwner = user.userId === config.OWNER_ID || false;
        if (isAdmin) message += `‚ö†Ô∏è –ê–¥–º–∏–Ω –±–æ—Ç–∞. `;
        if (isOwner) message += `‚úÖ  –í–ª–∞–¥–µ–ª–µ—Ü –±–æ—Ç–∞. `;
        message += `ID: ${user.userId}, –ò–º—è: @${username}, ${telegramUsername}\n`;
        //"‚ö†Ô∏è SELL" : "‚úÖ  BUY"
      } catch (error) {
        console.log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ ${user.userId}: ${error.message}`);
        message += `ID: ${user.userId}, –ò–º—è: –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö\n`;
      }
    }

    // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ, —Ä–∞–∑–±–∏–≤–∞–µ–º –µ–≥–æ –Ω–∞ —á–∞—Å—Ç–∏
    const chunks = message.match(/(.|[\n\r]){1,4096}/g); // –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —á–∞—Å—Ç–∏ –ø–æ 4096 —Å–∏–º–≤–æ–ª–æ–≤
    for (const chunk of chunks) {
      await ctx.reply(chunk);
    }
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ /user <>
bot.command('user', async (ctx) => {
  try {
    if (!await isAdmin(ctx.from.id)) {
      return ctx.reply('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.');
    }

    const userId = ctx.message.text.split(' ')[1];
    //  const userSettings = await getUserSettings(userId);
    const userSettings = await getUserSettings(userId);

    if (!userSettings) {
      return ctx.reply(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID ${userId} –Ω–µ –Ω–∞–π–¥–µ–Ω.`);
    }

    try {
      const chat = await ctx.telegram.getChat(userId);
      const username = chat.username || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ';
      const telegramUsername = chat.first_name || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'; // –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å last_name –∏–ª–∏ –¥—Ä—É–≥–∏–µ –ø–æ–ª—è
      const isAdmin = userSettings.isAdmin || "–Ω–µ—Ç";
      const players = userSettings.players || [];
      const timer = userSettings.timer !== undefined ? userSettings.timer : '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
      const sleepTime = userSettings.sleepTime !== undefined ? userSettings.sleepTime : '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
      let message = `
	–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:\n 
	ID: ${userId}, –ò–º—è: @${username}, ${telegramUsername}, Admin: ${isAdmin}\n
	–ò–≥—Ä–æ–∫–∏: ${players.length > 0 ? players.join(', ') : '–Ω–µ—Ç'}
	–¢–∞–π–º–µ—Ä: ${timer}
	–í—Ä–µ–º—è —Å–Ω–∞: ${sleepTime}
	`;
      message += '\n–í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:\n' + await getUserSettingsString(userId);
      // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ, —Ä–∞–∑–±–∏–≤–∞–µ–º –µ–≥–æ –Ω–∞ —á–∞—Å—Ç–∏
      const chunks = message.match(/(.|[\n\r]){1,4096}/g);
      for (const chunk of chunks) {
        await ctx.reply(chunk);
      }
    } catch (error) {
      console.log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ ${userId}: ${error.message}`);
      const message = `ID: ${userId}: –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö\n`;
      await ctx.reply(message);
    }
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

bot.command('deluser', async (ctx) => {
  try {
    const isOwner = ctx.from.id === config.OWNER_ID || false;
    console.log('ctx.from.userId = ' + ctx.from.userId + ', OWNER_ID = ' + config.OWNER_ID);
    if (!isOwner) {
      return ctx.reply('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.');
    }

    const userId = ctx.message.text.split(' ')[1];
    //  const userSettings = await getUserSettings(userId);
    const userSettings = await getUserSettings(userId);

    if (!userSettings) {
      return ctx.reply(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID ${userId} –Ω–µ –Ω–∞–π–¥–µ–Ω.`);
    }

    try {
      const message = `ID: ${userId}: —É–¥–∞–ª—ë–Ω\n`;
      await deleteUser(userId);
      await ctx.reply(message);
    } catch (error) {
      console.log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ ${userId}: ${error.message}`);
      const message = `ID: ${userId}: –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö\n`;
      await ctx.reply(message);
    }
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: ${error.message}`) };
});

bot.command('delallusers', async (ctx) => {
  try {
    const isOwner = ctx.from.id === config.OWNER_ID || false;
    if (!isOwner) {
      return ctx.reply('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.');
    }

    const userId = ctx.message.text.split(' ')[1];
    //  const userSettings = await getUserSettings(userId);

    try {
      const message = `–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —É–¥–∞–ª–µ–Ω—ã.\n`;
      await deleteAllUsers();
      await ctx.reply(message);
    } catch (error) {
      console.log(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${error.message}`);
      const message = `–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.\n`;
      await ctx.reply(message);
    }
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ /ban <userID>
bot.command('ban', async (ctx) => {
  try {
    if (!await isAdmin(ctx.from.id)) {
      return ctx.reply('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.');
    }

    const userId = ctx.message.text.split(' ')[1];
    await banUser(userId); // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ db.js
    ctx.reply(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID ${userId} –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.`);
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: ${error.message}`) };
});

// –ö–æ–º–∞–Ω–¥–∞ /unban <userID>
bot.command('unban', async (ctx) => {
  try {
    if (!await isAdmin(ctx.from.id)) {
      return ctx.reply('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.');
    }

    const userId = ctx.message.text.split(' ')[1];
    await unbanUser(userId); // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ db.js
    ctx.reply(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID ${userId} —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.`);
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ /banlist
bot.command('banlist', async (ctx) => {
  try {
    if (!await isAdmin(ctx.from.id)) {
      return ctx.reply('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.');
    }

    const bannedUsers = await getBannedUsers(); // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ db.js
    if (bannedUsers.length === 0) {
      return ctx.reply('–ù–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.');
    }

    let message = '–°–ø–∏—Å–æ–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:\n';
    //bannedUsers.forEach(user => {

    for (const user of bannedUsers) {
      try {
        const chat = await ctx.telegram.getChat(user.userId);
        const username = chat.username || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ';
        const telegramUsername = chat.first_name || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'; // –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å last_name –∏–ª–∏ –¥—Ä—É–≥–∏–µ –ø–æ–ª—è

        message += `ID: ${user.userId}, –ò–º—è: @${username}, ${telegramUsername}\n`;
      } catch (error) {
        console.log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ ${user.userId}: ${error.message}`);
        message += `ID: ${user.userId}, –ò–º—è: –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö\n`;
      }
      //message += `ID: ${user.userId}, –ò–º—è: ${user.username || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}, @: ${user.telegramUsername || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}\n`;
    };

    const chunks = message.match(/(.|[\n\r]){1,4096}/g);
    for (const chunk of chunks) {
      await ctx.reply(chunk);
    }
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ /addadm –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram>
bot.command('addadm', async (ctx) => {
  try {
    if (!await isAdmin(ctx.from.id)) {
      return ctx.reply('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.');
    }
    const userId = ctx.message.text.split(' ')[1];
    //  const userSettings = await getUserSettings(userId);
    const userSettings = await getUserSettings(userId);

    if (!userSettings) {
      return ctx.reply(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID ${userId} –Ω–µ –Ω–∞–π–¥–µ–Ω.`);
    }

    if (await addAdmin(userId)) {
      ctx.reply(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã.`);
    } else {
      ctx.reply(`–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å ID ${userId} –≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã`);
    }
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: ${error.message}`) };
});

// –ö–æ–º–∞–Ω–¥–∞ /deladm <userID>
bot.command('deladm', async (ctx) => {
  try {
    if (!await isAdmin(ctx.from.id)) {
      return ctx.reply('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.');
    }

    const userId = ctx.message.text.split(' ')[1];
    await removeAdmin(userId); // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ db.js
    ctx.reply(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID ${userId} —É–¥–∞–ª–µ–Ω –∏–∑ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤.`);
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ /admlist
bot.command('admlist', async (ctx) => {
  try {
    if (!await isAdmin(ctx.from.id)) {
      return ctx.reply('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.');
    }

    const admins = await getAdmins(); // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ db.js
    if (admins.length === 0) {
      return ctx.reply('–ù–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤.');
    }

    let message = '–°–ø–∏—Å–æ–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤:\n';
    admins.forEach(admin => {
      message += `ID: ${admin.userId}, –ò–º—è: ${admin.username || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}, @: ${admin.telegramUsername || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}\n`;
    });

    const chunks = message.match(/(.|[\n\r]){1,4096}/g);
    for (const chunk of chunks) {
      await ctx.reply(chunk);
    }
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
});

// –ö–æ–º–∞–Ω–¥–∞ /delalladm
bot.command('delalladm', async (ctx) => {
  try {
    if (ctx.from.id !== ownerId) {
      return ctx.reply('–¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç—É –∫–æ–º–∞–Ω–¥—É.');
    }

    await removeAllAdmins(); // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ db.js
    ctx.reply('–í—Å–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã.');
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

function prepareParam(ctx) {
  try {
    let data = [];
    let current = "";
    let inQuotes = false; // –§–ª–∞–≥, –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—â–∏–π –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–µ –≤ –∫–∞–≤—ã—á–∫–∞—Ö
    let inStar = false;

    const parts = ctx.message.text.split(/(\s+)/).slice(1); // –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø—Ä–æ–±–µ–ª—ã

    for (let i = 0; i < parts.length; i++) {
      const part = parts[i];

      if (part.startsWith('"') && part.endsWith('"')) {
        // –¢–µ–∫—Å—Ç –≤ –∫–∞–≤—ã—á–∫–∞—Ö
        data.push(part);
      } else if (part.startsWith('"')) {
        // –ù–∞—á–∞–ª–æ —Ç–µ–∫—Å—Ç–∞ –≤ –∫–∞–≤—ã—á–∫–∞—Ö
        current += part; // –Ω–µ —É–¥–∞–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é –∫–∞–≤—ã—á–∫—É
        inQuotes = true;
      } else if (part.endsWith('"')) {
        // –ö–æ–Ω–µ—Ü —Ç–µ–∫—Å—Ç–∞ –≤ –∫–∞–≤—ã—á–∫–∞—Ö
        current += part; // –Ω–µ —É–¥–∞–ª—è–µ–º –∫–æ–Ω–µ—á–Ω—É—é –∫–∞–≤—ã—á–∫—É
        data.push(current);
        current = "";
        inQuotes = false;
      } else if (inQuotes) {
        // –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –≤ –∫–∞–≤—ã—á–∫–∞—Ö
        current += part; // –¥–æ–±–∞–≤–ª—è–µ–º –±–µ–∑ –ø—Ä–æ–±–µ–ª–∞
      } else if (part.startsWith('*') && part.endsWith('*')) {
        // –¢–µ–∫—Å—Ç –≤ –∑–≤–µ–∑–¥–æ—á–∫–∞—Ö
        data.push(part);
      } else if (part.startsWith('*')) {
        // –ù–∞—á–∞–ª–æ —Ç–µ–∫—Å—Ç–∞ –≤ –∑–≤–µ–∑–¥–æ—á–∫–∞—Ö
        current += part; // –Ω–µ —É–¥–∞–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é –∑–≤–µ–∑–¥–æ—á–∫—É
        inStar = true;
      } else if (inStar && !part.endsWith('*')) {
        // –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –≤ –∑–≤–µ–∑–¥–æ—á–∫–∞—Ö
        current += part;
      } else if (inStar && part.endsWith('*')) {
        // –ö–æ–Ω–µ—Ü —Ç–µ–∫—Å—Ç–∞ –≤ –∑–≤–µ–∑–¥–æ—á–∫–∞—Ö
        current += part;
        data.push(current);
        current = "";
        inStar = false;
      } else if (part.endsWith('*')) {
        // –¢–µ–∫—Å—Ç –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –∑–≤–µ–∑–¥–æ—á–∫–æ–π
        current += part;
        data.push(current);
        current = "";
        inStar = false;
      } else {
        // –û–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ
        data.push(part);
      }
    }
    // –ï—Å–ª–∏ –æ—Å—Ç–∞–ª–∏—Å—å –Ω–µ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ, –¥–æ–±–∞–≤–ª—è–µ–º –∏—Ö
    if (current) {
      data.push(current);
    }

    data = data.filter(item => item.trim() !== '');
    data = data.filter((item, index, self) => {
      const lowercaseItem = item.toLowerCase();
      return index === self.findIndex(otherItem => otherItem.toLowerCase() === lowercaseItem);
    });


    console.log("prepareParam=" + data.join(", "));
    return data;



  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
}


/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –≤—Ö–æ–¥–∏—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –≥—Ä—É–ø–ø—ã
async function checkUserInGroups(userId, groupUsernames) {
  try {
    const results = {};
    for (const username of groupUsernames) {
      try {
        // –£–±–∏—Ä–∞–µ–º "@" –∏–∑ –∏–º–µ–Ω–∏ –≥—Ä—É–ø–ø—ã
        const chat = await bot.getChat(username.replace('@', ''));
        const member = await bot.getChatMember(chat.id, userId);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≥—Ä—É–ø–ø–µ
        results[username] = member.status === 'member' || member.status === 'administrator' || member.status === 'creator';
      } catch (error) {
        console.log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –≥—Ä—É–ø–ø—ã ${username}:`, error.message);
        results[username] = false; // –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –æ—à–∏–±–∫–∞, —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤ –≥—Ä—É–ø–ø–µ
      }
    }

    return results;
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

bot.command('check', async (ctx) => {
  try {
    const userId = ctx.from.id;
    userContexts[userId] = ctx; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const groupUsernames = ['@QuakeJourney', '@Quake2Workshop']; // –ú–∞—Å—Å–∏–≤ @-–∏–º–µ–Ω –≥—Ä—É–ø–ø
    checkUserInGroups(userId, groupUsernames)
      .then(results => {
        console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏:', results);
        ctx.reply('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏:' + results);
      })
      .catch(err => {
        console.log('–û—à–∏–±–∫–∞:', err);
      });
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–≥—Ä–æ–∫–æ–≤
async function addPlayers(ctx, players, type) {

  try {
    const userId = getUserID(ctx);
    const chatId = ctx.chat.id;
    await updateUserSettings(userId, { chatId: chatId });

    const userSettings = await getUserSettings(userId);
    let existingPlayers;

    let prevTimerEnabled = userSettings.timerEnabled;
    prevTimerEnabled = (!prevTimerEnabled || prevTimerEnabled == undefined || prevTimerEnabled == '' || prevTimerEnabled == 0) ? 0 : prevTimerEnabled;

    if (type == 'players') {
      existingPlayers = userSettings && userSettings.players != undefined ? userSettings.players : [];
      if (players.length == 0 || players.length > config.PLAYERS_COUNT_LIMIT) {
        return ctx.reply(`–í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç 1 –¥–æ ${config.PLAYERS_COUNT_LIMIT - existingPlayers.length} –∏–≥—Ä–æ–∫–æ–≤.\n–í–∞—à–∏ –∏–≥—Ä–æ–∫–∏: ${existingPlayers.join(', ')}`);
      }
      if (existingPlayers.length >= config.PLAYERS_COUNT_LIMIT) {
        return ctx.reply('–î–æ—Å—Ç–∏–≥–Ω—É—Ç–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤. –£–¥–∞–ª–∏—Ç–µ –∫–æ–≥–æ-—Ç–æ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º (/delplayer –∏–ª–∏ /dp).');
      }
    }
    else if (type == 'playersfilter') {
      existingPlayers = userSettings && userSettings.playersFilter != undefined ? userSettings.playersFilter : [];
      if (players.length == 0 || players.length > config.PLAYERS_COUNT_LIMIT) {
        return ctx.reply(`–í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç 1 –¥–æ ${config.PLAYERS_COUNT_LIMIT - existingPlayers.length} –∏–≥—Ä–æ–∫–æ–≤ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞.\n–í–∞—à —Ç–µ–∫—É—â–∏–π —Ñ–∏–ª—å—Ç—Ä: ${existingPlayers.join(', ')}`);
      }
      if (existingPlayers.length >= config.PLAYERS_COUNT_LIMIT) {
        return ctx.reply('–î–æ—Å—Ç–∏–≥–Ω—É—Ç–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤. –£–¥–∞–ª–∏—Ç–µ –∫–æ–≥–æ-—Ç–æ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º (/delplayerfilter –ª–∏ /dpf).');
      }
    }
    else if (type == 'spfilter') {
      existingPlayers = userSettings && userSettings.spFilter != undefined ? userSettings.spFilter : [];
      if (players.length < 2 || players.length > config.PLAYERS_COUNT_LIMIT - 1) {
        return ctx.reply(`–í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç 1 –¥–æ ${config.PLAYERS_COUNT_LIMIT - existingPlayers.length} –∑–∞–ø–∏—Å–µ–π —Ñ–∏–ª—å—Ç—Ä–∞ —Å–µ—Ä–≤–µ—Ä-–∏–≥—Ä–æ–∫.\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /aspf <server:ip\\player>,\n–Ω–∞–ø—Ä–∏–º–µ—Ä /aspf q2.playground.ru:27910 pp\n–í–∞—à —Ç–µ–∫—É—â–∏–π —Ñ–∏–ª—å—Ç—Ä: ${existingPlayers.join(', ')}`);
      }
      if (existingPlayers.length >= config.PLAYERS_COUNT_LIMIT) {
        return ctx.reply('–î–æ—Å—Ç–∏–≥–Ω—É—Ç–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä —Ñ–∏–ª—å—Ç—Ä–∞ —Å–µ—Ä–≤–µ—Ä-–∏–≥—Ä–æ–∫. –£–¥–∞–ª–∏—Ç–µ —á—Ç–æ –Ω–∏–±—É–¥—å –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º (/dspf).');
      }
    }

    //console.log('type=' + type);
    //console.log(players);
    //console.log(players.length);
    //console.log(players[0]);
    //const existingPlayers = userSettings.players || [];
    let result;

    if (type == 'players' || type == 'playersfilter') {

      for (let player of players) {
        player = formatName(player);

        if (!isValidPlayerName(player)) {
          return ctx.reply(`üïµÔ∏è –ò–º—è –∏–≥—Ä–æ–∫–∞ –¥–æ–ª–∂–Ω–æ —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ –º–∏–Ω–∏–º—É–º ${config.PLAYERS_NICK_NAME_LIMIT} —Å–∏–º–≤–æ–ª–∞(–æ–≤). –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–∞—Å–∫–∞, —Ç–æ –º–∏–Ω–∏–º—É–º ${config.PLAYERS_NICK_NAME_LIMIT} —Å–∏–º–≤–æ–ª–∞(–æ–≤) + –æ–¥–Ω–∞ –∏–ª–∏ –¥–≤–µ –∑–≤–µ–∑–¥–æ—á–∫–∏.`);
        }

        if (existingPlayers.some(existingPlayer => matchPlayer(existingPlayer, player))) {
          return ctx.reply(`üïµÔ∏è –ò–≥—Ä–æ–∫ ${player} —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω. –í–∞—à–∏ –∏–≥—Ä–æ–∫–∏: ${existingPlayers.join(', ')}`);
        }
        existingPlayers.push(player.toLowerCase());
      }
      result = `${type == 'players' ? '–ò–≥—Ä–æ–∫–∏' : 'üïµÔ∏è –ò–≥—Ä–æ–∫–∏ –≤ —Ñ–∏–ª—å—Ç—Ä'} –¥–æ–±–∞–≤–ª–µ–Ω—ã: ${players.join(',')}\n–¢–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫: ${existingPlayers.join(', ')}
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /ag –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–≥—Ä –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ üïì /timer –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø–æ –∑–∞–¥–∞–Ω–Ω—ã–º –≤–∞–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º.
–ü—Ä–æ—Å–º–æ—Ç—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ –≤–∞—à–∏–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º: /info`;
    }
    else if (type == 'spfilter') {
      let server = players[0];
      let player = formatName(players[1]);
      //console.log('server=' + server + ', player=' + player);
      if (!isValidServer(server)) return ctx.reply(`üñ•Ô∏è–ê–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞ –¥–æ–ª–∂–Ω–µ–Ω –±—ã—Ç—å —É–∫–∞–∑–∞–Ω –≤ –≤–∏–¥–µ IPAddress:Port –∏–ª–∏ Domen:Port, –Ω–∞–ø—Ä–∏–º–µ—Ä, 212.42.38.88:27910 –∏–ª–∏ q2.playground.ru:27910\n–í—ã –ø—ã—Ç–∞–ª–∏—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä: '${server}'\n–£–∫–∞–∂–∏—Ç–µ –≤–µ—Ä–Ω–æ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–º–∞–Ω–¥—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä: /aspf 212.42.38.88:27910 pp`);
      if (!isValidPlayerName(player)) return ctx.reply(`üïµÔ∏è –ò–º—è –∏–≥—Ä–æ–∫–∞ –¥–æ–ª–∂–Ω–æ —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ –º–∏–Ω–∏–º—É–º ${config.PLAYERS_NICK_NAME_LIMIT} —Å–∏–º–≤–æ–ª–∞(–æ–≤). –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–∞—Å–∫–∞, —Ç–æ –º–∏–Ω–∏–º—É–º ${config.PLAYERS_NICK_NAME_LIMIT} —Å–∏–º–≤–æ–ª–∞(–æ–≤) + –æ–¥–Ω–∞ –∏–ª–∏ –¥–≤–µ –∑–≤–µ–∑–¥–æ—á–∫–∏.\n–£–∫–∞–∂–∏—Ç–µ –≤–µ—Ä–Ω–æ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–º–∞–Ω–¥—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä: /aspf q2.playground.ru pp`);

      for (i = 0; i < existingPlayers.length; i++) {
        let existingServer = existingPlayers[i].split(`\\`)[0];
        let existingPlayer = existingPlayers[i].split(`\\`)[1];
        if (matchServer(existingServer, server) && matchPlayer(existingPlayer, player)) return ctx.reply(`–¢–∞–∫–∞—è –ø–∞—Ä–∞ —Å–µ—Ä–≤–µ—Ä-–∏–≥—Ä–æ–∫ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞. –í–∞—à —Ñ–∏–ª—å—Ç—Ä: ${existingPlayers.join(', ').replace('\\', ' ')}`);
      }
      let sp = server + `\\` + player;
      existingPlayers.push(sp);
      result = `üñ•Ô∏èüïµÔ∏è –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–≤–∞—è –ø–∞—Ä–∞ —Å–µ—Ä–≤–µ—Ä-–∏–≥—Ä–æ–∫: ${server} ${player} 
–î–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –∫–æ–º–∞–Ω–¥–æ–π:
/dspf ${server} ${player}
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /ag –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–≥—Ä –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ üïì /timer –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø–æ –∑–∞–¥–∞–Ω–Ω—ã–º –≤–∞–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º.
–ü—Ä–æ—Å–º–æ—Ç—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ –≤–∞—à–∏–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º: /info`;
    }

    if (type == 'players') await updateUserSettings(userId, { players: existingPlayers });
    else if (type == 'playersfilter') await updateUserSettings(userId, { playersFilter: existingPlayers });
    else if (type == 'spfilter') await updateUserSettings(userId, { spFilter: existingPlayers });

    await ctx.reply(result);

    if (!await checkCanTimer(userId)) {
      await updateUserSettings(userId, { timerEnabled: 0 });
      await stopAutoSearch(userId);
      await ctx.reply(`üëÅÔ∏è –ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Å—Ç–∞—Ä—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∞, –ø–æ—ç—Ç–æ–º—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Ç–∫–ª—é—á—ë–Ω.\n–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∫–ª—é—á–µ–Ω –≤ —Å–ª—É—á–∞–µ –µ—Å–ª–∏ –≤—ã –¥–æ–±–∞–≤–∏—Ç–µ —Ç—Ä–µ–±—É–µ–º—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –≤–∫–ª—é—á–∏—Ç–µ —Ç–∞–π–º–µ—Ä.\n/help –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.`);
    }
    else if (await checkCanTimer(userId) && userSettings.timer && userSettings.timer != undefined && userSettings.timer != '' && userSettings.timer >= 30) {
      //timerEnabled = userSettings.timerEnabled;

      await stopAutoSearch(userId); //–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
      await updateUserSettings(userId, { timerEnabled: 1 });
      await startAutoSearch(userId, userSettings.timer);
      if (prevTimerEnabled == 0) {
        await ctx.reply(`üëÅÔ∏è –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤–∫–ª—é—á—ë–Ω.\n–¢–µ–∫—É—â–∏–π —Ç–∞–π–º–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ${userSettings.timer}\n–ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫–ª—é—á–∏—Ç—å –º–æ–∏–Ω—Ç–æ—Ä–∏–Ω–≥, –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –∫–æ–º–∞–Ω–¥–æ–π üïì /timer 0`);
      }
    }

  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–≥—Ä–æ–∫–æ–≤
bot.command('addplayer', async (ctx) => {
  try {
    players = prepareParam(ctx);
    if (players && players != undefined) {
      await addPlayers(ctx, players, 'players');
    }
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
});

bot.command('ap', async (ctx) => {
  try {
    players = prepareParam(ctx);
    if (players && players != undefined) {
      await addPlayers(ctx, players, 'players');
    }
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞ –∏–≥—Ä–æ–∫–æ–≤
bot.command('addplayerfilter', async (ctx) => {
  try {

    players = prepareParam(ctx);
    if (players && players != undefined) {
      //console.log(players);
      //console.log(players[0]);
      await addPlayers(ctx, players, 'playersfilter');
    }

  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
});

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞ –∏–≥—Ä–æ–∫–æ–≤
bot.command('apf', async (ctx) => {
  try {

    players = prepareParam(ctx);
    if (players && players != undefined) {
      //console.log(players);
      //console.log(players[0]);
      await addPlayers(ctx, players, 'playersfilter');
    }

  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞ –ø–∞—Ä—ã —Å–µ—Ä–≤–µ—Ä + –∏–≥—Ä–æ–∫
bot.command('aspf', async (ctx) => {
  try {

    let sp = prepareParam(ctx);
    if (sp && sp != undefined) {
      //console.log(players);
      //console.log(players[0]);
      await addPlayers(ctx, sp, 'spfilter');
    }

  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–∞—Å—Å–∏–≤–∞ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ server - player
function formatServers(arr) {
  //console.log('formatServers');
  if (arr == undefined || arr.length == 0) return '';
  const result = arr.map(item => {
    return item.replace(/\\/g, ' '); // –ó–∞–º–µ–Ω—è–µ–º –æ–±—Ä–∞—Ç–Ω—ã–µ —Å–ª—ç—à–∏ –Ω–∞ –ø—Ä–æ–±–µ–ª—ã
  }).join(', '); // –û–±—ä–µ–¥–∏–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å –∑–∞–ø—è—Ç–æ–π –∏ –ø—Ä–æ–±–µ–ª–æ–º
  return result;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–∞—Å—Å–∏–≤–∞ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ server - player
function formatServerString(server) {
  //console.log('formatServer');
  if (!server || server == undefined || server.trim() == '') return '';
  const result = server.replace(/\\/g, ' '); // –ó–∞–º–µ–Ω—è–µ–º –æ–±—Ä–∞—Ç–Ω—ã–µ —Å–ª—ç—à–∏ –Ω–∞ –ø—Ä–æ–±–µ–ª—ã
  return result;
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∏–≥—Ä–æ–∫–æ–≤
async function delPlayers(ctx, players, type) {
  try {
    const userId = getUserID(ctx);
    const chatId = ctx.chat.id;
    await updateUserSettings(userId, { chatId: chatId });
    // console.log('player=' + players.length);
    //let playerWithoutQuotes = player.replace(/"/g, '');

    let userSettings = await getUserSettings(userId);

    console.log('delPlayer - ' + type);
    console.log(players);

    let existingPlayers;

    if (type == 'players') {

      if (players == undefined || players.length == 0) {
        //console.log(userSettings.players);
        return ctx.reply(`–£–∫–∞–∂–∏—Ç–µ –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö –∫–æ–º–∞–Ω–¥—ã –∏–≥—Ä–æ–∫–∞(–æ–≤), –∫–æ—Ç–æ—Ä–æ–≥–æ(—ã—Ö) —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å.\n–ù–∞–ø—Ä–∏–º–µ—Ä: /dp David`);
      }

      existingPlayers = userSettings.players || [];
      if (!userSettings || existingPlayers == undefined || existingPlayers.length == 0) {
        //console.log(userSettings.players);
        return ctx.reply(`–£ –≤–∞—Å –Ω–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–≥—Ä–æ–∫–æ–≤ (–Ω–µ—á–µ–≥–æ —É–¥–∞–ª—è—Ç—å).`);
      }
      for (let i = 0; i < players.length; i++) {
        let player = players[i];
        console.log('player=' + player);
        if (!existingPlayers.includes(player.toLowerCase())) {
          //console.log(userSettings.players);
          return ctx.reply(`–ò–≥—Ä–æ–∫ ${player} –Ω–µ –Ω–∞–π–¥–µ–Ω(—ã) –≤ –≤–∞—à–∏—Ö –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.\n–í–∞—à–∏ –∏–≥—Ä–æ–∫–∏: ${existingPlayers.join(', ')}`);
        }
        existingPlayers = existingPlayers.filter(p => p.toLowerCase() !== player.toLowerCase());
      };
      await updateUserSettings(userId, { players: existingPlayers });
      ctx.reply('üïµÔ∏è –ò–≥—Ä–æ–∫–∏ —É–¥–∞–ª–µ–Ω—ã: ' + players.join(','));
    }
    else if (type == 'playersfilter') {

      if (players == undefined || players.length == 0) {
        //console.log(userSettings.players);
        return ctx.reply(`–£–∫–∞–∂–∏—Ç–µ –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö –∫–æ–º–∞–Ω–¥—ã –∏–≥—Ä–æ–∫–∞(–æ–≤), –∫–æ—Ç–æ—Ä–æ–≥–æ(—ã—Ö) —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∏–∑ —Ñ–∏–ª—å—Ç—Ä–∞.\n–ù–∞–ø—Ä–∏–º–µ—Ä: /dpf David`);
      }

      existingPlayers = userSettings.playersFilter || [];
      if (!userSettings || existingPlayers == undefined || existingPlayers.length == 0) {
        //console.log(userSettings.players);
        return ctx.reply(`–£ –≤–∞—Å –Ω–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏–≥—Ä–æ–∫–æ–≤ (–Ω–µ—á–µ–≥–æ —É–¥–∞–ª—è—Ç—å).`);
      }
      for (let i = 0; i < players.length; i++) {
        let player = players[i];
        console.log('player=' + player);
        if (!existingPlayers.includes(player.toLowerCase())) {
          //console.log(userSettings.players);
          return ctx.reply(`–ò–≥—Ä–æ–∫ ${player} –Ω–µ –Ω–∞–π–¥–µ–Ω(—ã) –≤ –≤–∞—à–∏—Ö –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Ñ–∏–ª—å—Ç—Ä–∞ –∏–≥—Ä–æ–∫–æ–≤.\n–í–∞—à–∏ –∏–≥—Ä–æ–∫–∏ –≤ —Ñ–∏–ª—å—Ç—Ä–µ: ${existingPlayers.join(', ')}`);
        }
        existingPlayers = existingPlayers.filter(p => p.toLowerCase() !== player.toLowerCase());
      };
      await updateUserSettings(userId, { playersFilter: existingPlayers });
      ctx.reply('üïµÔ∏è –ò–≥—Ä–æ–∫–∏ —É–¥–∞–ª–µ–Ω—ã –∏–∑ —Ñ–∏–ª—å—Ç—Ä–∞: ' + players.join(','));
    }
    else if (type == 'spfilter') {

      if (players == undefined || players.length == 0) {
        //console.log(userSettings.players);
        return ctx.reply(`–£–∫–∞–∂–∏—Ç–µ –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö –∫–æ–º–∞–Ω–¥—ã –ø–∞—Ä—É —Å–µ—Ä–≤–µ—Ä - –∏–≥—Ä–æ–∫, –∫–æ—Ç–æ—Ä—ã–µ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å.\n–ù–∞–ø—Ä–∏–º–µ—Ä: /dspf q2.playground.ru:27910 David`);
      }

      //existingPlayers = userSettings.spFilter || [];
      existingPlayers = userSettings && userSettings.spFilter != undefined ? userSettings.spFilter : [];

      if (!userSettings || existingPlayers == undefined || existingPlayers.length == 0) {
        //console.log(userSettings.players);
        return ctx.reply(`–£ –≤–∞—Å –Ω–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ñ–∏–ª—å—Ç—Ä–æ–≤ —Å–µ—Ä–≤–µ—Ä - –∏–≥—Ä–æ–∫ (–Ω–µ—á–µ–≥–æ —É–¥–∞–ª—è—Ç—å).`);
      }

      let server = players[0];
      let player = formatName(players[1]);
      let sp = server + `\\` + player;
      if (!existingPlayers.map(player => player.toLowerCase()).includes(sp.toLowerCase())) {
        ;
        //      if (!existingPlayers.includes(sp.toLowerCase())) {
        //console.log(userSettings.players);
        return ctx.reply(`–ó–Ω–∞—á–µ–Ω–∏–µ ${server} ${player} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –≤–∞—à–∏—Ö –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Ñ–∏–ª—å—Ç—Ä–∞ —Å–µ—Ä–≤–µ—Ä -–∏–≥—Ä–æ–∫.\n–í–∞—à–∏ —Ç–µ–∫—É—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞: ${formatServers(existingPlayers)}`);
      }
      existingPlayers = existingPlayers.filter(p => p.toLowerCase() !== sp.toLowerCase());
      await updateUserSettings(userId, { spFilter: existingPlayers });
      ctx.reply('üñ•Ô∏èüïµÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞ —É–¥–∞–ª–µ–Ω—ã: ' + server + ' ' + player);
    }


    if (!await checkCanTimer(userId)) {
      await updateUserSettings(userId, { timerEnabled: 0 });
      await stopAutoSearch(userId);
      ctx.reply(`üëÅÔ∏è –ò–≥—Ä–æ–∫–æ–≤ –∏ —Å–µ—Ä–≤–µ—Ä–æ–≤ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –±–æ–ª—å—à–µ –Ω–µ—Ç, –ø–æ—ç—Ç–æ–º—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Ç–∫–ª—é—á—ë–Ω.`);
    }

  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∏–≥—Ä–æ–∫–æ–≤
bot.command('delplayer', async (ctx) => {
  try {

    players = prepareParam(ctx);
    if (players && players != undefined) {
      await delPlayers(ctx, players, 'players');
    }

  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
});

bot.command('dp', async (ctx) => {
  try {

    players = prepareParam(ctx);
    if (players && players != undefined) {
      await delPlayers(ctx, players, 'players');
    }

  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∏–≥—Ä–æ–∫–æ–≤
bot.command('delplayerfilter', async (ctx) => {
  try {

    players = prepareParam(ctx);
    if (players && players != undefined) {
      await delPlayers(ctx, players, 'playersfilter');
    }

  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
});

bot.command('dpf', async (ctx) => {
  try {

    players = prepareParam(ctx);
    if (players && players != undefined) {
      await delPlayers(ctx, players, 'playersfilter');
    }

  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

bot.command('dspf', async (ctx) => {
  try {

    sp = prepareParam(ctx);
    if (sp && sp != undefined) {
      await delPlayers(ctx, sp, 'spfilter');
    }

  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

function isValidServer(serverString) {
  try {
    console.log('isValidServer - input = ' + serverString);
    if (!serverString) return false;
    if (serverString == undefined) return false;
    if (serverString.trim() == '') return false;

    // –†–∞–∑–¥–µ–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –Ω–∞ IP/–¥–æ–º–µ–Ω –∏ –ø–æ—Ä—Ç
    const [address, port] = serverString.split(':');

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä—Ç - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º
    if (isNaN(parseInt(port, 10))) {
      return false;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º IP - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º –∏–ª–∏ –¥–æ–º–µ–Ω–æ–º
    if (address.match(/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/)) {
      return true; // –≠—Ç–æ IP-–∞–¥—Ä–µ—Å
    } else if (address.match(/^(?:[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?\.)+[a-z0-9][a-z0-9-]{0,61}[a-z0-9]$/i)) {
      return true; // –≠—Ç–æ –¥–æ–º–µ–Ω
    } else {
      return false;
    }
  } catch (error) {
    console.log(`–û—à–∏–±–∫–∞: `, error);
    return false;
  }
}


function isValidServerOld(server) {
  //console.log('isValidServer, server=' + server);
  const regex = /^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5]):([1-9][0-9]{0,3}|[1-5][0-9]{4}|6[0-4][0-9]{3}|65[0-4][0-9]{2}|655[0-2][0-9]|6553[0-5])$|^(?:[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*):([1-9][0-9]{0,3}|[1-5][0-9]{4}|6[0-4][0-9]{3}|65[0-4][0-9]{2}|655[0-2][0-9]|6553[0-5])$/;
  return regex.test(server);
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è Q2 —Å–µ—Ä–≤–µ—Ä–æ–≤
async function addServers(ctx, servers, game) {

  try {
    const userId = getUserID(ctx);
    const chatId = ctx.chat.id;
    await updateUserSettings(userId, { chatId: chatId });
    if (typeof game === 'undefined') {
      game = config.DEFAULT_GAME;
    }
    //console.log('addserverq2s');
    //console.log(servers);

    const userSettings = await getUserSettings(userId);
    let existingServers;

    let prevTimerEnabled = userSettings.timerEnabled;
    prevTimerEnabled = (!prevTimerEnabled || prevTimerEnabled == undefined || prevTimerEnabled == '' || prevTimerEnabled == 0) ? 0 : prevTimerEnabled;

    if (game == 'q2') existingServers = userSettings && userSettings.q2servers != undefined ? userSettings.q2servers : [];
    else if (game == 'qw') existingServers = userSettings && userSettings.qwservers != undefined ? userSettings.qwservers : [];

    if (servers.length == 0 || ((servers.length + existingServers.length) > config.SERVERS_COUNT_LIMIT)) {
      return await ctx.reply(`–í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç 1 –¥–æ ${config.SERVERS_COUNT_LIMIT - existingServers.length} —Å–µ—Ä–≤–µ—Ä–æ–≤.\n–í–∞—à–∏ —Å–µ—Ä–≤–µ—Ä–∞: ${existingServers.join(', ')}`);
    }

    /*    if (servers.length === 0 || servers.length > config.SERVERS_COUNT_LIMIT) {
          return ctx.reply(`–í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç 1 –¥–æ ${config.SERVERS_COUNT_LIMIT} —Å–µ—Ä–≤–µ—Ä–æ–≤.`);
        }
    */
    for (const server of servers) {
      if (!isValidServer(server)) {
        return await ctx.reply(`–ê–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞ –¥–æ–ª–∂–Ω–µ–Ω –±—ã—Ç—å —É–∫–∞–∑–∞–Ω –≤ –≤–∏–¥–µ IPAddress:Port –∏–ª–∏ Domen:Port, –Ω–∞–ø—Ä–∏–º–µ—Ä, 212.42.38.88:27910 –∏–ª–∏ q2.playground.ru:27910\n–í—ã –ø—ã—Ç–∞–ª–∏—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä: '${server}'`);
      }
      if (existingServers.some(existingServer => matchServer(existingServer, server))) {
        return await ctx.reply(`–°–µ—Ä–≤–µ—Ä ${server} —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω. –í–∞—à–∏ —Å–µ—Ä–≤–µ—Ä–∞: ${existingServers.join(', ')}`);
      }

      if (existingServers.length >= config.SERVERS_COUNT_LIMIT) {
        return await ctx.reply('–î–æ—Å—Ç–∏–≥–Ω—É—Ç–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ—Ä–≤–µ—Ä–æ–≤. –£–¥–∞–ª–∏—Ç–µ –∫–∞–∫–æ–π-–Ω–∏–±—É–¥—å –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ (/dellq2server).');
      }
      existingServers.push(normalNameHard(server).toLowerCase());
    }

    if (game == 'q2') await updateUserSettings(userId, { q2servers: existingServers });
    else if (game == 'qw') await updateUserSettings(userId, { qwservers: existingServers });

    await ctx.reply(`üñ•Ô∏è –°–µ—Ä–≤–µ—Ä–∞ –¥–æ–±–∞–≤–ª–µ–Ω—ã: ${existingServers.join(', ')}
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /ag –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–≥—Ä –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ üïì /timer –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø–æ –∑–∞–¥–∞–Ω–Ω—ã–º –≤–∞–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º.
–ü—Ä–æ—Å–º–æ—Ç—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ –≤–∞—à–∏–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º: /info`);

    if (!await checkCanTimer(userId)) {
      await updateUserSettings(userId, { timerEnabled: 0 });
      await stopAutoSearch(userId);
      await ctx.reply(`üëÅÔ∏è –ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Å—Ç–∞—Ä—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞, —Å–µ–π—á–∞—Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Ç–∫–ª—é—á—ë–Ω.\n–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∫–ª—é—á—ë–Ω –≤ —Å–ª—É—á–∞–µ –µ—Å–ª–∏ –≤—ã –¥–æ–±–∞–≤–∏—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –≤–∫–ª—é—á–∏—Ç–µ —Ç–∞–π–º–µ—Ä.\n/help –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.`);
    }
    else if (await checkCanTimer(userId) && userSettings.timer && userSettings.timer != undefined && userSettings.timer != '' && userSettings.timer >= 30) {
      await stopAutoSearch(userId); //–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
      await updateUserSettings(userId, { timerEnabled: 1 });
      await startAutoSearch(userId, userSettings.timer);
      if (prevTimerEnabled == 0) {
        await ctx.reply(`üëÅÔ∏è –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤–∫–ª—é—á—ë–Ω.\n–¢–µ–∫—É—â–∏–π —Ç–∞–π–º–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ${userSettings.timer}\n–ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫–ª—é—á–∏—Ç—å –º–æ–∏–Ω—Ç–æ—Ä–∏–Ω–≥, –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –∫–æ–º–∞–Ω–¥–æ–π üïì /timer 0`);
      }
    }

  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è Q2 —Å–µ—Ä–≤–µ—Ä–æ–≤
bot.command('addserverq2', async (ctx) => {
  try {
    const servers = ctx.message.text.split(' ').slice(1);
    await addServers(ctx, servers, 'q2');
  } catch (error) {
    console.log(`–û—à–∏–±–∫–∞: `, error);
    ctx.reply(`–£–∫–∞–∂–∏—Ç–µ Q2 —Å–µ—Ä–≤–µ—Ä(–∞) –≤ —Ñ–æ—Ä–º–∞—Ç–µ ServerIP(–∏–ª–∏ –¥–æ–º–µ–Ω):Port/ServerName, –Ω–∞–ø—Ä–∏–º–µ—Ä - /addserverq2 q2.playground.ru:27910\n–ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ —É–∫–∞–∑–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ—Ä–≤–µ—Ä–æ–≤, —Ç–æ —Ä–∞–∑–¥–µ–ª—è–π—Ç–µ –∏—Ö –ø—Ä–æ–±–µ–ª–∞–º–∏.\n–í—ã —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ–∫—Ä–∞—â—ë–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã - /asq2`);
  }
});

bot.command('asq2', async (ctx) => {
  try {
    const servers = ctx.message.text.split(' ').slice(1);
    await addServers(ctx, servers, 'q2');
  } catch (error) {
    console.log(`–û—à–∏–±–∫–∞: `, error);
    ctx.reply(`–£–∫–∞–∂–∏—Ç–µ Q2 —Å–µ—Ä–≤–µ—Ä(–∞) –≤ —Ñ–æ—Ä–º–∞—Ç–µ ServerIP(–∏–ª–∏ –¥–æ–º–µ–Ω):Port/ServerName, –Ω–∞–ø—Ä–∏–º–µ—Ä - /addserverq2 q2.playground.ru:27910\n–ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ —É–∫–∞–∑–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ—Ä–≤–µ—Ä–æ–≤, —Ç–æ —Ä–∞–∑–¥–µ–ª—è–π—Ç–µ –∏—Ö –ø—Ä–æ–±–µ–ª–∞–º–∏.\n–í—ã —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ–∫—Ä–∞—â—ë–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã - /asq2`);
  }
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è Q2 —Å–µ—Ä–≤–µ—Ä–æ–≤
bot.command('addserverqw', async (ctx) => {
  try {
    const servers = ctx.message.text.split(' ').slice(1);
    await addServers(ctx, servers, 'qw');
  } catch (error) {
    console.log(`–û—à–∏–±–∫–∞: `, error);
    ctx.reply(`–£–∫–∞–∂–∏—Ç–µ QW —Å–µ—Ä–≤–µ—Ä(–∞) –≤ —Ñ–æ—Ä–º–∞—Ç–µ ServerIP(–∏–ª–∏ –¥–æ–º–µ–Ω):Port/ServerName, –Ω–∞–ø—Ä–∏–º–µ—Ä - /addserverqw 35.185.44.174:27500\n–ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ —É–∫–∞–∑–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ—Ä–≤–µ—Ä–æ–≤, —Ç–æ —Ä–∞–∑–¥–µ–ª—è–π—Ç–µ –∏—Ö –ø—Ä–æ–±–µ–ª–∞–º–∏.\n–í—ã —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ–∫—Ä–∞—â—ë–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã - /asqw`);
  }
});

bot.command('asqw', async (ctx) => {
  try {
    const servers = ctx.message.text.split(' ').slice(1);
    await addServers(ctx, servers, 'qw');
  } catch (error) {
    console.log(`–û—à–∏–±–∫–∞: `, error);
    ctx.reply(`–£–∫–∞–∂–∏—Ç–µ Q2 —Å–µ—Ä–≤–µ—Ä(–∞) –≤ —Ñ–æ—Ä–º–∞—Ç–µ ServerIP(–∏–ª–∏ –¥–æ–º–µ–Ω):Port/ServerName, –Ω–∞–ø—Ä–∏–º–µ—Ä - /addserverqw 35.185.44.174:27500\n–ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ —É–∫–∞–∑–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ—Ä–≤–µ—Ä–æ–≤, —Ç–æ —Ä–∞–∑–¥–µ–ª—è–π—Ç–µ –∏—Ö –ø—Ä–æ–±–µ–ª–∞–º–∏.\n–í—ã —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ–∫—Ä–∞—â—ë–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã - /asqw`);
  }
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –∏–º–µ–Ω–∏ –∏–≥—Ä–æ–∫–∞
function isValidPlayerName(name) {
  try {
    // –£–±–∏—Ä–∞–µ–º –∫–∞–≤—ã—á–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
    name = name.replace(/"/g, '');
    const trimmedName = name.replace(/\*/g, '').trim();
    const nameHasMask = name.includes('*');
    const minLength = nameHasMask ? config.PLAYERS_NICK_NAME_MASK_LIMIT : config.PLAYERS_NICK_NAME_LIMIT;
    return trimmedName.length >= minLength && (nameHasMask ? name.match(/\*/g).length <= 2 : true);
  } catch (error) {
    console.log(`–û—à–∏–±–∫–∞: `, error);
    return false; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º false –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
  }
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –∏–º–µ–Ω–∏ –∏–≥—Ä–æ–∫–∞
function isValidMapName(name) {
  try {
    // –£–±–∏—Ä–∞–µ–º –∫–∞–≤—ã—á–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
    console.log('isValidMapName, name=' + name);
    name = name.replace(/"/g, '');
    const trimmedName = name.replace(/\*/g, '').trim();
    const nameHasMask = name.includes('*');
    const minLength = nameHasMask ? config.MAPS_NAME_MASK_LIMIT : config.MAPS_NAME_LIMIT;
    return trimmedName.length >= minLength && (nameHasMask ? name.match(/\*/g).length <= 2 : true);
  } catch (error) {
    console.log(`–û—à–∏–±–∫–∞: `, error);
    return false; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º false –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
  }
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –∏–º–µ–Ω–∏ –∏–≥—Ä–æ–∫–∞
function isValidPlayerName2adadasda(name) {
  try {
    const trimmedName = name.replace(/\*/g, '').trim();
    const nameHasMask = name.includes('*');
    const minLength = nameHasMask ? config.PLAYERS_NICK_NAME_MASK_LIMIT : config.PLAYERS_NICK_NAME_LIMIT;
    return trimmedName.length >= minLength && (nameHasMask ? name.match(/\*/g).length <= 2 : true);
  } catch (error) {
    console.log(`–û—à–∏–±–∫–∞: `, error);
    return false; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º false –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
  }
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –∏–º–µ–Ω–∏ –∏–≥—Ä–æ–∫–∞ —Å —É—á–µ—Ç–æ–º –º–∞—Å–∫–∏
function matchPlayer(existingPlayer, newPlayer) {
  try {
    // –£–±–∏—Ä–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
    const lowerExistingPlayer = existingPlayer.toLowerCase();
    const lowerNewPlayer = formatName(newPlayer.toLowerCase());
    //console.log('existingPlayer=' + existingPlayer + ', newPlayer=' + newPlayer);
    //console.log('existingPlayer=' + existingPlayer + ', newPlayer = ' + newPlayer);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –º–∞—Å–∫–∏
    if (lowerExistingPlayer.startsWith('*') && lowerExistingPlayer.endsWith('*')) {
      // *text* - –∏—â–µ–º —Ç–µ–∫—Å—Ç –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ
      const searchText = lowerExistingPlayer.slice(1, -1);
      return lowerNewPlayer.includes(searchText);
    } else if (lowerExistingPlayer.startsWith('*')) {
      // *text - –∏—â–µ–º —Ç–µ–∫—Å—Ç –≤ –∫–æ–Ω—Ü–µ
      const searchText = lowerExistingPlayer.slice(1);
      return lowerNewPlayer.endsWith(searchText);
    } else if (lowerExistingPlayer.endsWith('*')) {
      // text* - –∏—â–µ–º —Ç–µ–∫—Å—Ç –≤ –Ω–∞—á–∞–ª–µ
      const searchText = lowerExistingPlayer.slice(0, -1);
      return lowerNewPlayer.startsWith(searchText);
    }

    // –ü–æ–ª–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ
    return lowerExistingPlayer === lowerNewPlayer;
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
}


/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –∏–º–µ–Ω–∏ –∏–≥—Ä–æ–∫–∞ —Å —É—á–µ—Ç–æ–º –º–∞—Å–∫–∏
function matchServer(existingServer, newServer) {
  try {
    // –£–±–∏—Ä–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
    //console.log('matchServer. existingServer='+existingServer+', newServer='+newServer);
    const lowerExistingServer = formatServerString(existingServer.toLowerCase());
    const lowerNewSerer = formatServerString(newServer.toLowerCase());

    //console.log('existingPlayer=' + existingPlayer + ', newPlayer = ' + newPlayer);
    /*
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –º–∞—Å–∫–∏
        if (lowerExistingServer.startsWith('*') && lowerExistingServer.endsWith('*')) {
          // *text* - –∏—â–µ–º —Ç–µ–∫—Å—Ç –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ
          const searchText = lowerExistingServer.slice(1, -1);
          return lowerNewSerer.includes(searchText);
        } else if (lowerExistingServer.startsWith('*')) {
          // *text - –∏—â–µ–º —Ç–µ–∫—Å—Ç –≤ –∫–æ–Ω—Ü–µ
          const searchText = lowerExistingServer.slice(1);
          return lowerNewSerer.endsWith(searchText);
        } else if (lowerExistingServer.endsWith('*')) {
          // text* - –∏—â–µ–º —Ç–µ–∫—Å—Ç –≤ –Ω–∞—á–∞–ª–µ
          const searchText = lowerExistingServer.slice(0, -1);
          return lowerNewSerer.startsWith(searchText);
        }
    */
    // –ü–æ–ª–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ
    return lowerExistingServer == lowerNewSerer;
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
}


/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è Q2 —Å–µ—Ä–≤–µ—Ä–æ–≤
async function delServer(ctx, server, game) {
  try {
    const userId = getUserID(ctx);

    const chatId = ctx.chat.id;
    await updateUserSettings(userId, { chatId: chatId });

    if (typeof game === 'undefined') {
      game = config.DEFAULT_GAME;
    }

    let userSettings = await getUserSettings(userId);

    let prevTimerEnabled = userSettings.timerEnabled;
    prevTimerEnabled = (!prevTimerEnabled || prevTimerEnabled == undefined || prevTimerEnabled == '' || prevTimerEnabled == 0) ? 0 : prevTimerEnabled;


    if (game == 'q2') existingServers = userSettings && userSettings.q2servers != undefined ? userSettings.q2servers : [];
    else if (game == 'qw') existingServers = userSettings && userSettings.qwservers != undefined ? userSettings.qwservers : [];

    if (!existingServers.includes(server.toLowerCase())) {
      return await ctx.reply(`–°–µ—Ä–≤–µ—Ä ${server} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –≤–∞—à–∏—Ö –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤\n–í–∞—à–∏ ${game} —Å–µ—Ä–≤–µ—Ä–∞: ${existingServers.join(', ')}`);
    }

    const updatedServers = existingServers.filter(p => p.toLowerCase() !== server.toLowerCase());
    console.log('delServer. game:' + game + ', existingServers = ' + existingServers.join(', ') + ', —Å–µ—Ä–≤–µ—Ä –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è: ' + server + ', updatedServers = ' + updatedServers.join(', '));
    let serversLeft;
    if (game == 'q2') {
      await updateUserSettings(userId, { q2servers: updatedServers });
      userSettings = await getUserSettings(userId);
      const q2servers = userSettings && userSettings.q2servers != undefined ? userSettings.q2servers : [];
      serversLeft = `${q2servers.length > 0 ? q2servers.join(', ') : '–Ω–µ—Ç - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /asq2'}.`;
    }
    else if (game == 'qw') {
      await updateUserSettings(userId, { qwservers: updatedServers });
      userSettings = await getUserSettings(userId);
      const qwservers = userSettings && userSettings.qwservers != undefined ? userSettings.qwservers : [];
      serversLeft = `${qwservers.length > 0 ? qwservers.join(', ') : '–Ω–µ—Ç - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /asqw'}.`;
    }

    await ctx.reply(`üñ•Ô∏è –°–µ—Ä–≤–µ—Ä ${server} —É–¥–∞–ª–µ–Ω.\n–û—Å—Ç–∞–ª—å–Ω—ã–µ ${game} —Å–µ—Ä–≤–µ—Ä–∞:\n${serversLeft}`);

    if (!await checkCanTimer(userId)) {
      await updateUserSettings(userId, { timerEnabled: 0 });
      await stopAutoSearch(userId);
      if (prevTimerEnabled == 1) await ctx.reply(`üëÅÔ∏è –ò–≥—Ä, –∏–≥—Ä–æ–∫–æ–≤ –∏ —Å–µ—Ä–≤–µ—Ä–æ–≤ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –±–æ–ª—å—à–µ –Ω–µ—Ç, –ø–æ—ç—Ç–æ–º—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Ç–∫–ª—é—á—ë–Ω.`);
    }
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è Q2 —Å–µ—Ä–≤–µ—Ä–æ–≤
bot.command('delserverq2', async (ctx) => {
  try {
    const server = ctx.message.text.split(' ')[1];
    await delServer(ctx, server, 'q2');
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
});

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è Q2 —Å–µ—Ä–≤–µ—Ä–æ–≤
bot.command('dsq2', async (ctx) => {
  try {
    const server = ctx.message.text.split(' ')[1];
    await delServer(ctx, server, 'q2');
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è QW —Å–µ—Ä–≤–µ—Ä–æ–≤
bot.command('delserverqw', async (ctx) => {
  try {
    const server = ctx.message.text.split(' ')[1];
    await delServer(ctx, server, 'qw');
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
});

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è Q2 —Å–µ—Ä–≤–µ—Ä–æ–≤
bot.command('dsqw', async (ctx) => {
  try {
    const server = ctx.message.text.split(' ')[1];
    await delServer(ctx, server, 'qw');
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–≥—Ä–æ–∫–æ–≤
async function addMaps(ctx, maps, game) {

  try {
    const userId = getUserID(ctx);
    const chatId = ctx.chat.id;
    await updateUserSettings(userId, { chatId: chatId });

    if (typeof game === 'undefined') {
      game = config.DEFAULT_GAME;
    }

    const userSettings = await getUserSettings(userId);
    let existingMaps;
    if (game == 'q2') existingMaps = userSettings && userSettings.q2maps != undefined ? userSettings.q2maps : [];
    if (game == 'qw') existingMaps = userSettings && userSettings.qwmaps != undefined ? userSettings.qwmaps : [];

    if (maps.length == 0 || ((maps.length + existingMaps.length) > config.MAPS_COUNT_LIMIT)) {
      return ctx.reply(`–í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç 1 –¥–æ ${config.MAPS_COUNT_LIMIT - existingMaps.length} –∫–∞—Ä—Ç(—ã).\n–í–∞—à–∏ –∫–∞—Ä—Ç—ã: ${existingMaps.join(', ')}`);
    }

    /*
    if (maps.length === 0 || maps.length > config.MAPS_COUNT_LIMIT) {
      return ctx.reply(`–í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç 1 –¥–æ ${config.MAPS_COUNT_LIMIT} –∫–∞—Ä—Ç.`);
    }
      
    const userSettings = await getUserSettings(userId);
    const existingMaps = userSettings.q2maps || [];
    */

    for (let map of maps) {

      map = formatName(map);

      if (!isValidMapName(map)) {
        return ctx.reply(`–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã –¥–æ–ª–∂–Ω–æ —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ –º–∏–Ω–∏–º—É–º ${config.MAPS_NAME_LIMIT} —Å–∏–º–≤–æ–ª–∞(–æ–≤). –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–∞—Å–∫–∞, —Ç–æ –º–∏–Ω–∏–º—É–º ${config.MAPS_NAME_MASK_LIMIT} —Å–∏–º–≤–æ–ª–∞(–æ–≤) + –æ–¥–Ω–∞ –∏–ª–∏ –¥–≤–µ –∑–≤–µ–∑–¥–æ—á–∫–∏.`);
      }
      if (existingMaps.some(existingMap => matchPlayer(existingMap, map))) {
        return ctx.reply(`–ö–∞—Ä—Ç–∞ ${map} —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞. –í–∞—à–∏ –∫–∞—Ä—Ç—ã: ${existingMaps.join(', ')}`);
      }

      if (existingMaps.length >= config.MAPS_COUNT_LIMIT) {
        return ctx.reply('–î–æ—Å—Ç–∏–≥–Ω—É—Ç–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —á–∏—Å–ª–æ –∫–∞—Ä—Ç. –£–¥–∞–ª–∏—Ç–µ —á—Ç–æ –Ω–∏–±—É–¥—å –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º (/delmapq2).');
      }
      existingMaps.push(map.toLowerCase());
    }

    if (game == 'q2') await updateUserSettings(userId, { q2maps: existingMaps });
    if (game == 'qw') await updateUserSettings(userId, { qwmaps: existingMaps });
    ctx.reply(`–ö–∞—Ä—Ç—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã: ${existingMaps.join(', ')}
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /ag –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–≥—Ä –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ üïì /timer –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø–æ –∑–∞–¥–∞–Ω–Ω—ã–º –≤–∞–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º.
–ü—Ä–æ—Å–º–æ—Ç—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ –≤–∞—à–∏–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º: /info`);
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/
function parseMap(ctx) {
  try {
    let maps = [];
    let currentMap = "";
    let inQuotes = false; // –§–ª–∞–≥, –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—â–∏–π –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–µ –≤ –∫–∞–≤—ã—á–∫–∞—Ö
    let inStar = false;

    const parts = ctx.message.text.split(/(\s+)/).slice(1); // –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø—Ä–æ–±–µ–ª—ã

    for (let i = 0; i < parts.length; i++) {
      const part = parts[i];

      if (part.startsWith('"') && part.endsWith('"')) {
        // –¢–µ–∫—Å—Ç –≤ –∫–∞–≤—ã—á–∫–∞—Ö
        maps.push(part);
      } else if (part.startsWith('"')) {
        // –ù–∞—á–∞–ª–æ —Ç–µ–∫—Å—Ç–∞ –≤ –∫–∞–≤—ã—á–∫–∞—Ö
        currentMap += part; // –Ω–µ —É–¥–∞–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é –∫–∞–≤—ã—á–∫—É
        inQuotes = true;
      } else if (part.endsWith('"')) {
        // –ö–æ–Ω–µ—Ü —Ç–µ–∫—Å—Ç–∞ –≤ –∫–∞–≤—ã—á–∫–∞—Ö
        currentMap += part; // –Ω–µ —É–¥–∞–ª—è–µ–º –∫–æ–Ω–µ—á–Ω—É—é –∫–∞–≤—ã—á–∫—É
        maps.push(currentMap);
        currentMap = "";
        inQuotes = false;
      } else if (inQuotes) {
        // –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –≤ –∫–∞–≤—ã—á–∫–∞—Ö
        currentMap += part; // –¥–æ–±–∞–≤–ª—è–µ–º –±–µ–∑ –ø—Ä–æ–±–µ–ª–∞
      } else if (part.startsWith('*') && part.endsWith('*')) {
        // –¢–µ–∫—Å—Ç –≤ –∑–≤–µ–∑–¥–æ—á–∫–∞—Ö
        maps.push(part);
      } else if (part.startsWith('*')) {
        // –ù–∞—á–∞–ª–æ —Ç–µ–∫—Å—Ç–∞ –≤ –∑–≤–µ–∑–¥–æ—á–∫–∞—Ö
        currentMap += part; // –Ω–µ —É–¥–∞–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é –∑–≤–µ–∑–¥–æ—á–∫—É
        inStar = true;
      } else if (inStar && !part.endsWith('*')) {
        // –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –≤ –∑–≤–µ–∑–¥–æ—á–∫–∞—Ö
        currentMap += part;
      } else if (inStar && part.endsWith('*')) {
        // –ö–æ–Ω–µ—Ü —Ç–µ–∫—Å—Ç–∞ –≤ –∑–≤–µ–∑–¥–æ—á–∫–∞—Ö
        currentMap += part;
        maps.push(currentMap);
        currentMap = "";
        inStar = false;
      } else if (part.endsWith('*')) {
        // –¢–µ–∫—Å—Ç –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –∑–≤–µ–∑–¥–æ—á–∫–æ–π
        currentMap += part;
        maps.push(currentMap);
        currentMap = "";
        inStar = false;
      } else {
        // –û–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ
        maps.push(part);
      }
    }
    // –ï—Å–ª–∏ –æ—Å—Ç–∞–ª–∏—Å—å –Ω–µ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ, –¥–æ–±–∞–≤–ª—è–µ–º –∏—Ö
    if (currentMap) {
      maps.push(currentMap);
    }

    maps = maps.filter(item => item.trim() !== '');
    maps = maps.filter((item, index, self) => {
      const lowercaseItem = item.toLowerCase();
      return index === self.findIndex(otherItem => otherItem.toLowerCase() === lowercaseItem);
    });

    return maps;

  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–≥—Ä–æ–≤—ã—Ö –∫–∞—Ä—Ç Q2
bot.command('addmapq2', async (ctx) => {
  try {
    let maps = parseMap(ctx);
    console.log("maps=" + maps.join(", "));
    await addMaps(ctx, maps, 'q2');
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
});

bot.command('amq2', async (ctx) => {
  try {
    let maps = parseMap(ctx);
    console.log("maps=" + maps.join(", "));
    await addMaps(ctx, maps, 'q2');
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–≥—Ä–æ–≤—ã—Ö –∫–∞—Ä—Ç QW
bot.command('addmapqw', async (ctx) => {
  try {
    let maps = parseMap(ctx);
    console.log("maps=" + maps.join(", "));
    await addMaps(ctx, maps, 'qw');
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
});

bot.command('amqw', async (ctx) => {
  try {
    let maps = parseMap(ctx);
    console.log("maps=" + maps.join(", "));
    await addMaps(ctx, maps, 'qw');
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∏–≥—Ä–æ–∫–æ–≤
async function delMap(ctx, map, game) {
  try {
    const userId = getUserID(ctx);
    const chatId = ctx.chat.id;

    if (typeof game === 'undefined') {
      game = config.DEFAULT_GAME;
    }

    let userSettings = await getUserSettings(userId);

    let existingMaps;
    if (game == 'q2') existingMaps = userSettings && userSettings.q2maps != undefined && userSettings.q2maps != '' ? userSettings.q2maps : [];
    if (game == 'qw') existingMaps = userSettings && userSettings.qwmaps != undefined && userSettings.qwmaps != '' ? userSettings.qwmaps : [];

    if (!map || map == undefined || map.trim() == '') {
      return ctx.reply(`–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã, –∫–æ—Ç–æ—Ä—É—é –≤—ã —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤–∞—à–∏—Ö –∫–∞—Ä—Ç –≤ –∏–≥—Ä–µ ${config.GAMES_TITLES[game]}.\n–í–∞—à–∏ ${game} –∫–∞—Ä—Ç—ã: ${existingMaps.join(', ')}`);
    }

    if (!existingMaps.includes(map.toLowerCase())) {
      return ctx.reply(`–ö–∞—Ä—Ç–∞ ${map} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –≤–∞—à–∏—Ö –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –∫–∞—Ä—Ç.\n–í–∞—à–∏ ${game} –∫–∞—Ä—Ç—ã: ${existingMaps.join(', ')}`);
    }

    const updatedMaps = existingMaps.filter(p => p.toLowerCase() !== map.toLowerCase());
    let mapsLeft;
    if (game == 'q2') {
      await updateUserSettings(userId, { q2maps: updatedMaps });
      userSettings = await getUserSettings(userId);
      const q2maps = userSettings && userSettings.q2maps != undefined && userSettings.q2maps != '' ? userSettings.q2maps : [];
      mapsLeft = `${q2maps.length > 0 ? q2maps.join(', ') : '–Ω–µ—Ç - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /amq2'}`;
    }
    else if (game == 'qw') {
      await updateUserSettings(userId, { qwmaps: updatedMaps });
      userSettings = await getUserSettings(userId);
      const qwmaps = userSettings && userSettings.qwmaps != undefined && userSettings.qwmaps != '' ? userSettings.qwmaps : [];
      mapsLeft = `${qwmaps.length > 0 ? qwmaps.join(', ') : '–Ω–µ—Ç - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /amqw'}`;
    }

    ctx.reply(`–ö–∞—Ä—Ç–∞ ${map} —É–¥–∞–ª–µ–Ω–∞.\n–û—Å—Ç–∞–ª—å–Ω—ã–µ ${game} –∫–∞—Ä—Ç—ã:\n${mapsLeft}`);

    userSettings = await getUserSettings(userId);
    /* if ((userSettings.q2servers === undefined || userSettings.q2servers.join("").trim() === '') && (userSettings.players === undefined || userSettings.players.join("").trim() === '')) {
       await updateUserSettings(userId, { timer: 0 });
       stopAutoSearch(userId);
       ctx.reply(`–ò–≥—Ä–æ–∫–æ–≤ –∏ —Å–µ—Ä–≤–µ—Ä–æ–≤ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –±–æ–ª—å—à–µ –Ω–µ—Ç, –ø–æ—ç—Ç–æ–º—É —Ç–∞–π–º–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–±—Ä–æ—à–µ–Ω –Ω–∞ 0, –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–∫–ª—é—á–µ–Ω–æ.`);
     } */
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∏–≥—Ä–æ–∫–æ–≤
bot.command('delmapq2', async (ctx) => {
  try {
    const map = ctx.message.text.split(' ')[1];
    await delMap(ctx, map, 'q2');
  } catch (error) {
    console.log(`–û—à–∏–±–∫–∞: `, error);
  }
});

bot.command('dmq2', async (ctx) => {
  try {
    const map = ctx.message.text.split(' ')[1];
    await delMap(ctx, map, 'q2');
  } catch (error) {
    console.log(`–û—à–∏–±–∫–∞: `, error);
  }
});

bot.command('delmapqw', async (ctx) => {
  try {
    const map = ctx.message.text.split(' ')[1];
    await delMap(ctx, map, 'qw');
  } catch (error) {
    console.log(`–û—à–∏–±–∫–∞: `, error);
  }
});

bot.command('dmqw', async (ctx) => {
  try {
    const map = ctx.message.text.split(' ')[1];
    await delMap(ctx, map, 'qw');
  } catch (error) {
    console.log(`–û—à–∏–±–∫–∞: `, error);
  }
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ–≥–æ
bot.command('delall', async (ctx) => {
  try {
    const userId = getUserID(ctx);
    userContexts[userId] = ctx; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await updateUserSettings(userId, { players: [] });
    await updateUserSettings(userId, { q2servers: [] });
    await updateUserSettings(userId, { q2maps: [] });
    await updateUserSettings(userId, { qwservers: [] });
    await updateUserSettings(userId, { qwmaps: [] });
    await updateUserSettings(userId, { playersFilter: [] });
    await updateUserSettings(userId, { games: [] });

    const chatId = ctx.chat.id;
    await updateUserSettings(userId, { chatId: chatId });
    await ctx.reply('–í—Å–µ –≤–∞—à–∏ –∏–≥—Ä–æ–∫–∏, —Å–µ—Ä–≤–µ—Ä–∞ –∏ –∫–∞—Ä—Ç—ã —É–¥–∞–ª–µ–Ω—ã.');

    if (!await checkCanTimer(userId)) {
      await updateUserSettings(userId, { timerEnabled: 0 });
      await stopAutoSearch(userId);
      await ctx.reply(`–ò–≥—Ä –∏–ª–∏ –∏–≥—Ä–æ–∫–æ–≤ –∏ —Å–µ—Ä–≤–µ—Ä–æ–≤ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –±–æ–ª—å—à–µ –Ω–µ—Ç, –ø–æ—ç—Ç–æ–º—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Ç–∫–ª—é—á—ë–Ω.`);
    }

  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤
bot.command('delallp', async (ctx) => {
  try {
    const userId = getUserID(ctx);
    userContexts[userId] = ctx; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await updateUserSettings(userId, { players: [] });
    const chatId = ctx.chat.id;
    await updateUserSettings(userId, { chatId: chatId });
    await ctx.reply('–í—Å–µ –≤–∞—à–∏ –∏–≥—Ä–æ–∫–∏ —É–¥–∞–ª–µ–Ω—ã.');

    if (!await checkCanTimer(userId)) {
      await updateUserSettings(userId, { timerEnabled: 0 });
      await stopAutoSearch(userId);
      await ctx.reply(`–ò–≥—Ä –∏–ª–∏ –∏–≥—Ä–æ–∫–æ–≤ –∏ —Å–µ—Ä–≤–µ—Ä–æ–≤ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –±–æ–ª—å—à–µ –Ω–µ—Ç, –ø–æ—ç—Ç–æ–º—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Ç–∫–ª—é—á—ë–Ω.`);
    }

  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏–≥—Ä–æ–∫–æ–≤
bot.command('delallpf', async (ctx) => {
  try {
    const userId = getUserID(ctx);
    userContexts[userId] = ctx; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await updateUserSettings(userId, { playersFilter: [] });
    const chatId = ctx.chat.id;
    await updateUserSettings(userId, { chatId: chatId });
    ctx.reply('–í—Å–µ –≤–∞—à–∏ —Ñ–∏–ª—å—Ç—Ä—ã –∏–≥—Ä–æ–∫–æ–≤ —É–¥–∞–ª–µ–Ω—ã.');

    if (!await checkCanTimer(userId)) {
      await updateUserSettings(userId, { timerEnabled: 0 });
      await stopAutoSearch(userId);
      ctx.reply(`–ò–≥—Ä –∏–ª–∏ –∏–≥—Ä–æ–∫–æ–≤ –∏ —Å–µ—Ä–≤–µ—Ä–æ–≤ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –±–æ–ª—å—à–µ –Ω–µ—Ç, –ø–æ—ç—Ç–æ–º—É –ø–æ—ç—Ç–æ–º—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Ç–∫–ª—é—á—ë–Ω.`);
    }

  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤
bot.command('delalls', async (ctx) => {
  try {
    const userId = getUserID(ctx);
    userContexts[userId] = ctx; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    await updateUserSettings(userId, { q2servers: [] });
    await updateUserSettings(userId, { qwservers: [] });

    const chatId = ctx.chat.id;
    await updateUserSettings(userId, { chatId: chatId });
    ctx.reply('–í—Å–µ –≤–∞—à–∏ —Å–µ—Ä–≤–µ—Ä–∞ —É–¥–∞–ª–µ–Ω—ã.');

    if (!await checkCanTimer(userId)) {
      await updateUserSettings(userId, { timerEnabled: 0 });
      await stopAutoSearch(userId);
      ctx.reply(`–ò–≥—Ä–∞ –∏–ª–∏ –∏–≥—Ä–æ–∫–æ–≤ –∏ —Å–µ—Ä–≤–µ—Ä–æ–≤ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –±–æ–ª—å—à–µ –Ω–µ—Ç, –ø–æ—ç—Ç–æ–º—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Ç–∫–ª—é—á—ë–Ω.`);
    }

  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
});


/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ—Ö –∫–∞—Ä—Ç
bot.command('delallm', async (ctx) => {
  try {
    const userId = getUserID(ctx);
    userContexts[userId] = ctx; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    await updateUserSettings(userId, { q2maps: [] });
    await updateUserSettings(userId, { qwmaps: [] });

    const chatId = ctx.chat.id;
    await updateUserSettings(userId, { chatId: chatId });
    ctx.reply('–í—Å–µ –≤–∞—à–∏ –∫–∞—Ä—Ç—ã —É–¥–∞–ª–µ–Ω—ã.');
    userSettings = await getUserSettings(userId);

  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

async function info(ctx) {
  try {
    const userId = getUserID(ctx);
    const userSettings = await getUserSettings(userId) || {};

    const games = userSettings.games || [];
    const gamesTitles = games.map(game => config.GAMES_TITLES[game]);
    const players = userSettings.players || [];
    const playersFilter = userSettings.playersFilter || [];
    let sparr = userSettings.spFilter || [];
    //console.log(sparr);
    sp = formatServers(sparr);
    //console.log('sp=' + sp);
    const q2servers = userSettings.q2servers || [];
    const q2maps = userSettings.q2maps || [];
    const qwservers = userSettings.qwservers || [];
    const qwmaps = userSettings.qwmaps || [];
    const timer = userSettings.timer && userSettings.timer !== undefined ? userSettings.timer : '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
    let timerEnabled = userSettings.timerEnabled && userSettings.timerEnabled !== undefined ? userSettings.timerEnabled : 0;
    timerEnabled = timerEnabled == 1 ? "—Ä–∞–∑—Ä–µ—à—ë–Ω" : "–Ω–µ —Ä–∞–∑—Ä–µ—à—ë–Ω";

    const sleepTime = userSettings.sleepTime && userSettings.sleepTime !== undefined && userSettings.sleepTime.trim() != '' ? userSettings.sleepTime : '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
    const isBanned = userSettings.banned || '–ù–µ—Ç';
    const isOwner = userId === config.OWNER_ID || false;
    var Message = `üéÆ–í–∞—à–∏ –∏–≥—Ä—ã: ${games.length > 0 ? games.join(', ') + ' (' + gamesTitles.join(', ') + ')' : '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–Ω—ã - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /ag'}.\n\n`;
    Message += `üïµÔ∏è –í–∞—à–∏ –∏–≥—Ä–æ–∫–∏: ${players.length > 0 ? '\n' + players.join(', ') : '–Ω–µ—Ç - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /ap'}.

üïµÔ∏è –í–∞—à —Ñ–∏–ª—å—Ç—Ä –∏–≥—Ä–æ–∫–æ–≤: ${playersFilter.length > 0 ? '\n' + playersFilter.join(', ') : '–Ω–µ—Ç - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /apf'}.

üñ•Ô∏èüïµÔ∏è –í–∞—à —Ñ–∏–ª—å—Ç—Ä —Å–µ—Ä–≤–µ—Ä-–∏–≥—Ä–æ–∫: ${sp.trim() != '' ? '\n' + sp : '–Ω–µ—Ç - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /aspf'}.

üñ•Ô∏è –í–∞—à–∏ Q2 —Å–µ—Ä–≤–µ—Ä–∞: ${q2servers.length > 0 ? '\n' + q2servers.join(', ') : '–Ω–µ—Ç - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /asq2'}.

üèùÔ∏è –í–∞—à–∏ Q2 –∫–∞—Ä—Ç—ã: ${q2maps.length > 0 ? '\n' + q2maps.join(', ') : '–Ω–µ—Ç - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /amq2'}

üñ•Ô∏è –í–∞—à–∏ QW —Å–µ—Ä–≤–µ—Ä–∞: ${qwservers.length > 0 ? '\n' + qwservers.join(', ') : '–Ω–µ—Ç - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /asqw'}.

üèùÔ∏è –í–∞—à–∏ QW –∫–∞—Ä—Ç—ã: ${qwmaps.length > 0 ? '\n' + qwmaps.join(', ') : '–Ω–µ—Ç - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /amqw'}

„Ä∞Ô∏è„Ä∞Ô∏è„Ä∞Ô∏è„Ä∞Ô∏è„Ä∞Ô∏è„Ä∞Ô∏è„Ä∞Ô∏è„Ä∞Ô∏è„Ä∞Ô∏è„Ä∞Ô∏è„Ä∞Ô∏è

üîç –ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ${timer} —Å–µ–∫—É–Ω–¥(—ã).
üëÅÔ∏è –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: ${timerEnabled}.
üïì –£–ø—Ä–∞–≤–ª—è—Ç—å: /timer

üí§ –í—Ä–µ–º—è —Å–Ω–∞: ${sleepTime}.
–£–ø—Ä–∞–≤–ª—è—Ç—å: /st

„Ä∞Ô∏è„Ä∞Ô∏è„Ä∞Ô∏è„Ä∞Ô∏è„Ä∞Ô∏è„Ä∞Ô∏è„Ä∞Ô∏è„Ä∞Ô∏è„Ä∞Ô∏è„Ä∞Ô∏è„Ä∞Ô∏è
`;

    let advmode = userSettings.advmode;
    if (advmode == undefined || advmode === 0) {
      Message += 'üìö –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º: –≤—ã–∫–ª—é—á–µ–Ω.\n–£–ø—Ä–∞–≤–ª—è—Ç—å: /am';
    } else {
      Message += '\n\nüìö –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º: –≤–∫–ª—é—á—ë–Ω.\n–£–ø—Ä–∞–≤–ª—è—Ç—å: /am\n–¢–µ–∫—É—â–µ–µ –ó–Ω–∞—á–µ–Ω–∏–µ: ' + advmode;
    }

    let advcontrols = userSettings.advcontrols;
    if (advcontrols === undefined || advcontrols === 0) {
      Message += '\n\nüàÅ –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö –ø–æ–∏—Å–∫–∞: –≤—ã–∫–ª—é—á–µ–Ω–æ.\n–í–∫–ª—é—á–∏—Ç—å: /ac 1';
    } else {
      Message += '\n\nüàÅ –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö –ø–æ–∏—Å–∫–∞: –≤–∫–ª—é—á–µ–Ω–æ.\n–û—Ç–∫–ª—é—á–∏—Ç—å: /ac 0';
    }

    let altview = userSettings.altview;
    if (altview === undefined || altview === 0) {
      Message += '\n\nüí°–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π (–∫–æ–º–ø–∞–∫—Ç–Ω—ã–π) —Ä–µ–∂–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏: –≤—ã–∫–ª—é—á–µ–Ω.\n–í–∫–ª—é—á–∏—Ç—å: /av 1';
    } else {
      Message += '\n\nüí°–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π (–∫–æ–º–ø–∞–∫—Ç–Ω—ã–π) —Ä–µ–∂–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏: –≤–∫–ª—é—á–µ–Ω–æ.\n–û—Ç–∫–ª—é—á–∏—Ç—å: /av 0';
    }

    let autodelhistory = userSettings.autodelhistory;
    if (autodelhistory === undefined || autodelhistory === 0) {
      Message += '\n\nüóëÔ∏è –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–∞—Ö / —Å–µ—Ä–≤–µ—Ä–∞—Ö: –≤—ã–∫–ª—é—á–µ–Ω–æ.\n–í–∫–ª—é—á–∏—Ç—å: /adh 1';
    } else {
      Message += '\n\nüóëÔ∏è –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–∞—Ö / —Å–µ—Ä–≤–µ—Ä–∞—Ö: –≤–∫–ª—é—á–µ–Ω–æ.\n–û—Ç–∫–ª—é—á–∏—Ç—å: /adh 0';
    }

    let heuristic = userSettings.heuristic;
    if (heuristic === undefined || heuristic === 0) {
      Message += '\n\nüßä –≠–≤—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑: –≤—ã–∫–ª—é—á–µ–Ω.\n–í–∫–ª—é—á–∏—Ç—å: /hm 1';
    } else {
      Message += '\n\nüßä –≠–≤—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑: –≤–∫–ª—é—á–µ–Ω.\n–û—Ç–∫–ª—é—á–∏—Ç—å: /hm 0';
    }

    let minPlayers = userSettings.minPlayers;
    if (minPlayers == undefined) minPlayers = 1;
    if (minPlayers === 0) {
      Message += '\n\nüñ•Ô∏è –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–µ—Ä–æ–≤ –ø–æ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∏–≥—Ä–æ–∫–æ–≤: –≤—ã–∫–ª—é—á–µ–Ω–∞.\n–£–ø—Ä–∞–≤–ª—è—Ç—å: /mp';
    } else {
      Message += '\n\nüñ•Ô∏è –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–µ—Ä–æ–≤ –ø–æ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∏–≥—Ä–æ–∫–æ–≤: –≤–∫–ª—é—á–µ–Ω–∞.\n–£–ø—Ä–∞–≤–ª—è—Ç—å: /mp\n–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: ' + String(minPlayers);
    }

    let minPS = userSettings && userSettings.minplayerscore != undefined ? userSettings.minplayerscore : 0;
    if (minPS === 0) {
      Message += '\n\nüñ•Ô∏è –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–∞ –ø–æ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –µ–≥–æ –æ—á–∫–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: –≤—ã–∫–ª—é—á–µ–Ω–∞.\n–£–ø—Ä–∞–≤–ª—è—Ç—å: /mps';
    } else {
      Message += '\n\nüñ•Ô∏è –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–∞ –ø–æ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –µ–≥–æ –æ—á–∫–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: –≤–∫–ª—é—á–µ–Ω–∞.\n–£–ø—Ä–∞–≤–ª—è—Ç—å: /mps\n–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: ' + String(minPS);
    }

    let botFilter = userSettings.botFilter;
    if (botFilter === undefined) botFilter = 1;
    if (botFilter === 0) {
      Message += '\n\n‚úñÔ∏è –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–µ—Ä–æ–≤ –ø–æ –±–æ—Ç–∞–º: –≤—ã–∫–ª—é—á–µ–Ω–∞';
    } else {
      Message += '\n\n‚úñÔ∏è –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–µ—Ä–æ–≤ –ø–æ –±–æ—Ç–∞–º: –≤–∫—é—á–µ–Ω–∞';
    }

    Message += `

    „Ä∞Ô∏è„Ä∞Ô∏è„Ä∞Ô∏è„Ä∞Ô∏è„Ä∞Ô∏è„Ä∞Ô∏è„Ä∞Ô∏è„Ä∞Ô∏è„Ä∞Ô∏è„Ä∞Ô∏è„Ä∞Ô∏è
    
  ‚ö†Ô∏è –°—Ç–∞—Ç—É—Å –≤–∞—à–µ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤ –±–æ—Ç–µ:  ${isBanned}

  –í–µ—Ä—Å–∏—è –±–æ—Ç–∞: ${config.VERSION}
       
    `;

    if (isOwner) Message = `‚úÖ  –í—ã - –≤–ª–∞–¥–µ–ª–µ—Ü –±–æ—Ç–∞.\n\n` + Message;
    //"‚ö†Ô∏è SELL" : "‚úÖ  BUY"
    try {
      ctx.reply(Message);
    }
    catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error) };

  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error) };
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∏–≥—Ä–æ–∫–∞—Ö
bot.command('info', async (ctx) => {
  try {
    await info(ctx);
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error) };
});

bot.command('i', async (ctx) => {
  try {
    await info(ctx);
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error) };
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

async function timer(ctx) { //—Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç–∞–π–º–µ—Ä–∞
  try {
    const userId = getUserID(ctx);
    userContexts[userId] = ctx; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    let userSettings = await getUserSettings(userId) || {};
    const timerValue = parseInt(ctx.message.text.split(' ')[1]);
    const timer = userSettings.timer !== undefined ? userSettings.timer : '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
    if (isNaN(timerValue) || timerValue < 0 || (timerValue > 0 && timerValue < config.MIN_TIMER)) {
      return ctx.reply(`–£–∫–∞–∂–∏—Ç–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞ –æ—Ç ${config.MIN_TIMER} —Å–µ–∫—É–Ω–¥(—ã) –∏–ª–∏ –±–æ–ª—å—à–µ, –∏–ª–∏ 0 –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è.\n–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: ${timer}.`);
    }
    let prevTimerEnabled = userSettings.timerEnabled;
    prevTimerEnabled = (!prevTimerEnabled || prevTimerEnabled == undefined || prevTimerEnabled == '' || prevTimerEnabled == 0) ? 0 : prevTimerEnabled;

    await updateUserSettings(userId, { timer: timerValue });
    ctx.reply(`üïì –¢–∞–π–º–µ—Ä —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ ${timerValue} —Å–µ–∫—É–Ω–¥(—ã).`);

    if (timerValue > 0) {
      userSettings = await getUserSettings(userId);
      if (!await checkCanTimer(userId)) {
        await updateUserSettings(userId, { timerEnabled: 0 });
        await stopAutoSearch(userId);
        //return await bot.telegram.sendMessage(ctx.chat.id, '–í–Ω–∞—á–∞–ª–µ –≤–Ω–µ—Å–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞: \n - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∏–≥—Ä—ã –∫–æ–º–∞–Ω–¥–æ–π /ag\n - –¥–æ–±–∞–≤—å—Ç–µ –∏–≥—Ä–æ–∫–æ–≤ –¥–ª—è –æ—Å—Ç–ª–µ–∂–∏–≤–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥–æ–π /ap –∏/–∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞ –∫–æ–º–∞–Ω–¥–∞–º–∏ /asq2 –∏ /asqw)\n–ü—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∫–æ–º–∞–Ω–¥–æ–π /st\n–ó–∞—Ç–µ–º –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –≤–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞.\n–í–∞—à–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: /i');
        return await ctx.reply('–í–Ω–∞—á–∞–ª–µ –≤–Ω–µ—Å–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞: \n - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∏–≥—Ä—ã –∫–æ–º–∞–Ω–¥–æ–π /ag\n - –¥–æ–±–∞–≤—å—Ç–µ –∏–≥—Ä–æ–∫–æ–≤ –¥–ª—è –æ—Å—Ç–ª–µ–∂–∏–≤–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥–æ–π /ap –∏/–∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞ –∫–æ–º–∞–Ω–¥–∞–º–∏ /asq2 –∏ /asqw)\n–ü—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∫–æ–º–∞–Ω–¥–æ–π /st\n–ó–∞—Ç–µ–º –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –≤–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞.\n–í–∞—à–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: /i');
      }
      else {
        await updateUserSettings(userId, { timerEnabled: 1 });
        await updateUserSettings(userId, { timer: timerValue });
        await stopAutoSearch(userId); //–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
        await startAutoSearch(userId, timerValue);
        if (prevTimerEnabled == 0) ctx.reply(`üëÅÔ∏è –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤–∫–ª—é—á—ë–Ω.\n–¢–µ–∫—É—â–∏–π —Ç–∞–π–º–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ${userSettings.timer}\n–í–∞—à–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: /i\n–ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫–ª—é—á–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥, –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –∫–æ–º–∞–Ω–¥–æ–π üïì /timer 0`);
      }
    } else {
      await updateUserSettings(userId, { timerEnabled: 0 });
      await stopAutoSearch(userId);
      if (prevTimerEnabled == 1) ctx.reply(`üëÅÔ∏è –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Ç–∫–ª—é—á—ë–Ω.\n–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ —Å–ª—É—á–∞–µ –µ—Å–ª–∏ –≤—ã –¥–æ–±–∞–≤–∏—Ç–µ –Ω–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –≤–∫–ª—é—á–∏—Ç–µ —Ç–∞–π–º–µ—Ä.\n/help –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.`);
    }

  } catch (error) { console.log(`–û—à–∏–±–∫–∞:`, error) };
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç–∞–π–º–µ—Ä–∞
bot.command('timer', async (ctx) => {
  try {
    await timer(ctx);
  } catch (error) { console.log(`–û—à–∏–±–∫–∞:`, error) };
});

bot.command('t', async (ctx) => {
  try {
    await timer(ctx);
  } catch (error) { console.log(`–û—à–∏–±–∫–∞:`, error) };
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

async function advMode(ctx) { //–≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ advmode
  try {
    const userId = getUserID(ctx);
    userContexts[userId] = ctx; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    let advmode = parseInt(ctx.message.text.split(' ')[1]);
    let userSettings;

    if (isNaN(advmode) || advmode < 0 || (advmode > 3)) {
      userSettings = await getUserSettings(userId);
      advmode = userSettings && userSettings.advmode != undefined ? userSettings.advmode : 0;
      return ctx.reply('–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞:\n0 - –æ—Ç–∫–ª—é—á–µ–Ω–æ\n1 - –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–µ–∫—É—â–µ–º —Å—á–µ—Ç–µ –∏ –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–∞—Ö\n2 - –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö —Å–µ—Ä–≤–µ—Ä–∞\n3 - –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Å–µ–π –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.\n\n–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: ' + advmode);
    }

    await updateUserSettings(userId, { advmode: advmode });
    userSettings = await getUserSettings(userId);
    advmode = userSettings.advmode;
    if (advmode > 0) {
      return ctx.reply('üìö –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏: –í–ö–õ–Æ–ß–Å–ù.');
    } else {
      return ctx.reply('üìö –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏: –í–´–ö–õ–Æ–ß–ï–ù.');
    }


  } catch (error) { console.log(`–û—à–∏–±–∫–∞:`, error) };
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
bot.command('advmode', async (ctx) => {
  try {
    await advMode(ctx);
  } catch (error) { console.log(`–û—à–∏–±–∫–∞:`, error) };
});

bot.command('am', async (ctx) => {
  try {
    await advMode(ctx);
  } catch (error) { console.log(`–û—à–∏–±–∫–∞:`, error) };
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

async function advControls(ctx) { //–≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ advcontrols
  try {
    const userId = getUserID(ctx);
    userContexts[userId] = ctx; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    let advcontrols = parseInt(ctx.message.text.split(' ')[1]);
    let userSettings;

    if (isNaN(advcontrols) || advcontrols < 0 || (advcontrols > 1)) {
      userSettings = await getUserSettings(userId);
      advcontrols = userSettings && userSettings.advcontrols != undefined ? userSettings.advcontrols : 0;
      return ctx.reply('–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞:\n0 - –æ—Ç–∫–ª—é—á–µ–Ω–æ\n1 - –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ –ø–æ–¥ –æ–∫–Ω–æ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø–æ–∏—Å–∫–∞.\n\n–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: ' + advcontrols);
    }

    await updateUserSettings(userId, { advcontrols: advcontrols });
    userSettings = await getUserSettings(userId);
    advcontrols = userSettings.advcontrols;
    if (advcontrols > 0) {
      return ctx.reply('üàÅ –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ –≤ –æ–∫–Ω–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞: –í–ö–õ–Æ–ß–ï–ù–û.');
    } else {
      return ctx.reply('üàÅ –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ –≤ –æ–∫–Ω–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞: –í–´–ö–õ–Æ–ß–ï–ù–û.');
    }


  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
bot.command('advcontrols', async (ctx) => {
  try {
    await advControls(ctx);
  } catch (error) { console.log(`–û—à–∏–±–∫–∞:`, error) };
});

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
bot.command('ac', async (ctx) => {
  try {
    await advControls(ctx);
  } catch (error) { console.log(`–û—à–∏–±–∫–∞:`, error) };
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

async function autoDelHistory(ctx) { //–≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ autodelhistory
  try {
    const userId = getUserID(ctx);
    userContexts[userId] = ctx; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    let autodelhistory = parseInt(ctx.message.text.split(' ')[1]);
    let userSettings;

    if (isNaN(autodelhistory) || autodelhistory < 0 || (autodelhistory > 1)) {
      userSettings = await getUserSettings(userId);
      autodelhistory = userSettings && userSettings.autodelhistory != undefined ? userSettings.autodelhistory : 0;
      return ctx.reply('–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞:\n0 - –æ—Ç–∫–ª—é—á–µ–Ω–æ\n1 - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–∞—Ö / —Å–µ—Ä–≤–µ—Ä–∞—Ö.\n\n–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: ' + autodelhistory);
    }

    await updateUserSettings(userId, { autodelhistory: autodelhistory });
    userSettings = await getUserSettings(userId);
    autodelhistory = userSettings.autodelhistory;
    if (autodelhistory > 0) {
      return ctx.reply('–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–∞—Ö / —Å–µ—Ä–≤–µ—Ä–∞—Ö: –í–ö–õ–Æ–ß–ï–ù–û.');
    } else {
      return ctx.reply('–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–∞—Ö / —Å–µ—Ä–≤–µ—Ä–∞—Ö: –í–´–ö–õ–Æ–ß–ï–ù–û.');
    }


  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

bot.command('autodelhistory', async (ctx) => {
  try {
    await autoDelHistory(ctx);
  } catch (error) { console.log(`–û—à–∏–±–∫–∞:`, error) };
});

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
bot.command('adh', async (ctx) => {
  try {
    await autoDelHistory(ctx);
  } catch (error) { console.log(`–û—à–∏–±–∫–∞:`, error) };
});


/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

async function altViewSetup(ctx) { //–≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ altview
  try {
    const userId = getUserID(ctx);
    userContexts[userId] = ctx; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    let altview = parseInt(ctx.message.text.split(' ')[1]);
    let userSettings;

    if (isNaN(altview) || altview < 0 || (altview > 1)) {
      userSettings = await getUserSettings(userId);
      altview = userSettings && userSettings.altview != undefined ? userSettings.altview : 0;
      return ctx.reply('–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞:\n0 - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏\n1 - –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ (–∫–æ–º–ø–∞–∫—Ç–Ω–æ–µ).\n\n–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: ' + altview);
    }

    await updateUserSettings(userId, { altview: altview });
    userSettings = await getUserSettings(userId);
    altview = userSettings.altview;
    if (altview > 0) {
      return ctx.reply('–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ (–∫–æ–º–ø–∞–∫—Ç–Ω–æ–µ) –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏: –í–ö–õ–Æ–ß–ï–ù–û.');
    } else {
      return ctx.reply('–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ (–∫–æ–º–ø–∞–∫—Ç–Ω–æ–µ) –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏: –í–´–ö–õ–Æ–ß–ï–ù–û.');
    }


  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
bot.command('altview', async (ctx) => {
  try {
    await altViewSetup(ctx);
  } catch (error) { console.log(`–û—à–∏–±–∫–∞:`, error) };
});

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
bot.command('av', async (ctx) => {
  try {
    await altViewSetup(ctx);
  } catch (error) { console.log(`–û—à–∏–±–∫–∞:`, error) };
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

async function heuristicMode(ctx) { //–≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ altview
  try {
    const userId = getUserID(ctx);
    userContexts[userId] = ctx; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    let heuristic = parseInt(ctx.message.text.split(' ')[1]);
    let userSettings;

    if (isNaN(heuristic) || heuristic < 0 || (heuristic > 1)) {
      userSettings = await getUserSettings(userId);
      heuristic = userSettings && userSettings.heuristic != undefined ? userSettings.heuristic : 0;
      return ctx.reply('–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞:\n0 - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ\n1 - —ç–≤—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ (–±–∞–∑–æ–≤–∞—è –≤–µ—Ä—Å–∏—è).\n\n–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: ' + heuristic);
    }

    await updateUserSettings(userId, { heuristic: heuristic });
    userSettings = await getUserSettings(userId);
    heuristic = userSettings.heuristic;
    if (heuristic > 0) {
      return ctx.reply('üßä –≠–≤—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑: –í–ö–õ–Æ–ß–ï–ù.');
    } else {
      return ctx.reply('üßä –≠–≤—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑: –í–´–ö–õ–Æ–ß–ï–ù.');
    }


  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —ç–≤—Ä–∏—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞
bot.command('heuristicmode', async (ctx) => {
  try {
    await heuristicMode(ctx);
  } catch (error) { console.log(`–û—à–∏–±–∫–∞:`, error) };
});

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —ç–≤—Ä–∏—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞
bot.command('hm', async (ctx) => {
  try {
    await heuristicMode(ctx);
  } catch (error) { console.log(`–û—à–∏–±–∫–∞:`, error) };
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

async function minPlayerScore(ctx) { //–≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ altview
  try {
    const userId = getUserID(ctx);
    userContexts[userId] = ctx; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    let minPS = parseInt(ctx.message.text.split(' ')[1]);
    let userSettings;

    if (isNaN(minPS)) {
      userSettings = await getUserSettings(userId);
      minPS = userSettings && userSettings.minplayerscore != undefined ? userSettings.minplayerscore : 0;
      return ctx.reply(`–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞:

‚û°Ô∏è 0 : –Ω–µ —É—á–∏—Ç—ã–≤–∞—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—á–∫–æ–≤ –≤ –ø–æ–∏—Å–∫–µ –∏–≥—Ä–æ–∫–∞.
‚û°Ô∏è 1 –∏ –±–æ–ª—å—à–µ : —É—á–∏—Ç—ã–≤–∞—Ç—å (–Ω–∞ —É–∫–∞–∑–∞–Ω–Ω–æ–µ —á–∏—Å–ª–æ). –ö –ø—Ä–∏–º–µ—Ä—É, –µ—Å–ª–∏ –≤—ã —É–∫–∞–∑–∞–ª–∏ 2, —Ç–æ –∏–≥—Ä–æ–∫ –ø–æ–ø–∞–¥—ë—Ç –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç–æ–ª—å–∫–æ –≤ —Ç–æ–º —Å–ª—É—á–∞–µ, –µ—Å–ª–∏ —Å—á—ë—Ç –µ–≥–æ —Ñ—Ä–∞–≥–æ–≤ –æ—Ç 2 –∏ –±–æ–ª—å—à–µ.
‚û°Ô∏è -1 –∏ –º–µ–Ω—å—à–µ : —É—á–∏—Ç—ã–≤–∞—Ç—å –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω–æ–µ —á–∏—Å–ª–æ + —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω—É–ª–µ–≤–æ–≥–æ —Å—á–µ—Ç–∞. –ö –ø—Ä–∏–º–µ—Ä—É, –µ—Å–ª–∏ –≤—ã —É–∫–∞–∑–∞–ª–∏ -1, —Ç–æ –∏–≥—Ä–æ–∫ –ø–æ–ø–∞–¥—ë—Ç –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç–æ–ª—å–∫–æ –≤ —Å–ª—É—á–∞–µ, –µ—Å–ª–∏ —É –Ω–µ–≥–æ -1 —Ñ—Ä–∞–≥–æ–≤ –∏–ª–∏ –±–æ–ª—å—à–µ, –Ω–æ –µ—Å–ª–∏ —É –Ω–µ–≥–æ –±—É–¥–µ—Ç –º–µ–Ω—å—à–µ -1 –∏–ª–∏ 0 , —Ç–æ –Ω–µ –ø–æ–ø–∞–¥—ë—Ç.

 üóÉÔ∏è –¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: ${minPS}`);
    }

    await updateUserSettings(userId, { minplayerscore: minPS });
    userSettings = await getUserSettings(userId);
    minPS = userSettings.heuristic;
    if (minPS > 0) {
      return ctx.reply('üïµÔ∏è –£—á—ë—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—á–∫–æ–≤ –≤ –ø–æ–∏—Å–∫–µ –∏–≥—Ä–æ–∫–∞:  –í–ö–õ–Æ–ß–ï–ù–û.');
    } else {
      return ctx.reply('üïµÔ∏è –£—á—ë—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—á–∫–æ–≤ –≤ –ø–æ–∏—Å–∫–µ –∏–≥—Ä–æ–∫–∞:  –í–´–ö–õ–Æ–ß–ï–ù–û.');
    }


  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ —Å—á—ë—Ç–∞ –∏–≥—Ä–æ–∫–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞
bot.command('minplayerscore', async (ctx) => {
  try {
    await minPlayerScore(ctx);
  } catch (error) { console.log(`–û—à–∏–±–∫–∞:`, error) };
});

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ —Å—á—ë—Ç–∞ –∏–≥—Ä–æ–∫–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞
bot.command('mps', async (ctx) => {
  try {
    await minPlayerScore(ctx);
  } catch (error) { console.log(`–û—à–∏–±–∫–∞:`, error) };
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

async function minPlayers(ctx) { //—Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª-–≤–∞ –∏–≥—Ä–æ–∫–æ–≤
  try {
    const userId = getUserID(ctx);
    userContexts[userId] = ctx; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    let minPlayers = parseInt(ctx.message.text.split(' ')[1]);
    let userSettings;

    if (isNaN(minPlayers) || minPlayers < 0 || (minPlayers > config.SERVER_MIN_PLAYERS)) {
      userSettings = await getUserSettings(userId);
      minPlayers = userSettings && userSettings.minPlayers != undefined ? userSettings.minPlayers : 1;
      return ctx.reply(`–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞:\n0 - –æ—Ç–∫–ª—é—á–µ–Ω–æ\n1 ... ${config.SERVER_MIN_PLAYERS} –≤–∫–ª—é—á–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ –≤ –ø–æ–∏—Å–∫ —Ç–æ–ª—å–∫–æ –≤ —Å–ª—É—á–∞–µ, –µ—Å–ª–∏ –Ω–∞ –Ω—ë–º –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –Ω–µ –º–µ–Ω–µ–µ –∑–∞–¥–∞–Ω–Ω–æ–≥–æ —á–∏—Å–ª–∞ –∏–≥—Ä–æ–∫–æ–≤.\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /botfilter 1 –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –∏—Å–∫–ª—é—á–∏—Ç—å –∏–∑ –∞–Ω–∞–ª–∏–∑–∞ –±–æ—Ç–æ–≤ —Ç–∏–ø–∞ WallFly\n–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: ${minPlayers}`);
    }

    await updateUserSettings(userId, { minPlayers: minPlayers });
    userSettings = await getUserSettings(userId);
    minPlayers = userSettings.minPlayers;
    if (minPlayers > 0) {
      return ctx.reply('–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–µ—Ä–æ–≤ –ø–æ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∏–≥—Ä–æ–∫–æ–≤: –í–ö–õ–Æ–ß–ï–ù–ê');
    } else {
      return ctx.reply('–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–µ—Ä–æ–≤ –ø–æ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∏–≥—Ä–æ–∫–æ–≤: –í–´–ö–õ–Æ–ß–ï–ù–ê.');
    }
  } catch (error) { console.log(`–û—à–∏–±–∫–∞:`, error) };
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª-–≤–∞ –∏–≥—Ä–æ–∫–æ–≤ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–æ–º (–Ω–µ –≤–ª–∏—è–µ—Ç –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –ø–æ –∏–≥—Ä–æ–∫–∞–º)
bot.command('minplayers', async (ctx) => {
  try {
    await minPlayers(ctx);
  } catch (error) { console.log(`–û—à–∏–±–∫–∞:`, error) };
});

bot.command('mp', async (ctx) => {
  try {
    await minPlayers(ctx);
  } catch (error) { console.log(`–û—à–∏–±–∫–∞:`, error) };
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

async function botFilter(ctx) { //—Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–µ–∂–∏–º–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –≤ –ø–æ–∏—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–æ–≤ –≥–¥–µ –∏–º–µ—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –±–æ—Ç—ã —Ç–∏–ø–∞ wallfly
  try {
    const userId = getUserID(ctx);
    userContexts[userId] = ctx; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    let botFilter = parseInt(ctx.message.text.split(' ')[1]);
    let userSettings;

    if (isNaN(botFilter) || botFilter < 0 || (botFilter > 1)) {
      userSettings = await getUserSettings(userId);
      botFilter = userSettings && userSettings.botFilter != undefined ? userSettings.botFilter : 1;
      return ctx.reply('–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞:\n0 - –æ—Ç–∫–ª—é—á–µ–Ω–æ, 1 - –≤–∫–ª—é—á–µ–Ω–æ\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /botfilter 1 –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –∏—Å–∫–ª—é—á–∏—Ç—å –∏–∑ –∞–Ω–∞–ª–∏–∑–∞ –±–æ—Ç–æ–≤ —Ç–∏–ø–∞ WallFly (–≤–ª–∏—è–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–æ–≤ –≤ –ø–∞—Ä–µ —Å –∫–æ–º–∞–Ω–¥–æ–π \minplayers.\n–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: ' + botFilter);
    }

    await updateUserSettings(userId, { botFilter: botFilter });
    userSettings = await getUserSettings(userId);
    botFilter = userSettings.botFilter;
    if (botFilter > 0) {
      return ctx.reply('–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –±–æ—Ç–æ–≤: –í–ö–õ–Æ–ß–ï–ù–ê');
    } else {
      return ctx.reply('–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –±–æ—Ç–æ–≤: –í–´–ö–õ–Æ–ß–ï–ù–ê.');
    }


  } catch (error) { console.log(`–û—à–∏–±–∫–∞:`, error) };
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–µ–∂–∏–º–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –≤ –ø–æ–∏—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–æ–≤ –≥–¥–µ –∏–º–µ—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –±–æ—Ç—ã —Ç–∏–ø–∞ wallfly
bot.command('botfilter', async (ctx) => {
  try {
    await botFilter(ctx);
  } catch (error) { console.log(`–û—à–∏–±–∫–∞:`, error) };
});

bot.command('bf', async (ctx) => {
  try {
    await botFilter(ctx);
  } catch (error) { console.log(`–û—à–∏–±–∫–∞:`, error) };
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

bot.command('setbotfilter', async (ctx) => {
  try {
    if (!await isAdmin(ctx.from.id)) {
      return ctx.reply('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.');
    }
    //console.log("1");
    let botSettings = await getUserSettings(0);
    //console.log("2");
    //let botFilter = botSettings && botSettings.botFilter ? botSettings.botFilter : ""; 
    //console.log('botFilter='+botFilter);
    let botFilter = prepareParam(ctx);//ctx.message.text.split(' ')[1];
    if (!botFilter || botFilter === undefined || botFilter.lenght == 0 || botFilter.join('') == '') {
      botSettings = await getUserSettings(0);
      botFilter = botSettings && botSettings.botFilter != undefined ? botSettings.botFilter : [];
      return ctx.reply('–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞.\n–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: ' + botFilter.join(', '));
    }
    console.log('botFilter=' + botFilter.join(', '));
    await updateUserSettings(0, { botFilter: botFilter });
    //console.log('botFilter1');
    //console.log('botFilter='+botFilter);
    botSettings = await getUserSettings(0);
    botFilter = botSettings && botSettings.botFilter ? botSettings.botFilter : [];
    ctx.reply(`–§–∏–ª—å—Ç—Ä —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.\n–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: ${botFilter.join(', ')}.`);
  } catch (error) { console.log(`–û—à–∏–±–∫–∞:`, error) };
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ /unban <userID>
bot.command('unban', async (ctx) => {
  try {
    if (!await isAdmin(ctx.from.id)) {
      return ctx.reply('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.');
    }

    const userId = ctx.message.text.split(' ')[1];
    await unbanUser(userId); // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ db.js
    ctx.reply(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID ${userId} —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.`);
  } catch (error) { console.log(`–û—à–∏–±–∫–∞:`, error) };
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

function isValidTimeRange(timeRange) {
  // –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∞
  const timePattern = /^\d{2}:\d{2}-\d{2}:\d{2}$/;

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ —Å—Ç—Ä–æ–∫–∞ –ø–∞—Ç—Ç–µ—Ä–Ω—É
  if (!timePattern.test(timeRange)) {
    return false;
  }

  // –†–∞–∑–¥–µ–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –Ω–∞ –Ω–∞—á–∞–ª–æ –∏ –∫–æ–Ω–µ—Ü
  const [startTime, endTime] = timeRange.split('-');

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –≤—Ä–µ–º–µ–Ω–∏ (—á–∞—Å—ã –æ—Ç 00 –¥–æ 23, –º–∏–Ω—É—Ç—ã –æ—Ç 00 –¥–æ 59)
  const isValidTime = (time) => {
    const [hours, minutes] = time.split(':').map(Number);
    return hours >= 0 && hours < 24 && minutes >= 0 && minutes < 60;
  };

  // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤—Ä–µ–º—è –≤ –º–∏–Ω—É—Ç—ã –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
  const timeToMinutes = (time) => {
    const [hours, minutes] = time.split(':').map(Number);
    return hours * 60 + minutes;
  };

  const start = timeToMinutes(startTime);
  const end = timeToMinutes(endTime);

  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º true, –µ—Å–ª–∏ –≤—Ä–µ–º–µ–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
  return isValidTime(startTime) && isValidTime(endTime);
}


/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

async function sleepTime(ctx) { //—Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ —Å–Ω–∞
  try {
    const userId = getUserID(ctx);
    userContexts[userId] = ctx; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    let userSettings = await getUserSettings(userId);

    const sleepTime = ctx.message.text.split(' ')[1];

    const curSleepTime = userSettings && userSettings.sleepTime && userSettings.sleepTime !== undefined ? userSettings.sleepTime : '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';

    if (sleepTime == undefined || sleepTime.trim() == '') {
      return ctx.reply(`–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤—Ä–µ–º—è —Å–Ω–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ /sp <hh:mm-hh2:mm2>, –Ω–∞–ø—Ä–∏–º–µ—Ä: /sp 23:00-09:00, –ª–∏–±–æ /sp 0 –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞.\n–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: ${curSleepTime}`);
    }
    else if (sleepTime.trim() == '0') {
      await updateUserSettings(userId, { sleepTime: '' });
      ctx.reply(`–í—Ä–µ–º—è —Å–Ω–∞ –æ—Ç–∫–ª—é—á–µ–Ω–æ`);
    }
    else if (!isValidTimeRange(sleepTime)) {
      return ctx.reply(`–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤—Ä–µ–º—è —Å–Ω–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ /sp <hh:mm-hh2:mm2>, –Ω–∞–ø—Ä–∏–º–µ—Ä: /sp 23:00-09:00, –ª–∏–±–æ /sp 0 –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞\n–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: ${curSleepTime}`);
    }
    else {
      await updateUserSettings(userId, { sleepTime });
      ctx.reply(`–í—Ä–µ–º—è —Å–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: ${sleepTime}`);
    }



  } catch (error) { console.log(`–û—à–∏–±–∫–∞:`, error) };
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ —Å–Ω–∞
bot.command('sleeptime', async (ctx) => {
  try {
    await sleepTime(ctx);
  } catch (error) { console.log(`–û—à–∏–±–∫–∞:`, error) };
});

bot.command('st', async (ctx) => {
  try {
    await sleepTime(ctx);
  } catch (error) { console.log(`–û—à–∏–±–∫–∞:`, error) };
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

async function refreshPlayers(userId, searchFor, game, msgIdToDel, skipStatusMsg, forceUpdate) {
  let wasFinded = false;
  try {
    log('refreshPlayers, ', msgIdToDel);
    if (typeof searchFor === 'undefined') {
      searchFor = ''; // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ searchFor –Ω–µ —É–∫–∞–∑–∞–Ω
    }
    //console.log('searchFor = ' + searchFor);
    searchFor = normalName(searchFor);//.trim());

    let canPostNotFinded = true;
    if (searchFor == undefined || searchFor == '') canPostNotFinded = false;

    if (typeof game === 'undefined') {
      game = config.DEFAULT_GAME;
    }
    //console.log('game = ' + game);
    game = game.trim();

    if (typeof msgIdToDel === 'undefined') {
      msgIdToDel = '0'; // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ msgIdToDel –Ω–µ —É–∫–∞–∑–∞–Ω
    }

    if (typeof skipStatusMsg === 'undefined') {
      skipStatusMsg = false; // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ skipStatusMsg –Ω–µ —É–∫–∞–∑–∞–Ω
    }

    if (typeof forceUpdate === 'undefined') {
      forceUpdate = false; // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ forceUpdate –Ω–µ —É–∫–∞–∑–∞–Ω
    }

    const userSettings = await getUserSettings(userId);

    if (searchFor === '' && (!userSettings || userSettings === undefined || userSettings.players === undefined)) {
      //const ctx = userContexts[userId];
      //return await bot.telegram.sendMessage(ctx.chat.id, '–í–Ω–∞—á–∞–ª–µ –≤–Ω–µ—Å–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ (/addplayer).');
      return;
    }

    let players;

    if (searchFor != '') {
      players = [];
      players[0] = searchFor;
    } else {
      players = userSettings ? userSettings.players : [];
    }

    const playersFilter = userSettings && userSettings.playersFilter != undefined ? userSettings.playersFilter : []; //–≥–ª–æ–±–∞–ª—å–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –∏–≥—Ä–æ–∫–∞
    const spFilter = userSettings && userSettings.spFilter != undefined ? userSettings.spFilter : []; //—Ñ–∏–ª—å—Ç—Ä —Å–µ—Ä–≤–µ—Ä - –∏–≥—Ä–æ–∫

    const chatId = userSettings ? userSettings.chatId : null; // –ü–æ–ª—É—á–∞–µ–º chatId –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const themeId = userSettings ? userSettings.themeId : null; // –ü–æ–ª—É—á–∞–µ–º themeId –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    //console.log('chatId = ' + userSettings.chatId + ', ' + players.join(', '));

    const isBanned = userSettings && userSettings.banned && userSettings.banned != undefined ? userSettings.banned : false;
    if (isBanned !== false) {
      if (!themeId) return await bot.telegram.sendMessage(chatId, '–í—ã –∑–∞–±–∞–Ω–µ–Ω—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.');
      else return await bot.telegram.sendMessage(chatId, '–í—ã –∑–∞–±–∞–Ω–µ–Ω—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.', { message_thread_id: themeId });
    }

    if (!chatId) {
      console.log('chatId –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ', userId);
      return;
    }

    if (searchFor === '' && (!players || players.length === 0)) {
      //console.log(`–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId} –Ω–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤.`);
      return; //bot.telegram.sendMessage(chatId, '–£ –≤–∞—Å –Ω–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ –¥–ª—è –æ—Å—É—â–µ—Å—Ç–≤–ª–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞.\n–î–æ–±–∞–≤—å—Ç–µ –∏–≥—Ä–æ–∫–æ–≤ —á–µ—Ä–µ–∑ –∫–æ–º–Ω–∞–¥—É /addplayer.\n–í–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –∫–æ–º–∞–Ω–¥–æ–π /help –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –±–æ—Ç–æ–º.');
    }

    const advmode = userSettings.advmode || 0;
    const altview = userSettings && userSettings.altview && userSettings.altview != undefined ? userSettings.altview : 0;
    const heuristic = userSettings && userSettings.heuristic && userSettings.heuristic != undefined ? userSettings.heuristic : 0;
    const minPS = userSettings && userSettings.minplayerscore != undefined ? userSettings.minplayerscore : 0;

    /*  if (advmode === undefined || advmode === 0) {
        Message += '\n–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º: –≤—ã–∫–ª—é—á–µ–Ω.';      
      } else {
        Message += '\n–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º: –≤–∫–ª—é—á—ë–Ω.';  
      }
    */
    //console.log('const serverList = await getServerListQ2(); - START');
    let serverList = '';
    //if (game == 'q2') serverList = await getServerListQ2();
    //else if (game == 'qw') serverList = await getServerListQW();

    /*
    if (searchFor == '') serverList = await getServerList(game);
    else serverList = await getServerListFromCache(game);
    */
    //serverList = await getServerList(game);
    serverList = await getServerListFromCache(game);
    //console.log('const serverList = await getServerListQ2(); - FINISH');

    // –ë–µ—Ä—ë–º —Å–Ω–∏–º–æ–∫ –∫—ç—à–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤ –¥–ª—è —Ç–µ–∫—É—â–µ–π –∏–≥—Ä—ã –Ω–∞ –º–æ–º–µ–Ω—Ç —Å—Ç–∞—Ä—Ç–∞ –ø–æ–∏—Å–∫–∞
    const cacheSnapshot = (typeof globalServerCache !== 'undefined' && globalServerCache[game])
      ? globalServerCache[game]
      : null;

    //const addedPlayers = [];
    let serverInfoString = "";
    let playersInfoString = "";
    let serverPlayersTmp;
    let foundPlayers = [];
    //console.log('–ê–Ω–∞–ª–∏–∑ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –ø–æ–ª—É—á–µ–Ω–Ω–æ–π –∏–∑ —Å–µ—Ä–≤–µ—Ä–æ–≤...');
    const promises = serverList.map(async (server) => {
      const [ip, port] = server.split(':');
      try {
        //console.log('const { players: serverPlayers, serverInfo } = await queryServerQ2(ip, port); - START');
        let serverPlayers;
        let serverInfo;
        /*if (game == 'q2') {
          ({ players: serverPlayers, serverInfo } = await queryServerQ2(ip, port));
        } else if (game == 'qw') {
          ({ players: serverPlayers, serverInfo } = await queryServerQW(ip, port));
        }*/

        /*
        if (searchFor == '') {
          ({ serverPlayers, serverInfo } = await queryServer(game, ip, port));
        }
        else {
          ({ serverPlayers, serverInfo } = await queryServerDirect(game, ip, port));
        }
        */
        //({ serverPlayers, serverInfo } = await queryServer(game, ip, port));

        // - 29.11.2025 ({ serverPlayers, serverInfo } = await queryServerDirect(game, ip, port));

        // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –≤–∑—è—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –∫—ç—à–∞,
        // –µ—Å–ª–∏ –Ω–µ—Ç –∑–∞–ø–∏—Å–∏ ‚Äî –¥–µ–ª–∞–µ–º –∂–∏–≤–æ–π –∑–∞–ø—Ä–æ—Å, –∫–∞–∫ —Ä–∞–Ω—å—à–µ.
        const cacheKey = `${ip}:${port}`;
        const cacheEntry = cacheSnapshot ? cacheSnapshot[cacheKey] : null;

        if (cacheEntry) {
          serverPlayers = Array.isArray(cacheEntry.serverPlayers) ? cacheEntry.serverPlayers : [];
          serverInfo = cacheEntry.serverInfo || {};
        } else {
          ({ serverPlayers, serverInfo } = await queryServerDirect(game, ip, port));
        }

        serverPlayersTmp = serverPlayers.map(item => ({ ...item }));
        serverPlayers.forEach(p => {
          if (p && p.name != undefined) {

            let isMPSFiltered = false;
            if (searchFor == '') {
              if (minPS > 0 && (isNaN(p.score) || parseInt(p.score) < minPS)) isMPSFiltered = true;
              else if (minPS < 0 && (isNaN(p.score) || parseInt(p.score) == 0 || parseInt(p.score) < minPS)) isMPSFiltered = true;
            }

            let isSPFiltered = false;

            if (!isMPSFiltered) {
              for (i = 0; i < spFilter.length; i++) {
                //let cur = server + `\\` + normalName(p.name);
                const sp = spFilter[i].split('\\');
                if (matchServer(sp[0], server) && matchPlayer(sp[1], normalName(p.name.toLowerCase()))) {
                  isSPFiltered = true;
                  break;
                }
              }
            }

            if (isMPSFiltered) {
              // –ø—Ä–æ–ø—É—Å–∫ - –∏–≥—Ä–æ–∫ –ø—Ä–æ—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω –ø–æ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Ñ—Ä–∞–≥–æ–≤!  
              log('–°—Ä–∞–±–æ—Ç–∞–ª —Ñ–∏–ª—å—Ç—Ä –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—á–∫–æ–≤ –∏–≥—Ä–æ–∫–∞');
            }
            else if (playersFilter.some(player => matchPlayer(player, normalName(p.name.toLowerCase())))) {
              // –ø—Ä–æ–ø—É—Å–∫ - –∏–≥—Ä–æ–∫ –ø—Ä–æ—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω –≥–ª–æ–±–∞–ª—å–Ω–æ!  
              log('–°—Ä–∞–±–æ—Ç–∞–ª —Ñ–∏–ª—å—Ç—Ä –∏–≥—Ä–æ–∫–∞');
            }
            else if (isSPFiltered) {
              // –ø—Ä–æ–ø—É—Å–∫ - –∏–≥—Ä–æ–∫ –ø—Ä–æ—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ!  
              log('–°—Ä–∞–±–æ—Ç–∞–ª —Ñ–∏–ª—å—Ç—Ä —Å–µ—Ä–≤–µ—Ä - –∏–≥—Ä–æ–∫', spFilter);
            }
            else if (foundPlayers.some(foundPlayer => foundPlayer.name === normalName(p.name) && (foundPlayer.server === serverInfo['serverIp'] + ":" + serverInfo['serverPort']))) {
              // –ø—Ä–æ–ø—É—Å–∫ - –∏–≥—Ä–æ–∫ —É–∂–µ –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ —ç—Ç–æ–º —Å–µ—Ä–≤–µ—Ä–µ!   
              log('–ò–≥—Ä–æ–∫ —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ –∏–º–µ–µ—Ç—Å—è –Ω–∞ —ç—Ç–æ–º —Å–µ—Ä–≤–µ—Ä–µ, –≤—Ç–æ—Ä–æ–π —Ä–∞–∑ –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º: ' + normalName(p.name));
            }
            else if (players.some(player => matchPlayer(formatName(normalName(player)), formatName(normalName(p.name.toLowerCase()))))) {
              log('–ù–∞–π–¥–µ–Ω –∏–≥—Ä–æ–∫ ' + p.name);
              //console.log(serverInfo);

              let heuristicCanAddPlayer = true;
              if (heuristic == 1) {
                const previousScores = heuristicHistoryScores[userId + server + normalName(p.name)] && heuristicHistoryScores[userId + server + normalName(p.name)] != undefined ? heuristicHistoryScores[userId + server + normalName(p.name)] : 0;

                let scoresSum = 0;
                for (i = 0; i < serverPlayers.length; i++) {
                  try {
                    let ss = parseInt(serverPlayers[i].score);
                    if (isNaN(ss)) ss = 0;
                    scoresSum += ss;
                  }
                  catch (error) { };
                }
                log('forceUpdate=', forceUpdate);
                //if (previousScores == 0) { //–ø–æ–∫–∞ –æ—Å—Ç–∞–≤–∏–º —ç–≤—Ä–∏—Å—Ç–∏–∫—É —Ä–∞–±–æ—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç–≤—Ä–∏—Å—Ç–∏–∫–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–µ—Ä–≤—ã–π —Ä–∞–∑ –∏–ª–∏ —É –≤ —ç–≤—Ä–∏—Å—Ç–∏–∫–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ, —á—Ç–æ —É –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤ 0 —Ñ—Ä–∞–≥–æ–≤ 
                if (!forceUpdate && previousScores == scoresSum) {
                  heuristicCanAddPlayer = false;
                }
                //}
                if (serverPlayers.length > 0) { //–û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∏–≥—Ä–æ–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
                  heuristicHistoryScores[userId + server + normalName(p.name)] = scoresSum;
                }
              }

              if (heuristicCanAddPlayer) {

                if (advmode > 1 && serverInfoString === '') {  // –µ—Å–ª–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º = 2 –∏–ª–∏ 3 —Ç–æ –≤–∫–ª—é—á–∞–µ–º –¥–æ–ø –∏–Ω—Ñ—É –æ —Å–µ—Ä–≤–µ—Ä–µ
                  for (const key in serverInfo) {
                    serverInfoString += `${key}: ${serverInfo[key]}, `;
                  }

                  // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ª–∏—à–Ω–µ–≥–æ –ø—Ä–æ–±–µ–ª–∞ –∏ –∑–∞–ø—è—Ç–æ–π
                  serverInfoString = '\n<b>–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –°–ï–†–í–ï–†–ï</b>\n' + normalNameHard(serverInfoString.slice(0, -2));
                  //console.log(serverInfoString);
                }
                log('–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–Ω—Ñ—ã –æ–± –∏–≥—Ä–æ–∫–∞—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.');
                //console.log(serverPlayers);
                if (advmode === 1 || advmode === 3) {  // –µ—Å–ª–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º = 1 –∏–ª–∏ 3 —Ç–æ –≤–∫–ª—é—á–∞–µ–º –¥–æ–ø –∏–Ω—Ñ—É –æ–± –∏–≥—Ä–æ–∫–∞—Ö
                  if (advmode === 1) playersInfoString = '\n<b>–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û–ë –ò–ì–†–û–ö–ê–•</b>\n';
                  else playersInfoString = '\n\n<b>–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û–ë –ò–ì–†–û–ö–ê–•</b>\n'; // –¥–æ–±–∞–≤–ª—è–µ–º –µ—â–µ –æ–¥–∏–Ω –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏ –µ—Å–ª–∏ —Å–≤–µ—Ä—Ö—É –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∏–Ω—Ñ–∞ –æ —Å–µ—Ä–≤–µ—Ä–µ

                  //serverPlayersTmp.sort((a, b) => b.score - a.score); //—Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Å—á—ë—Ç—É
                  serverPlayersTmp.sort((a, b) => {
                    // –°–Ω–∞—á–∞–ª–∞ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º, –µ—Å–ª–∏ –æ–±–∞ score - —á–∏—Å–ª–∞
                    if (!isNaN(a.score) && !isNaN(b.score)) {
                      return parseInt(b.score, 10) - parseInt(a.score, 10); // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —É–±—ã–≤–∞–Ω–∏—é —á–∏—Å–µ–ª
                    } else if (!isNaN(a.score) && isNaN(b.score)) {
                      return -1; // –ß–∏—Å–ª–æ –±–æ–ª—å—à–µ, —á–µ–º Spectator
                    } else if (isNaN(a.score) && !isNaN(b.score)) {
                      return 1; // Spectator –º–µ–Ω—å—à–µ, —á–µ–º —á–∏—Å–ª–æ
                    } else {
                      return 0; // –û–±–∞ Spectator - –Ω–µ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º
                    }
                  });
                  //console.log(serverPlayersTmp);
                  log('altview=', altview);
                  serverPlayersTmp.forEach(player => {
                    if (altview == 0) {
                      playersInfoString += `\n <a href='https://www.gametracker.com/player/${normalNameHard(player.name).trim()}/${serverInfo['serverIp'] + ":" + serverInfo['serverPort']}/'>üîç</a> ${normalNameHard(player.name)}`;
                      playersInfoString += `\n –°—á–µ—Ç: ${player.score}`;
                      playersInfoString += `\n –ü–∏–Ω–≥: ${player.ping}`;
                      playersInfoString += `\n -------------------`;
                    }
                    else {
                      playersInfoString += `\n ${player.score}  | ${normalName(player.name)} [${player.ping}]`;
                    }
                  });
                  //console.log(serverInfoString);
                  //console.log(serverPlayersTmp);
                  //console.log(serverPlayers);
                }

                log('–ó–∞–ø–∏—Å—å –∏–Ω—Ñ—ã –æ –Ω–∞–π–¥–µ–Ω–Ω–æ–º –∏–≥—Ä–æ–∫–µ.');
                foundPlayers.push({
                  name: normalName(p.name),
                  nameFormatted: formatName(p.name),
                  ping: p.ping,
                  server: serverInfo['serverIp'] + ":" + serverInfo['serverPort'],
                  host: serverInfo['hostname'],
                  map: serverInfo['mapname'] && serverInfo['mapname'] != undefined ? serverInfo['mapname'] : '–Ω–µ—Ç (QTV/GTV/Specs room)',
                  serverInfo: serverInfoString,
                  playersInfo: playersInfoString,
                  playersList: serverPlayers.map(player => player.name).join(', ')
                });
                serverInfoString = "";
                //console.log(foundPlayers);
              }
              else {
                log('–ü—Ä–æ–ø—É—Å–∫ –ø–æ —ç–≤—Ä–∏—Å—Ç–∏–∫–µ:', server + ' -> ' + normalName(p.name));
              }
            }
          }
        });
      } catch (error) {
        //log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –∏–≥—Ä–æ–∫–∞ ${searchFor} - ${server}`, error);
      }
    });

    // –ñ–¥–µ–º, –ø–æ–∫–∞ –≤—Å–µ –ø—Ä–æ–º–∏—Å—ã –∑–∞–≤–µ—Ä—à–∞—Ç—Å—è
    await Promise.allSettled(promises);

    log('foundPlayers.length=', foundPlayers.length);
    if (foundPlayers.length === 0) {
      //return bot.telegram.sendMessage(chatId, '–ò–≥—Ä–æ–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.');
    }

    let players2 = userSettings ? userSettings.players : [];
    let keyboard;
    let advcontrols = userSettings && userSettings.advcontrols && userSettings.advcontrols != undefined ? userSettings.advcontrols : 0;
    let autodelhistory = userSettings && userSettings.autodelhistory && userSettings.autodelhistory != undefined ? userSettings.autodelhistory : 0;
    let messageCount = 0;
    let messageCountAll = 0;
    const messagesPerSecond = config.MAX_MESSAGES_PER_SECOND;
    let serversAddCDF = ''; let serversDelCDF = ''; let serversUpdateCDF = ''; serversSearchMapCDF = ''; //–¥–ª—è —É–∫–∞–∑–∞–Ω–∏—è Callback —Ñ—É–Ω–∫—Ü–∏–∏-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∫–Ω–æ–ø–æ—Ö —Ç–µ–ª–µ–≥–∏
    let servers;
    let gameName;
    if (game == 'q2') {
      //console.log('game - q2');
      servers = userSettings && userSettings.q2servers ? userSettings.q2servers : [];
      serversAddCDF = 'addserverq2_';
      serversDelCDF = 'delserverq2_';
      serversUpdateCDF = 'updateserverq2_';
      serversSearchMapCDF = 'searchmapq2_';
      gameName = 'Quake II';
    }
    else if (game == 'qw') {
      //console.log('game - qw');
      servers = userSettings && userSettings.qwservers ? userSettings.qwservers : [];
      serversAddCDF = 'addserverqw_';
      serversDelCDF = 'delserverqw_';
      serversUpdateCDF = 'updateserverqw_';
      serversSearchMapCDF = 'sesearchmapqw_';
      gameName = 'QuakeWorld';

    }
    //console.log('–°—Ç–∞—Ä—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ —Ä–∞—Å—Å—ã–ª–∫–∏ –ø–æ –Ω–∞–π–¥–µ–Ω–Ω—ã–º –∏–≥—Ä–æ–∫–∞–º.');
    //foundPlayers.forEach(async (foundPlayer) => {
    for (i = 0; i < foundPlayers.length; i++) {
      //console.log('Sendmessage, playersInfoString='+playersInfoString);
      let foundPlayer = foundPlayers[i];
      log('foundPlayer=', foundPlayer);
      const q2ServerURL = `<a href='https://www.gametracker.com/server_info/${foundPlayer.server}/'>üîç</a> ${foundPlayer.server} `;
      const gameTrackerURL = `<a href='https://www.gametracker.com/player/${foundPlayer.name}/${foundPlayer.server}/'>GameTracker</a>`;
      let q2ServersURL;
      if (game == 'q2') {
        q2ServersURL = `<a href='http://q2servers.com/?mod=*&g=*&m=*&c=ru&ac=*&s=pd&player=${foundPlayer.name}&action=Search'>q2servers</a>`;
      }
      else if (game == 'qw') {
        q2ServersURL = ``;
      }

      let foundPlayer2 = includesPlayer(players2, foundPlayer.nameFormatted);
      let foundServer = includesServer(servers, foundPlayer.server);
      foundServer = foundServer === '' ? includesServer(servers, foundPlayer.server) : foundServer;
      //console.log('foundPlayer2=' + foundPlayer2);
      //console.log('nameOriginal=',foundPlayer.nameFormatted);

      if (advcontrols) {
        keyboard = {
          inline_keyboard: [
            [
              // { text: `–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å IP, url: 'https://t.me/share/url?url=${foundPlayer.server}'`},
              { text: `–û–±–Ω–æ–≤–∏—Ç—å –∏–≥—Ä–æ–∫–∞`, callback_data: `updatePlayer_${game + '<<<<gameplayer>>>>' + foundPlayer.name}` },
              { text: `–û–±–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä`, callback_data: `${serversUpdateCDF}${foundPlayer.server}` },
            ]
          ]
        };

        let monitoringInlineKeyboard = [];


        if (foundPlayer2 && foundPlayer2.trim() != '') {
          monitoringInlineKeyboard.push({ text: `–ù–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∏–≥—Ä–æ–∫–∞`, callback_data: `delPlayer_${foundPlayer2}` });
        } else {
          monitoringInlineKeyboard.push({ text: `–û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∏–≥—Ä–æ–∫–∞`, callback_data: `addPlayer_${foundPlayer.name}` });
        }
        if (foundServer && foundServer.trim() != '') {
          monitoringInlineKeyboard.push({ text: `–ù–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å–µ—Ä–≤–µ—Ä`, callback_data: `${serversDelCDF}${foundPlayer.server}` });
        } else {
          monitoringInlineKeyboard.push({ text: `–û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å–µ—Ä–≤–µ—Ä`, callback_data: `${serversAddCDF}${foundPlayer.server}` });
        }
        keyboard.inline_keyboard.push(monitoringInlineKeyboard);

        let filterInlineKeyboard = [];
        filterInlineKeyboard.push({ text: `–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–≥—Ä–æ–∫–∞ ${foundPlayer.name} –Ω–∞ —ç—Ç–æ–π —ç—Ç–æ–º —Å–µ—Ä–≤–µ—Ä–µ`, callback_data: `addSPFilter_${foundPlayer.server + '\\' + foundPlayer.name}` });
        keyboard.inline_keyboard.push(filterInlineKeyboard);

        let mapInlineKeyboard = [];
        mapInlineKeyboard.push({ text: `–ù–∞–π—Ç–∏ –≤—Å–µ –º–∞—Ç—á–∏ –Ω–∞ –∫–∞—Ä—Ç–µ ${foundPlayer.map}`, callback_data: `${serversSearchMapCDF}${foundPlayer.map}` });
        keyboard.inline_keyboard.push(mapInlineKeyboard);

      }

      let message;
      if (altview == 0) {
        message = `–ò–≥—Ä–æ–∫ ${foundPlayer.name} (–ø–∏–Ω–≥: ${foundPlayer.ping}) –Ω–∞–π–¥–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.
–ò–≥—Ä–∞: <b>${gameName}</b>
–°–µ—Ä–≤–µ—Ä: ${q2ServerURL}
–ù–∞–∑–≤–∞–Ω–∏–µ: ${foundPlayer.host}
–ö–∞—Ä—Ç–∞: <b>${foundPlayer.map}</b>
–ò–≥—Ä–æ–∫–∏: ${normalNameHard(foundPlayer.playersList)}
–°—Å—ã–ª–∫–∏: ${q2ServersURL} ${gameTrackerURL}
${foundPlayer.serverInfo + foundPlayer.playersInfo}`;
      }
      else {
        message = `–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –∏–≥—Ä–æ–∫—É <b>${foundPlayer.name}</b> [${foundPlayer.ping}] –≤ –∏–≥—Ä–µ <b>${gameName}</b> –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: ${q2ServerURL}
–ù–∞–∑–≤–∞–Ω–∏–µ: ${foundPlayer.host}
–ö–∞—Ä—Ç–∞: <b>${foundPlayer.map}</b>
–ò–≥—Ä–æ–∫–∏: ${normalName(foundPlayer.playersList)}
${foundPlayer.serverInfo + foundPlayer.playersInfo}`;
      }

      //const message = `–ò–≥—Ä–æ–∫ ${foundPlayer.name} (–ø–∏–Ω–≥: ${foundPlayer.ping}) –Ω–∞–π–¥–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ`;
      let previousMessageId;
      let previousMessageIdIndex;
      const chunks = message.match(/(.|[\n\r]){1,4096}/g);
      for (const chunk of chunks) {
        // console.log(chunk);
        try {
          //console.log(chunk);
          let sentMessage;

          if (!themeId) {
            if (advcontrols) sentMessage = await bot.telegram.sendMessage(chatId, chunk, { parse_mode: 'HTML', reply_markup: { inline_keyboard: keyboard.inline_keyboard, resize_keyboard: true } });
            else sentMessage = await bot.telegram.sendMessage(chatId, chunk, { parse_mode: 'HTML' });
          }
          else {
            if (advcontrols) sentMessage = await bot.telegram.sendMessage(chatId, chunk, { message_thread_id: themeId, parse_mode: 'HTML', reply_markup: { inline_keyboard: keyboard.inline_keyboard, resize_keyboard: true } });
            else sentMessage = await bot.telegram.sendMessage(chatId, chunk, { message_thread_id: themeId, parse_mode: 'HTML' });
          }

          if (autoDelHistory) {
            previousMessageIdIndex = !themeId ? String(userId) + String(chatId) + foundPlayer.server + foundPlayer.name + searchFor : String(userId) + String(chatId) + String(themeId) + foundPlayer.server + foundPlayer.name + searchFor;
            previousMessageId = messageIds[previousMessageIdIndex];
          }

          if (autodelhistory == 1 && previousMessageId) {
            try {
              if (!themeId) await bot.telegram.deleteMessage(chatId, previousMessageId);
              else await bot.telegram.deleteMessage(chatId, previousMessageId, { message_thread_id: themeId });
            } catch (error) {
              console.log('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:', error);
            }
          }

          // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
          if (autodelhistory == 1) messageIds[foundPlayer.server + foundPlayer.name] = sentMessage.message_id;
          wasFinded = true;

        }
        catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error) };
        messageCount++;
        //  –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Å–µ–∫—É–Ω–¥—É
        if (messageCount >= messagesPerSecond) {

          console.log(`–ü–∞—É–∑–∞ –Ω–∞ ${config.SLEEP_TIME} —Å–µ–∫—É–Ω–¥`);
          if (!themeId) await bot.telegram.sendMessage(chatId, `–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä—É—é –≤—ã —Ö–æ—Ç–∏—Ç–µ –Ω–∞–π—Ç–∏.\n–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏ –Ω–∞–π–¥–µ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ ${config.SLEEP_TIME / 1000} —Å–µ–∫—É–Ω–¥(—ã)...`);
          else await bot.telegram.sendMessage(chatId, `–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä—É—é –≤—ã —Ö–æ—Ç–∏—Ç–µ –Ω–∞–π—Ç–∏.\n–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏ –Ω–∞–π–¥–µ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ ${config.SLEEP_TIME / 1000} —Å–µ–∫—É–Ω–¥(—ã)...`, { message_thread_id: themeId });
          await sleep(config.SLEEP_TIME);
          //setTimeout(sendNextMessage, pauseInterval);

          messageCount = 0;
        }
        messageCountAll++;
        if (messageCountAll >= config.MAX_MESSAGES_PER_SEARCH) {
          try {
            if (!themeId) return await bot.telegram.sendMessage(chatId, "–ü—Ä–µ–≤—ã—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ä–∞–º–∫–∞—Ö —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–∏—Å–∫–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä—É—é –≤—ã —Ö–æ—Ç–∏—Ç–µ –Ω–∞–π—Ç–∏.");
            else return await bot.telegram.sendMessage(chatId, "–ü—Ä–µ–≤—ã—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ä–∞–º–∫–∞—Ö —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–∏—Å–∫–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä—É—é –≤—ã —Ö–æ—Ç–∏—Ç–µ –Ω–∞–π—Ç–∏.", { message_thread_id: themeId });
          } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error) };
        }
      }
    };
    if (msgIdToDel && msgIdToDel != undefined && msgIdToDel != 0) {// && autodelhistory == 1) {
      try {
        if (!themeId) await bot.telegram.deleteMessage(chatId, msgIdToDel);
        else await bot.telegram.deleteMessage(chatId, msgIdToDel, { message_thread_id: themeId });
      } catch (error) {
        //console.log('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:', error);
      }
    }
    if (!skipStatusMsg && !wasFinded && canPostNotFinded) {
      if (!themeId) await bot.telegram.sendMessage(chatId, `–ò–≥—Ä–æ–∫–∞ ${searchFor} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞—Ö –≤ –∏–≥—Ä–µ <b>${gameName}</b>`, { parse_mode: 'HTML' });
      else await bot.telegram.sendMessage(chatId, `–ò–≥—Ä–æ–∫–∞ ${searchFor} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞—Ö –≤ –∏–≥—Ä–µ <b>${gameName}</b>`, { message_thread_id: themeId, parse_mode: 'HTML' });
    }
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error) };
  return wasFinded;
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

function checkMap(mapsArray, mapToCheck) {
  // –ü—Ä–∏–≤–æ–¥–∏–º —Å—Ç—Ä–æ–∫—É mapToCheck –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
  mapToCheck = mapToCheck.toLowerCase();

  // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –º–∞—Å—Å–∏–≤—É mapsArray
  for (let i = 0; i < mapsArray.length; i++) {
    let map = mapsArray[i].toLowerCase();

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤ mapToCheck –ø–æ–¥—Å—Ç—Ä–æ–∫–∞, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∞—è map
    if (
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–≤–ø–∞–¥–∞–µ—Ç –ª–∏ mapToCheck —Å map, –∏–≥–Ω–æ—Ä–∏—Ä—É—è –∑–≤–µ–∑–¥–æ—á–∫–∏ –≤ map
      (map.startsWith('*') && map.endsWith('*') && mapToCheck.includes(map.slice(1, -1))) ||
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ª–∏ mapToCheck —Å map, –∏–≥–Ω–æ—Ä–∏—Ä—É—è –∑–≤–µ–∑–¥–æ—á–∫—É –≤ –Ω–∞—á–∞–ª–µ map
      (map.startsWith('*') && mapToCheck.endsWith(map.slice(1))) ||
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –ª–∏ mapToCheck map, –∏–≥–Ω–æ—Ä–∏—Ä—É—è –∑–≤–µ–∑–¥–æ—á–∫—É –≤ –∫–æ–Ω—Ü–µ map
      (map.endsWith('*') && mapToCheck.startsWith(map.slice(0, -1))) ||
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–≤–ø–∞–¥–∞–µ—Ç –ª–∏ mapToCheck —Å map –ø–æ–ª–Ω–æ—Å—Ç—å—é
      (mapToCheck === map)
    ) {
      return mapToCheck; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º mapToCheck, –µ—Å–ª–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–∞–π–¥–µ–Ω–æ
    }
  }

  // –ï—Å–ª–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º null
  return false;
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

function formatTimeDiff(ms) {
  const totalSec = Math.floor(ms / 1000);
  const min = Math.floor(totalSec / 60);
  const sec = totalSec % 60;
  return `${min}:${sec.toString().padStart(2, '0')}`;
}

function isActiveScore(score) {
  if (typeof score === 'string') {
    const s = score.trim().toLowerCase();
    if (s === 'spectator' || s === 'spec') return false;
  }
  const n = parseInt(score);
  if (isNaN(n)) return false;
  // –∞–∫—Ç–∏–≤–Ω—ã–º —Å—á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ-–Ω—É–ª–µ–≤–æ–π —á–∏—Å–ª–æ–≤–æ–π —Å—á—ë—Ç
  return n !== 0;
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

async function refreshServers(userId, serverToSearch, mapsToSearch, forceAllServersSearch, game, shortReport, msgIdToDel, skipStatusMsg, forceUpdate, anyToFind) {
  let wasFinded = false;
  try {
    log('serverToSearch=', serverToSearch);
    const userSettings = await getUserSettings(userId);
    const botSettings = await getUserSettings(0);
    let userServers;
    if (typeof serverToSearch === 'undefined') {
      serverToSearch = ''; // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ searchFor –Ω–µ —É–∫–∞–∑–∞–Ω
    }

    if (typeof mapsToSearch === 'undefined') {
      mapsToSearch = []; // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ mapsToSearch –Ω–µ —É–∫–∞–∑–∞–Ω
    }

    let canPostNotFinded = true;
    if ((serverToSearch == undefined || serverToSearch == '') && ((serverToSearch == undefined || mapsToSearch.length == 0))) canPostNotFinded = false;

    if (typeof forceAllServersSearch === 'undefined') {
      forceAllServersSearch = false; // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ forceAllServersSearch –Ω–µ —É–∫–∞–∑–∞–Ω
    }

    if (typeof game === 'undefined') {
      game = config.DEFAULT_GAME; // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ game –Ω–µ —É–∫–∞–∑–∞–Ω
    }

    if (typeof shortReport === 'undefined') {
      shortReport = false; // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ shortReport –Ω–µ —É–∫–∞–∑–∞–Ω
    }

    if (typeof msgIdToDel === 'undefined') {
      msgIdToDel = '0'; // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ msgIdToDel –Ω–µ —É–∫–∞–∑–∞–Ω
    }

    if (typeof skipStatusMsg === 'undefined') {
      skipStatusMsg = false; // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ skipStatusMsg –Ω–µ —É–∫–∞–∑–∞–Ω
    }

    if (typeof forceUpdate === 'undefined') {
      forceUpdate = false; // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ forceUpdate –Ω–µ —É–∫–∞–∑–∞–Ω
    }

    if (typeof anyToFind === 'undefined') {
      anyToFind = ''; // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ forceUpdate –Ω–µ —É–∫–∞–∑–∞–Ω
    }

    anyToFind = String(anyToFind).trim();

    serverToSearch = serverToSearch.trim();
    //mapsToSearch = mapsToSearch.trim();

    if (game == 'q2') userServers = !userSettings || userSettings === undefined || userSettings.q2servers === undefined ? [] : userSettings.q2servers;
    else if (game == 'qw') userServers = !userSettings || userSettings === undefined || userSettings.qwservers === undefined ? [] : userSettings.qwservers;

    if (mapsToSearch.length == 0) { //–µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞–ª–∏ –∫–∞—Ä—Ç—É(—ã) –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–µ, —Å–º–æ—Ç—Ä–∏–º –µ—Å—Ç—å –ª–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
      if (game == 'q2') mapsToSearch = userSettings.q2maps || [];
      else if (game == 'qw') mapsToSearch = userSettings.qwmaps || [];
    }

    if (mapsToSearch.length == 0 || mapsToSearch[0] == '') mapsToSearch[0] = '*';
    //console.log('mapsToSearch=' + mapsToSearch.join(','));

    if (game == 'q2' && serverToSearch === '' && mapsToSearch.length == 0 && userServers.length == 0) {
      const ctx = userContexts[userId];
      //return await bot.telegram.sendMessage(ctx.chat.id, '–î–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ —Å–µ—Ä–≤–µ—Ä–∞—Ö –≤–Ω–∞—á–∞–ª–µ –≤–Ω–µ—Å–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É /addserverq2.\n–í —Å–ª—É—á–∞–µ, –µ—Å–ª–∏ –≤–∞–º —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ–∏—Å–∫ –ø–æ –∏–≥—Ä–æ–∫–∞–º, –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–æ–º–∞–Ω–¥–∞–º–∏ /rp –∏ /sp');
      return;
    }
    else if (game == 'qw' && serverToSearch === '' && mapsToSearch.length == 0 && userServers.length == 0) {
      const ctx = userContexts[userId];
      //return await bot.telegram.sendMessage(ctx.chat.id, '–î–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ —Å–µ—Ä–≤–µ—Ä–∞—Ö –≤–Ω–∞—á–∞–ª–µ –≤–Ω–µ—Å–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É /addserverq2.\n–í —Å–ª—É—á–∞–µ, –µ—Å–ª–∏ –≤–∞–º —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ–∏—Å–∫ –ø–æ –∏–≥—Ä–æ–∫–∞–º, –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–æ–º–∞–Ω–¥–∞–º–∏ /rp –∏ /sp');
      return;
    }

    let servers;

    if (serverToSearch != '') {
      servers = [];
      servers[0] = serverToSearch;
    } else {
      servers = userServers;
    }

    if ((mapsToSearch.length > 0 && servers.length == 0) || forceAllServersSearch) { //–µ—Å–ª–∏ –∏—â–µ–º –∫–∞—Ä—Ç—ã –ø–æ –≤—Å–µ–º —Å–µ—Ä–≤–µ—Ä–∞–º
      // if (game == 'q2') servers = await getServerListQ2();
      // else if (game == 'qw') servers = await getServerListQW();
      //if (serverToSearch == '') servers = await getServerList(game);
      //else servers = await getServerListFromCache(game);
      servers = await getServerListFromCache(game);
    }

    // –ë–µ—Ä—ë–º —Å–Ω–∏–º–æ–∫ –∫—ç—à–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤ –¥–ª—è —Ç–µ–∫—É—â–µ–π –∏–≥—Ä—ã –Ω–∞ –º–æ–º–µ–Ω—Ç —Å—Ç–∞—Ä—Ç–∞ –ø–æ–∏—Å–∫–∞
    const cacheSnapshot = (typeof globalServerCache !== 'undefined' && globalServerCache[game])
      ? globalServerCache[game]
      : null;

    console.log(
      'refreshServers: game=', game,
      ', servers.length=', servers.length,
      ', cacheSnapshot size=',
      cacheSnapshot ? Object.keys(cacheSnapshot).length : 0
    );

    //console.log('servers list:', servers);


    //console.log('searchFor=' + servers.join(', '));

    const chatId = userSettings ? userSettings.chatId : null; // –ü–æ–ª—É—á–∞–µ–º chatId –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const themeId = userSettings ? userSettings.themeId : null; // –ü–æ–ª—É—á–∞–µ–º themeId –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    //const chatIdThemes = chatId.split('/');
    log('userId=' + userId + ', chatId=' + chatId);
    //console.log('chatId = ' + userSettings.chatId);

    const isBanned = userSettings && userSettings.banned && userSettings.banned != undefined ? userSettings.banned : false;
    if (isBanned !== false) {
      if (!themeId) return await bot.telegram.sendMessage(chatId, '–í—ã –∑–∞–±–∞–Ω–µ–Ω—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤.');
      else return await bot.telegram.sendMessage(chatId, '–í—ã –∑–∞–±–∞–Ω–µ–Ω—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.', { message_thread_id: themeId });
    }

    if (!chatId) {
      console.log('chatId –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ', userId);
      return;
    }

    if (serverToSearch === '' && (!servers || servers.length === 0)) {
      //console.log(`–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId} –Ω–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤.`);
      return; //bot.telegram.sendMessage(chatId, '–£ –≤–∞—Å –Ω–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.\n–î–æ–±–∞–≤—å—Ç–µ —Å–µ—Ä–≤–µ—Ä(–∞) —á–µ—Ä–µ–∑ –∫–æ–º–Ω–∞–¥—É /addserverq2 –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–∞–∑–æ–≤—ã–π –ø–æ–∏—Å–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤ –ø–æ –∫–æ–º–∞–Ω–¥–µ /ssq2.\n–ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–∏—Å–∫ —Ç–æ–ª—å–∫–æ –¥–ª—è –∏–≥—Ä–æ–∫–æ–≤, –ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –∫–æ–º–∞–Ω–¥–æ–π /rp –∏–ª–∏ /sp –¥–ª—è —Ä–∞–∑–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–∞.\n–í—ã —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç–µ –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–æ–º–∞–Ω–¥–æ–π /smq2 –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤ —Å –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–º–∏ –≤–∞—Å –∫–∞—Ä—Ç–∞–º–∏.\n–í–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –∫–æ–º–∞–Ω–¥–æ–π /help –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –±–æ—Ç–æ–º.');
    }

    //const advmode = userSettings.advmode || 0;
    const advmode = userSettings && userSettings.advmode != undefined ? userSettings.advmode : 0;
    const altview = userSettings && userSettings.altview && userSettings.altview != undefined ? userSettings.altview : 0;
    //const minPlayers = userSettings.minPlayers || 1;
    //const botFilter = userSettings.botFilter || 1;
    let minPlayers = userSettings && userSettings.minPlayers != undefined ? userSettings.minPlayers : 1;
    const heuristic = userSettings && userSettings.heuristic && userSettings.heuristic != undefined ? userSettings.heuristic : 0;
    let botFilter = userSettings && userSettings.botFilter != undefined ? userSettings.botFilter : 1;
    const botFilterPlayers = botSettings && botSettings.botFilter != undefined ? botSettings.botFilter : [];
    //console.log('minPlayers=' + minPlayers + ', botFilter=' + botFilter);
    const serverList = servers;
    const foundServers = [];
    const foundPlayers = [];
    let serverInfoString = "";
    let foundPlayer = "";
    let playersInfoString = "";
    let serverPlayersTmp;
    //console.log('–ê–Ω–∞–ª–∏–∑ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –ø–æ–ª—É—á–µ–Ω–Ω–æ–π –∏–∑ —Å–µ—Ä–≤–µ—Ä–æ–≤...');
    const promises = serverList.map(async (server) => {
      //console.log('Server: '+server);
      const [ip, port] = server.split(':');
      try {
        //const { players: serverPlayers, serverInfo } = await queryServerQ2(ip, port);
        let serverPlayers;
        let serverInfo;
        //queryServer
        /*
        if (serverToSearch == '') {
          ({ serverPlayers, serverInfo } = await queryServer(game, ip, port));
        }
        else {
          ({ serverPlayers, serverInfo } = await queryServerDirect(game, ip, port));
        }
        */
        // 29.11.2025 ({ serverPlayers, serverInfo } = await queryServerDirect(game, ip, port));

        // üëá —Å–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –≤–∑—è—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –∫—ç—à–∞ (—Å–Ω–∏–º–æ–∫ –Ω–∞ –º–æ–º–µ–Ω—Ç —Å—Ç–∞—Ä—Ç–∞ —Ñ—É–Ω–∫—Ü–∏–∏),
        // –µ—Å–ª–∏ –∑–∞–ø–∏—Å–∏ –Ω–µ—Ç ‚Äî –¥–µ–ª–∞–µ–º –∂–∏–≤–æ–π –∑–∞–ø—Ä–æ—Å, –∫–∞–∫ —Ä–∞–Ω—å—à–µ.
        const cacheKey = `${ip}:${port}`;
        const cacheEntry = cacheSnapshot ? cacheSnapshot[cacheKey] : null;

        if (!cacheEntry) {
          log('refreshServers: cache MISS for', cacheKey);
        } else {
          log('refreshServers: cache HIT for', cacheKey);
        }

        if (cacheEntry) {
          serverPlayers = Array.isArray(cacheEntry.serverPlayers) ? cacheEntry.serverPlayers : [];
          serverInfo = cacheEntry.serverInfo || {};
          log('–¥–∞–Ω–Ω—ã–µ –ø–æ —Å–µ—Ä–≤–µ—Ä–∞–º –ø–æ–ª—É—á–µ–Ω—ã –∏–∑ –∫—ç—à–∞');
        } else {
          ({ serverPlayers, serverInfo } = await queryServerDirect(game, ip, port));
          log('–¥–∞–Ω–Ω—ã–µ –ø–æ —Å–µ—Ä–≤–µ—Ä–∞–º –ø–æ–ª—É—á–µ–Ω—ã –Ω–∞–ø—Ä—è–º—É—é');
        }

        /*
        if (game == 'q2') {
          ({ players: serverPlayers, serverInfo } = await queryServerQ2(ip, port));
        } else if (game == 'qw') {
          ({ players: serverPlayers, serverInfo } = await queryServerQW(ip, port));
        }
        */
        //console.log(serverPlayers);
        // 29.11.2025 serverPlayersTmp = serverPlayers.map(item => ({ ...item }));

        // –ü–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–æ –∏–≥—Ä–æ–∫–∞–º (–≤ —Ç.—á. timeOnMap), –µ—Å–ª–∏ –æ–Ω–∏ –±—ã–ª–∏
        const previousPlayersScoresRaw =
          heuristicHistoryPlayersScores[userId + server] && heuristicHistoryPlayersScores[userId + server] != undefined
            ? heuristicHistoryPlayersScores[userId + server]
            : [];

        const previousPlayersSnapshot = Array.isArray(previousPlayersScoresRaw)
          ? previousPlayersScoresRaw.map(item => ({ ...item }))
          : [];

        // –°–ª–æ–≤–∞—Ä—å: –∏–º—è -> –ø—Ä–æ—à–ª—ã–π timeOnMap
        const previousTimeOnMapByName = new Map();
        for (const p of previousPlayersSnapshot) {
          if (p && typeof p.name === 'string' && p.timeOnMap !== undefined) {
            previousTimeOnMapByName.set(p.name, p.timeOnMap);
          }
        }

        // –ö–æ–ø–∏—Ä—É–µ–º –∏–≥—Ä–æ–∫–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞ –∏ –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –∏–º –ø—Ä–æ—à–ª—ã–π timeOnMap (–µ—Å–ª–∏ –±—ã–ª)
        serverPlayersTmp = serverPlayers.map(item => {
          const copy = { ...item };
          const prevTime = previousTimeOnMapByName.get(copy.name);
          if (prevTime !== undefined) {
            copy.timeOnMap = prevTime;
          }
          return copy;
        });


        if (advmode > 1 && serverInfoString === '') {  // –µ—Å–ª–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º = 2 –∏–ª–∏ 3 —Ç–æ –≤–∫–ª—é—á–∞–µ–º –¥–æ–ø –∏–Ω—Ñ—É –æ —Å–µ—Ä–≤–µ—Ä–µ
          for (const key in serverInfo) {
            serverInfoString += `${key}: ${serverInfo[key]}, `;
          }

          // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ª–∏—à–Ω–µ–≥–æ –ø—Ä–æ–±–µ–ª–∞ –∏ –∑–∞–ø—è—Ç–æ–π
          serverInfoString = '\n\n–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –°–ï–†–í–ï–†–ï:\n' + normalNameHard(serverInfoString.slice(0, -2));

          //console.log('serverInfoString='+serverInfoString);
        }

        if (advmode === 1 || advmode === 3) playersInfoString = '\n\n–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û–ë –ò–ì–†–û–ö–ê–•:\n';

        //console.log(`serverInfo['mapname'] = ${serverInfo['mapname']}`);

        let serverPlayersToFilterCount = 0;
        let mapInclude;
        const mapname = serverInfo['mapname'] ? serverInfo['mapname'] : "";
        mapInclude = mapsToSearch[0] == '*' ? true : checkMap(mapsToSearch, mapname);//mapToSearch != '' && serverInfo['mapname'] && (mapToSearch.toLowerCase() !== serverInfo['mapname'].trim().toLowerCase()) ? false : true;
        //log('server' + server + 'mapInclude:', mapInclude);
        const canAnyToFind = anyToFind == '' ? true : serverPlayers.some(player => escapeHtmlForTelegram(player.name.toLowerCase().trim()).includes(escapeHtmlForTelegram(anyToFind.toLowerCase().trim()))) || Object.values(serverInfo).some(value => escapeHtmlForTelegram(value.toLowerCase().trim()).includes(escapeHtmlForTelegram(anyToFind.toLowerCase().trim())));
        if (anyToFind != '') {
          botFilter = 0;
          minPlayers = 0;
          serverInfoString = '';
          for (const key in serverInfo) {
            serverInfoString += `${key}: ${serverInfo[key]}, `;
          }
        }
        if (canAnyToFind && mapInclude) {
          //console.log('containsTargetString');
          //console.log('anyToFind='+anyToFind);
          let heuristicCanAddServer = true;
          let previousPlayersScores = {};
          let canScoreDiffVisual = true;
          let newMatch = false;

          if (heuristic == 1 && shortReport != true) {
            const previousScores = heuristicHistoryScores[userId + server] && heuristicHistoryScores[userId + server] != undefined ? heuristicHistoryScores[userId + server] : 0;
            const previousPlayers = heuristicHistoryPlayers[userId + server] && heuristicHistoryPlayers[userId + server] != undefined ? heuristicHistoryPlayers[userId + server] : [];
            const previousMap = heuristicHistoryMaps[userId + server] && heuristicHistoryMaps[userId + server] != undefined ? heuristicHistoryMaps[userId + server] : '';

            previousPlayersScores = heuristicHistoryPlayersScores[userId + server] && heuristicHistoryPlayersScores[userId + server] != undefined ? heuristicHistoryPlayersScores[userId + server].map(item => ({ ...item })) : [];
            let scoresSum = 0;
            let playersSum = '';

            //log('serverPlayersTmp.length:', serverPlayersTmp.length);
            //log('serverPlayers.length:', serverPlayers.length);
            heuristicHistoryPlayersScores[userId + server] = serverPlayersTmp;

            for (i = 0; i < serverPlayersTmp.length; i++) {
              try {
                let ss = parseInt(serverPlayersTmp[i].score);
                if (isNaN(ss)) ss = 0;
                scoresSum += ss;
              }
              catch (error) { log(error) };
              try {
                playersSum += normalName(serverPlayersTmp[i].name);
              }
              catch (error) { log(error) };

            }

            //log('scoresSum:', scoresSum);
            //log('playersSum:', playersSum);

            const sptl = serverPlayersTmp && serverPlayersTmp.length && serverPlayersTmp.length > 0 ? serverPlayersTmp.length : 1;
            //if (previousScores == 0) { //–ø–æ–∫–∞ –æ—Å—Ç–∞–≤–∏–º —ç–≤—Ä–∏—Å—Ç–∏–∫—É —Ä–∞–±–æ—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç–≤—Ä–∏—Å—Ç–∏–∫–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–µ—Ä–≤—ã–π —Ä–∞–∑ –∏–ª–∏ —É –≤ —ç–≤—Ä–∏—Å—Ç–∏–∫–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ, —á—Ç–æ —É –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤ 0 —Ñ—Ä–∞–≥–æ–≤ 
            if (!forceUpdate && previousMap == mapname && (previousScores == scoresSum && previousPlayers == playersSum)) {
              heuristicCanAddServer = false;

            }
            //log('mapname=' + mapname + ', previousMap=' + previousMap + ', previousScores=' + previousScores + ', previousPlayers=' + previousPlayers);
            //}

            if (!forceUpdate && serverPlayersTmp.length > 0) { //–æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –µ—Å—Ç—å –∏–≥—Ä–æ–∫–∏ (TD: —É—á–µ—Å—Ç—å –¥–ª—è QW —Å–ø–µ–∫—Ç–∞—Ç–æ—Ä–æ–≤ (score=Spectator))
              heuristicHistoryScores[userId + server] = scoresSum;
              heuristicHistoryPlayers[userId + server] = playersSum;
              heuristicHistoryMaps[userId + server] = mapname;
              //log('–¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —ç–≤—Ä–∏—Å—Ç–∏–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.');
              //heuristicHistoryPlayersScores[userId + server] = serverPlayersTmp;
            }

            log('previousScores=' + previousScores + ', scoresSum=' + scoresSum + ', 3 * sptl=' + 3 * sptl);
            if (((previousScores - scoresSum) > 5 * sptl) || (previousMap != mapname)) {
              canScoreDiffVisual = false;
              if (scoresSum < 15 && serverPlayersTmp.length > 1) newMatch = true;
            }

            //log('heuristicCanAddServer=', heuristicCanAddServer);

          }

          if (heuristicCanAddServer) {
            //console.log(`mapToSearch=${mapToSearch}, serverInfo['mapname']=${serverInfo['mapname'].trim().toLowerCase()}, mapInclude=${mapInclude}`);
            //serverPlayersTmp.sort((a, b) => b.score - a.score); //—Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Å—á—ë—Ç—É
            serverPlayersTmp.sort((a, b) => {
              // –°–Ω–∞—á–∞–ª–∞ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º, –µ—Å–ª–∏ –æ–±–∞ score - —á–∏—Å–ª–∞
              if (!isNaN(a.score) && !isNaN(b.score)) {
                return parseInt(b.score, 10) - parseInt(a.score, 10); // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —É–±—ã–≤–∞–Ω–∏—é —á–∏—Å–µ–ª
              } else if (!isNaN(a.score) && isNaN(b.score)) {
                return -1; // –ß–∏—Å–ª–æ –±–æ–ª—å—à–µ, —á–µ–º Spectator
              } else if (isNaN(a.score) && !isNaN(b.score)) {
                return 1; // Spectator –º–µ–Ω—å—à–µ, —á–µ–º —á–∏—Å–ª–æ
              } else {
                return 0; // –û–±–∞ Spectator - –Ω–µ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º
              }
            });

            //serverPlayersTmp.sort((a, b) => b.score - a.score); //—Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Å—á—ë—Ç—É
            //console.log(serverPlayersTmp);

            if (newMatch) {
              playersInfoString = `\n\n ---------- –ù–æ–≤—ã–π –º–∞—Ç—á ----------` + playersInfoString;
              const matchStartTs = Date.now();
              serverPlayersTmp.forEach(player => {
                // –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ —É–∂–µ —Ä–µ–∞–ª—å–Ω–æ –∏–≥—Ä–∞–µ—Ç (—Å—á—ë—Ç –Ω–µ 0 –∏ –Ω–µ Spectator) ‚Äî —Å—Ç–∞—Ä—Ç—É–µ–º —Ç–∞–π–º–µ—Ä
                if (isActiveScore(player.score)) {
                  player.timeOnMap = matchStartTs;
                } else {
                  // —Å–ø–µ–∫—Ç–∞—Ç–æ—Ä / ¬´—Å–ø—è—â–∏–π¬ª –∏–≥—Ä–æ–∫ ‚Äî –≤—Ä–µ–º—è –Ω–µ —Å—á–∏—Ç–∞–µ–º
                  delete player.timeOnMap;
                }
              });
            }

            serverPlayersTmp.forEach(player => {
              if (advmode === 1 || advmode === 3) {  // –µ—Å–ª–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º = 1 –∏–ª–∏ 3 —Ç–æ –≤–∫–ª—é—á–∞–µ–º –¥–æ–ø –∏–Ω—Ñ—É –æ–± –∏–≥—Ä–æ–∫–∞—Ö
                let scoreDiff = 0;
                let scoreDiffVisual = '';
                if (heuristic != 0 && canScoreDiffVisual) {
                  //log('previousPlayersScores.length=', previousPlayersScores.length);
                  for (i = 0; i < previousPlayersScores.length; i++) {
                    const pps = previousPlayersScores[i];
                    //log('pps=', pps);
                    if (pps.name == player.name) {
                      const prevScoreNum = parseInt(pps.score);
                      const curScoreNum = parseInt(player.score);

                      const safePrev = isNaN(prevScoreNum) ? 0 : prevScoreNum;
                      const safeCur = isNaN(curScoreNum) ? 0 : curScoreNum;

                      scoreDiff = safeCur - safePrev;

                      // ‚ö° –ò–≥—Ä–æ–∫ –±—ã–ª –±–µ–∑ –≤—Ä–µ–º–µ–Ω–∏ –∏ –Ω–∞—á–∞–ª –∞–∫—Ç–∏–≤–Ω–æ –∏–≥—Ä–∞—Ç—å:
                      //   - —Ä–∞–Ω—å—à–µ —Å—á–∏—Ç–∞–ª—Å—è "–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–º" (0 / Spectator),
                      //   - —Å–µ–π—á–∞—Å –∞–∫—Ç–∏–≤–Ω—ã–π (score != 0 –∏ –Ω–µ Spectator),
                      //   - –∏ –µ—Å—Ç—å —Ä–µ–∞–ª—å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—á—ë—Ç–∞
                      if (player.timeOnMap === undefined && isActiveScore(player.score) && scoreDiff !== 0) {
                        // —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –≤–æ—à—ë–ª –≤ –∏–≥—Ä—É –ø—Ä–∏–º–µ—Ä–Ω–æ 10 —Å–µ–∫—É–Ω–¥ –Ω–∞–∑–∞–¥
                        player.timeOnMap = Date.now() - 10000;
                      }

                      if (scoreDiff < 0 && ((safeCur != 0) || (safeCur == 0 && scoreDiff >= -3))) { // –ª–æ–≤–∏–º –≤—ã—Ö–æ–¥ –≤ —Å–ø–µ–∫–∏
                        scoreDiffVisual = ' üîª' + scoreDiff.toString();
                      } else if (scoreDiff > 0) {
                        scoreDiffVisual = ' ‚¨Ü +' + scoreDiff.toString();
                      }

                      if (player.timeOnMap !== undefined) {
                        const elapsed = Date.now() - player.timeOnMap;
                        const timeFormatted = formatTimeDiff(elapsed);
                        scoreDiffVisual = ` ‚è±Ô∏è ${timeFormatted}` + scoreDiffVisual;
                      }

                      break;
                    }


                  }
                }
                if (altview == 0) {
                  playersInfoString += `\n <a href='https://www.gametracker.com/player/${normalNameHard(player.name).trim()}/${serverInfo['serverIp'] + ":" + serverInfo['serverPort']}/'>üîç</a> ${normalNameHard(player.name)}`;//`\n ${normalNameHard(player.name)}`;
                  playersInfoString += `\n –°—á—ë—Ç: ${player.score}${scoreDiffVisual}`;
                  playersInfoString += `\n –ü–∏–Ω–≥: ${player.ping}`;
                  playersInfoString += `\n -------------------`;
                }
                else {
                  //log('player=',player);
                  playersInfoString += `\n ${formatScore(player.score, 7)} | ${normalName(player.name)} [${player.ping}] ${scoreDiffVisual}`;
                }
              }
              if (botFilter == 1) {
                foundPlayer = includesPlayer(botFilterPlayers, normalNameHard(player.name));
                //console.log('foundPlayer=' + foundPlayer + ', player.name=' + player.name);
                if (foundPlayer && foundPlayer.trim() != '') serverPlayersToFilterCount++;
              }

            });

            //log('playersInfoString=', playersInfoString);

            //console.log('serverPlayers.length=' + serverPlayers.length);

            if (minPlayers == 0 || (minPlayers <= (serverPlayers.length - serverPlayersToFilterCount))) {
              //console.log("add server");
              foundServers.push({
                server: normalNameHard(server),
                serverIPPort: normalNameHard(serverInfo['serverIp'] + ":" + serverInfo['serverPort']),
                host: normalNameHard(serverInfo['hostname']),
                map: serverInfo['mapname'] && serverInfo['mapname'] != undefined ? serverInfo['mapname'] : '–Ω–µ—Ç (Not supported/QTV/GTV/Specs room)',
                playersList: serverPlayers.map(player => player.name).join(', '),
                serverInfo: serverInfoString,
                playersInfo: playersInfoString
              });
            }
          }
          else {
            log('–ü—Ä–æ–ø—É—Å–∫ –ø–æ —ç–≤—Ä–∏—Å—Ç–∏–∫–µ:', server);
          }
        }

      } catch (error) {
        log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ —Å–µ—Ä–≤–µ—Ä—É ${server}:`, error);
      }
    });

    // –ñ–¥–µ–º, –ø–æ–∫–∞ –≤—Å–µ –ø—Ä–æ–º–∏—Å—ã –∑–∞–≤–µ—Ä—à–∞—Ç—Å—è
    await Promise.allSettled(promises);

    if (foundServers.length === 0) {
      //return bot.telegram.sendMessage(chatId, '–ò–≥—Ä–æ–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.');
    }

    let servers2;// = userSettings && userSettings.q2servers ? userSettings.q2servers : [];
    let keyboard;
    let advcontrols = userSettings && userSettings.advcontrols && userSettings.advcontrols != undefined ? userSettings.advcontrols : 0;
    let autodelhistory = userSettings && userSettings.autodelhistory && userSettings.autodelhistory != undefined ? userSettings.autodelhistory : 0;
    let messageCount = 0;
    let messageCountAll = 0;
    const messagesPerSecond = config.MAX_MESSAGES_PER_SECOND;

    let serversAddCDF = ''; let serversDelCDF = ''; let serversUpdateCDF = ''; serversSearchMapCDF = ''; //–¥–ª—è —É–∫–∞–∑–∞–Ω–∏—è Callback —Ñ—É–Ω–∫—Ü–∏–∏-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∫–Ω–æ–ø–æ—Ö —Ç–µ–ª–µ–≥–∏
    let gameName;
    if (game == 'q2') {
      //console.log('game - q2');
      servers2 = userSettings && userSettings.q2servers ? userSettings.q2servers : [];
      serversAddCDF = 'addserverq2_';
      serversDelCDF = 'delserverq2_';
      serversUpdateCDF = 'updateserverq2_';
      serversSearchMapCDF = 'searchmapq2_';
      gameName = 'Quake II';
    }
    else if (game == 'qw') {
      //console.log('game - qw');
      servers2 = userSettings && userSettings.qwservers ? userSettings.qwservers : [];
      serversAddCDF = 'addserverqw_';
      serversDelCDF = 'delserverqw_';
      serversUpdateCDF = 'updateserverqw_';
      serversSearchMapCDF = 'sesearchmapqw_';
      gameName = 'QuakeWorld';
    }
    log('–°—Ç–∞—Ä—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ —Ä–∞—Å—Å—ã–ª–∫–∏ –ø–æ –Ω–∞–π–¥–µ–Ω–Ω—ã–º —Å–µ—Ä–≤–µ—Ä–∞–º.');
    let message;
    if (shortReport) {
      message = `–û—Ç—á—ë—Ç –ø–æ —Å–µ—Ä–≤–µ—Ä–∞–º –∏–≥—Ä—ã: <b>${gameName}</b>
<b>–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞:</b>   
–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: ${minPlayers}
–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –±–æ—Ç–æ–≤: ${botFilter == true ? '–≤–∫–ª—é—á–µ–Ω–æ, —Ñ–∏–ª—å—Ç—Ä—É—é—Ç—Å—è: ' + botFilterPlayers.join(', ') : '–≤—ã–∫–ª—é—á–µ–Ω–æ'}.
–°–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞: ${mapsToSearch.join(', ')}.
*************************

`;
    }

    //log('foundServers.length=', foundServers.length);

    //foundServers.forEach(async (foundServer) => {
    for (curIdx = 0; curIdx < foundServers.length; curIdx++) {

      let foundServer = foundServers[curIdx];
      //log('foundServers[' + curIdx + ']=' + foundServer.host);

      const q2ServerURL = `${foundServer.server}`; //<a href='https://www.gametracker.com/server_info/${foundServer.server}/'>${foundServer.server}</a>
      const gameTrackerURL = `<a href='https://www.gametracker.com/server_info/${foundServer.serverIPPort}/'>GameTracker</a>`;
      const shortServerInfo = `<a href='https://www.gametracker.com/server_info/${foundServer.serverIPPort}/'>üîç</a>`;
      let q2ServersURL;
      if (game == 'q2') {
        //q2ServersURL = `<a href='http://q2servers.com/?mod=*&g=*&m=*&c=ru&ac=*&s=pd&player=${foundPlayer.name}&action=Search'>q2servers</a>`;
      }
      else if (game == 'qw') {
        //q2ServersURL = ``;
      }


      let foundServer2 = includesServer(servers2, foundServer.server);
      foundServer2 = foundServer2 === '' ? includesServer(servers2, foundServer.serverIPPort) : foundServer2;
      //console.log('foundServer2=' + foundServer2 + ', foundServer.serverIPPort=' + foundServer.serverIPPort + 'foundServer.server=' + foundServer.server);

      if (advcontrols && !shortReport) {
        keyboard = {
          inline_keyboard: [
            [
              // { text: `–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å IP, url: 'https://t.me/share/url?url=${foundPlayer.server}'`},
              { text: `–û–±–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä`, callback_data: `${serversUpdateCDF}${foundServer.server}` },
            ]
          ]
        };

        if (foundServer2 && foundServer2.trim() != '') {
          keyboard.inline_keyboard[0].push({ text: `–ù–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å–µ—Ä–≤–µ—Ä`, callback_data: `${serversDelCDF}${foundServer2}` });
        } else {
          keyboard.inline_keyboard[0].push({ text: `–û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å–µ—Ä–≤–µ—Ä`, callback_data: `${serversAddCDF}${foundServer.server}` });
        }

        let mapInlineKeyboard = [];
        mapInlineKeyboard.push({ text: `–ù–∞–π—Ç–∏ –≤—Å–µ –º–∞—Ç—á–∏ –Ω–∞ –∫–∞—Ä—Ç–µ ${foundServer.map}`, callback_data: `${serversSearchMapCDF}${foundServer.map}` });
        keyboard.inline_keyboard.push(mapInlineKeyboard);

      }

      const messagesPerSecond = config.MAX_MESSAGES_PER_SECOND;
      let sentMessage;
      let previousMessageId;
      let previousMessageIdIndex;
      if (!shortReport) {
        if (autodelhistory == 1) {
          previousMessageIdIndex = !themeId ? String(userId) + String(chatId) + foundServer.server + mapsToSearch.join('') + serverToSearch : String(userId) + String(chatId) + String(themeId) + foundServer.server + mapsToSearch.join('') + serverToSearch;
          previousMessageId = messageIds[previousMessageIdIndex];
        }
        if (altview == 0) {
          message = `–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞ ${shortServerInfo} ${q2ServerURL}
–ò–≥—Ä–∞: <b>${gameName}</b>
–ù–∞–∑–≤–∞–Ω–∏–µ: ${foundServer.host}
–ö–∞—Ä—Ç–∞: ${foundServer.map}
–ò–≥—Ä–æ–∫–∏: ${normalNameHard(foundServer.playersList)}
–°—Å—ã–ª–∫–∏: ${gameTrackerURL}${foundServer.serverInfo + foundServer.playersInfo}`;
        }
        else {
          message = `–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ —Å–µ—Ä–≤–µ—Ä—É ${shortServerInfo} ${q2ServerURL} –≤ –∏–≥—Ä–µ <b>${gameName}</b>
–ù–∞–∑–≤–∞–Ω–∏–µ: ${foundServer.host}
–ö–∞—Ä—Ç–∞: ${foundServer.map}
–ò–≥—Ä–æ–∫–∏: ${normalNameHard(foundServer.playersList)}${foundServer.serverInfo + foundServer.playersInfo}`;
        }
        const chunks = message.match(/(.|[\n\r]){1,4096}/g);
        //log(foundServer.host + ', message:\n', message);
        if (autoDelHistory) {
          //if (!themeId) await deleteBotMessagesInTopic(chatId);
          //else await deleteBotMessagesInTopic(chatId, themeId);
        }

        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        if (autodelhistory == 1 && previousMessageId) {
          log('themeId=' + themeId + ', previousMessageId=' + previousMessageId);
          try {
            if (!themeId) await bot.telegram.deleteMessage(chatId, previousMessageId);
            else await bot.telegram.deleteMessage(chatId, previousMessageId, { message_thread_id: themeId });
          } catch (error) {
            console.log('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:', error);
          }
        }

        for (const chunk of chunks) {

          try {
            log('themeId=', themeId);
            if (!themeId) {
              if (advcontrols) sentMessage = await bot.telegram.sendMessage(chatId, chunk, { parse_mode: 'HTML', reply_markup: keyboard });
              else sentMessage = await bot.telegram.sendMessage(chatId, chunk, { parse_mode: 'HTML' });
            }
            else {
              log('refreshServers -> sentMessage: chatId=' + chatId + 'themeId=' + themeId);
              if (advcontrols) sentMessage = await bot.telegram.sendMessage(chatId, chunk, { message_thread_id: themeId, parse_mode: 'HTML', reply_markup: keyboard });
              else sentMessage = await bot.telegram.sendMessage(chatId, chunk, { message_thread_id: themeId, parse_mode: 'HTML' });
            }

            if (autodelhistory == 1) messageIds[previousMessageIdIndex] = sentMessage.message_id;

          } catch (error) { console.log(`–û—à–∏–±–∫–∞: ${error.message}`, error) };
          messageCount++;
          //  –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Å–µ–∫—É–Ω–¥—É
          if (messageCount >= messagesPerSecond) {
            console.log(`–ü–∞—É–∑–∞ –Ω–∞ ${config.SLEEP_TIME} —Å–µ–∫—É–Ω–¥`);
            if (!themeId) {
              await bot.telegram.sendMessage(chatId, `–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä—É—é –≤—ã —Ö–æ—Ç–∏—Ç–µ –Ω–∞–π—Ç–∏.\n–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏ –Ω–∞–π–¥–µ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ ${config.SLEEP_TIME / 1000} —Å–µ–∫—É–Ω–¥(—ã)...`);
            }
            else {
              await bot.telegram.sendMessage(chatId, `–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä—É—é –≤—ã —Ö–æ—Ç–∏—Ç–µ –Ω–∞–π—Ç–∏.\n–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏ –Ω–∞–π–¥–µ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ ${config.SLEEP_TIME / 1000} —Å–µ–∫—É–Ω–¥(—ã)...`, { message_thread_id: themeId });
            }
            await sleep(config.SLEEP_TIME);
            messageCount = 0;
          }
          wasFinded = true;
          messageCountAll++;
          if (messageCountAll >= config.MAX_MESSAGES_PER_SEARCH) {
            try {
              if (!themeId) return await bot.telegram.sendMessage(chatId, "–ü—Ä–µ–≤—ã—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ä–∞–º–∫–∞—Ö —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–∏—Å–∫–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä—É—é –≤—ã —Ö–æ—Ç–∏—Ç–µ –Ω–∞–π—Ç–∏.");
              else return await bot.telegram.sendMessage(chatId, "–ü—Ä–µ–≤—ã—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ä–∞–º–∫–∞—Ö —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–∏—Å–∫–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä—É—é –≤—ã —Ö–æ—Ç–∏—Ç–µ –Ω–∞–π—Ç–∏.", { message_thread_id: themeId });
            } catch (error) { console.log(`–û—à–∏–±–∫–∞: ${error.message}`, error) };
          }
        }
      }
      else {
        //message += `${shortServerInfo} ${q2ServerURL}
        message += `${q2ServerURL}
–ù–∞–∑–≤–∞–Ω–∏–µ: ${foundServer.host} 
–ö–∞—Ä—Ç–∞: ${foundServer.map}
–ò–≥—Ä–æ–∫–∏: ${normalNameHard(foundServer.playersList)}
${anyToFind != '' ? '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ä–≤–µ—Ä–µ: ' + escapeHtmlForTelegram(foundServer.serverInfo) : ''}

`;
      }

      //log('!!!!! END CURRENT SERVER:', curIdx);

    };

    if (shortReport) {
      /* –ø–æ–∫–∞ —É–±–∏—Ä–∞—é - –Ω–∞–¥–æ –ø–æ–¥—É–º–∞—Ç—å –∫–∞–∫ –ª—É—á—à–µ —Ö—Ä–∞–Ω–∏—Ç—å –¥–ª—è shortReport, –ø–æ—Å–∫–æ–ª—å–∫—É foundServer —Ç—É—Ç –Ω–µ –≥–æ–¥–∏—Ç—Å—è - —Ü–∏–∫–ª –≤—ã—à–µ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –ø–æ foundServer
     if (autodelhistory == 1) {
       previousMessageIdIndex = !themeId ? 'ShortReport' + game + String(userId) + foundServer.server + mapsToSearch.join('') + serverToSearch : 'ShortReport' + game + String(userId) + String(themeId) + foundServer.server + mapsToSearch.join('') + serverToSearch;
       previousMessageId = messageIds[previousMessageIdIndex];
     }
       */
      messageCount = 0;
      //console.log(message);
      const chunks = message.match(/(.|[\n\r]){1,4096}/g);
      for (const chunk of chunks) {
        // console.log(chunk);
        try {
          log('themeId=', themeId);
          if (!themeId) sentMessage = await bot.telegram.sendMessage(chatId, chunk, { parse_mode: 'HTML' });
          else {
            log('refreshServers -> sentMessage: chatId=' + chatId + 'themeId=' + themeId);
            sentMessage = await bot.telegram.sendMessage(chatId, chunk, { message_thread_id: themeId, parse_mode: 'HTML' });
          }
          wasFinded = true;
          /*
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
          if (autodelhistory == 1 && previousMessageId) {
            try {
              if (!themeId) await bot.telegram.deleteMessage(chatId, previousMessageId);
              else bot.telegram.deleteMessage(chatId, previousMessageId, { message_thread_id: themeId });
            } catch (error) {
              console.log('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:', error);
            }
          }
          if (autodelhistory == 1) messageIds[previousMessageIdIndex] = sentMessage.message_id;
          */
        } catch (error) { console.log(`–û—à–∏–±–∫–∞: ${error.message}`, error) };
        messageCount++;
        //  –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Å–µ–∫—É–Ω–¥—É
        if (messageCount >= messagesPerSecond) {
          console.log(`–ü–∞—É–∑–∞ –Ω–∞ ${config.SLEEP_TIME} —Å–µ–∫—É–Ω–¥`);
          if (!themeId) await bot.telegram.sendMessage(chatId, `–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä—É—é –≤—ã —Ö–æ—Ç–∏—Ç–µ –Ω–∞–π—Ç–∏.\n–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏ –Ω–∞–π–¥–µ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ ${config.SLEEP_TIME / 1000} —Å–µ–∫—É–Ω–¥(—ã)...`);
          else await bot.telegram.sendMessage(chatId, `–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä—É—é –≤—ã —Ö–æ—Ç–∏—Ç–µ –Ω–∞–π—Ç–∏.\n–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏ –Ω–∞–π–¥–µ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ ${config.SLEEP_TIME / 1000} —Å–µ–∫—É–Ω–¥(—ã)...`, { message_thread_id: themeId });
          await sleep(config.SLEEP_TIME);
          messageCount = 0;
        }

        messageCountAll++;
        if (messageCountAll >= config.MAX_MESSAGES_PER_SEARCH) {
          try {
            if (!themeId) return await bot.telegram.sendMessage(chatId, "–ü—Ä–µ–≤—ã—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ä–∞–º–∫–∞—Ö —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–∏—Å–∫–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä—É—é –≤—ã —Ö–æ—Ç–∏—Ç–µ –Ω–∞–π—Ç–∏.");
            else return await bot.telegram.sendMessage(chatId, "–ü—Ä–µ–≤—ã—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ä–∞–º–∫–∞—Ö —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–∏—Å–∫–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä—É—é –≤—ã —Ö–æ—Ç–∏—Ç–µ –Ω–∞–π—Ç–∏.", { message_thread_id: themeId });
          } catch (error) { console.log(`–û—à–∏–±–∫–∞: ${error.message}`, error) };
        }
      }
    }




    if (msgIdToDel && msgIdToDel != undefined && msgIdToDel != 0) {
      try {
        if (!themeId) await bot.telegram.deleteMessage(chatId, msgIdToDel);
        else await bot.telegram.deleteMessage(chatId, msgIdToDel, { message_thread_id: themeId });
      } catch (error) {
        //console.log('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:', error);
      }
    }

    log('skipStatusMsg=' + skipStatusMsg + ', wasFinded=' + wasFinded + ',canPostNotFinded=' + canPostNotFinded);
    if (!skipStatusMsg && !wasFinded && canPostNotFinded) {
      if (!themeId) await bot.telegram.sendMessage(chatId, `–ò–≥—Ä–æ–∫–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ ${serverToSearch} –≤ –∏–≥—Ä–µ <b>${gameName}</b> –∏–ª–∏ —Å—Ä–∞–±–æ—Ç–∞–ª–∏ —Ñ–∏–ª—å—Ç—Ä—ã (/mp , /botfilter).`, { parse_mode: 'HTML' });
      else await bot.telegram.sendMessage(chatId, `–ò–≥—Ä–æ–∫–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ ${serverToSearch} –≤ –∏–≥—Ä–µ <b>${gameName}</b> –∏–ª–∏ —Å—Ä–∞–±–æ—Ç–∞–ª–∏ —Ñ–∏–ª—å—Ç—Ä—ã (/mp , /botfilter).`, { message_thread_id: themeId, parse_mode: 'HTML' });
    }

  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error) };
  return wasFinded;
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

function escapeHtmlForTelegram(text) {
  // –ó–∞–º–µ–Ω—è–µ–º –≤—Å–µ –∫–∞–≤—ã—á–∫–∏-–µ–ª–æ—á–∫–∏ –Ω–∞ –∫–∞–≤—ã—á–∫–∏-–∞–ø–æ—Å—Ç—Ä–æ—Ñ—ã
  text = text.replace(/"/g, "'");

  // –ó–∞–º–µ–Ω—è–µ–º –≤—Å–µ –∞–º–ø–µ—Ä—Å–∞–Ω–¥—ã –Ω–∞ &amp;
  text = text.replace(/&/g, '&amp;');

  // –ó–∞–º–µ–Ω—è–µ–º –≤—Å–µ —É–≥–ª–æ–≤—ã–µ —Å–∫–æ–±–∫–∏ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Å–∏–º–≤–æ–ª—ã HTML-—Å—É—â–Ω–æ—Å—Ç–µ–π
  text = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');

  return text;
}

function formatScore(score) {
  try {
    const scoreString = score.toString();
    if (scoreString.match(/^\d+$/)) {
      // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã
      const paddingCount = Math.max(0, 4 - scoreString.length);
      const paddedScore = scoreString.padStart(paddingCount, ' '); // –ò—Å–ø–æ–ª—å–∑—É–µ–º paddingCount
      return paddedScore;
    } else {
      // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã
      return scoreString;
    }
  } catch (error) { return score; }
}

function formatScoreOld(score, num) {
  const scoreString = score.toString();
  const paddedScore = scoreString.padStart(num, ' '); // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã –≤ –Ω–∞—á–∞–ª–æ
  return paddedScore;
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

async function refreshPlayersAllGames(userId, searchFor, msgId, skipStatusMsg, forceUpdate) {
  let wasFinded = false;
  try {
    if (typeof msgId === 'undefined') {
      msgId = 0;
    }
    if (typeof skipStatusMsg === 'undefined') {
      skipStatusMsg = 0;
    }
    if (typeof forceUpdate === 'undefined') {
      msforceUpdateId = false;
    }
    const userSettings = await getUserSettings(userId);
    const games = !userSettings || userSettings === undefined || userSettings.games === undefined || userSettings.games.join().trim() == '' ? [] : userSettings.games;
    //console.log('games=' + games.join(', ') + ', msgId='+msgId);
    for (i = 0; i < games.length; i++) {
      //console.log('1 - go to refreshPlayers: user=' + userId + ', game=' + games[i] + ', games.length=' + games.length);
      const res = refreshPlayers(userId, searchFor, games[i], msgId, skipStatusMsg, forceUpdate); //–Ω–µ –º–µ–Ω—è—Ç—å –Ω–∞ await refreshPlayers - –≤–∏—Å–Ω–µ—Ç –±–æ—Ç!
      if (res == true) wasFinded = true;
    };
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error) };
  return wasFinded;
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

async function refreshServersAllGames(userId, msgId) {
  try {
    if (typeof msgId === 'undefined') {
      msgId = 0;
    }
    const userSettings = await getUserSettings(userId);
    const games = !userSettings || userSettings === undefined || userSettings.games === undefined || userSettings.games.join('').trim() == '' ? [] : userSettings.games;

    //console.log('games=' + games.join(', '));
    for (i = 0; i < games.length; i++) {
      //console.log('2 - go to refreshServers: user=' + userId + ', game=' + games[i]);

      if ((userSettings.q2servers && userSettings.q2servers != undefined && userSettings.q2servers.join("").trim() != '')
        || (userSettings.q2maps && userSettings.q2maps != undefined && userSettings.q2maps.join("").trim() != '')
        && games[i] == 'q2'
      ) {
        refreshServers(userId, '', '', false, 'q2', false, msgId); //–Ω–µ —Å—Ç–∞–≤–∏—Ç—å await –¥–ª—è refreshServers - –≤–∏—Å–Ω–µ—Ç –±–æ—Ç!
      }
      else if ((userSettings.qwservers && userSettings.qwservers != undefined && userSettings.qwservers.join("").trim() != '')
        || (userSettings.qwmaps && userSettings.qwmaps != undefined && userSettings.qwmaps.join("").trim() != '')
        && games[i] == 'qw'
      ) {
        refreshServers(userId, '', '', false, 'qw', false, msgId); //–Ω–µ —Å—Ç–∞–≤–∏—Ç—å await –¥–ª—è refreshServers - –≤–∏—Å–Ω–µ—Ç –±–æ—Ç!
      }
    };

  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error) };
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞—Ö . –í —Å–ª—É—á–∞–µ, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä searchFor —Ñ—É–Ω–∫—Ü–∏—è –∏—â–µ—Ç –∏–≥—Ä–æ–∫–∞ –ø–æ –∑–Ω–∞—á–µ–Ω–∏—é, —É–∫–∞–∑–∞–Ω–Ω–æ–º—É –≤ —ç—Ç–æ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–µ.
async function refresh(userId, searchFor, msgId) {
  try {
    //console.log('refresh -> userId: ' + userId + ',searchFor:', searchFor);

    const userSettings = await getUserSettings(userId);
    if (!userSettings || userSettings === undefined || (
      (!userSettings.games || userSettings.games == undefined || userSettings.games.join("").trim() === '')
      && (!userSettings.players || userSettings.players == undefined || userSettings.players.join("").trim() === '')
    )) {
      log('refresh - –Ω–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏–≥—Ä–æ–∫–æ–≤');
    }
    else await refreshPlayersAllGames(userId, searchFor, msgId);

    if (!userSettings || userSettings === undefined || (
      (userSettings.games === undefined || userSettings.games.join("").trim() === '')
      && (userSettings.q2servers === undefined || userSettings.q2servers.join("").trim() === '')
      && (userSettings.qwservers === undefined || userSettings.qwservers.join("").trim() === '')
      && (userSettings.q2maps === undefined || userSettings.q2maps.join("").trim() === '')
      && (userSettings.qwmaps === undefined || userSettings.qwmaps.join("").trim() === '')
    )) {
      log('refresh - –Ω–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤');
    }
    else {
      await refreshServersAllGames(userId, msgId);
    }
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error) };
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

bot.on('callback_query', async (ctx) => {
  //console.log('query.message.chat='+ctx.message.chat.id);
  try {
    const data = ctx.callbackQuery.data;
    console.log('data=' + data);
    if (data.startsWith('updatePlayer_')) {
      const gamePlayer = data.substring('updatePlayer_'.length).split('<<<<gameplayer>>>>');
      let game = gamePlayer[0];
      let playerName = gamePlayer[1];
      let userId = await getUserID(ctx); //ctx.callbackQuery.message.chat.id
      //if (playerName.includes(' ')) playerName = `"*${playerName}*"`; //–¥–æ–±–∞–≤–ª—è–µ–º –∫–∞–≤—ã—á–∫–∏ –ø–æ –∫—Ä–∞—è–º –∏–º–µ–Ω–∏ –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–±–µ–ª—ã –≤ –∏–º–µ–Ω–∏
      console.log('playerName=', playerName);
      // –í—ã–∑–æ–≤–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∏–≥—Ä–æ–∫–µ
      //await refreshPlayersAllGames(ctx.callbackQuery.message.chat.id, playerName, '0', true, true, game);
      log('ctx.callbackQuery.message.chat.id=', ctx.callbackQuery.message.chat.id);
      await refreshPlayers(userId, playerName, game, '0', true, true);
    }
    else if (data.startsWith('addPlayer_')) {
      let playerName = [];
      playerName[0] = data.substring('addPlayer_'.length);
      console.log('callback_query - playerName=' + playerName[0]);
      await addPlayers(ctx, playerName, 'players');
    }
    else if (data.startsWith('delPlayer_')) {
      //let playerName = [];
      const playerName = [];
      playerName[0] = data.substring('delPlayer_'.length);
      console.log('playerName=' + playerName[0]);
      await delPlayers(ctx, playerName, 'players');
    }
    else if (data.startsWith('addSPFilter_')) {
      let sp = data.substring('addSPFilter_'.length);
      let spArr = sp.split('\\');
      //console.log('callback_query - playerName=' + playerName[0]);
      await addPlayers(ctx, spArr, 'spfilter');
    }
    else if (data.startsWith('updateserverq2_')) {
      const server = data.substring('updateserverq2_'.length);
      const allMaps = []; allMaps[0] = '*';
      let userId = getUserID(ctx); //ctx.callbackQuery.message.chat.id
      await refreshServers(userId, server, allMaps, false, 'q2', false, '0', true, true);
    }
    else if (data.startsWith('updateserverqw_')) {
      const server = data.substring('updateserverqw_'.length);
      const allMaps = []; allMaps[0] = '*';
      await refreshServers(ctx.callbackQuery.message.chat.id, server, allMaps, false, 'qw', false, '0', true, true);
    }
    else if (data.startsWith('addserverq2_')) {
      let server = [];
      server[0] = data.substring('addserverq2_'.length);
      //console.log('server=' + server[0]);
      await addServers(ctx, server, 'q2');
    }
    else if (data.startsWith('delserverq2_')) {
      //let playerName = [];
      const server = data.substring('delserverq2_'.length);
      //console.log('server=' + server);
      await delServer(ctx, server, 'q2');
    }
    else if (data.startsWith('addserverqw_')) {
      let server = [];
      server[0] = data.substring('addserverqw_'.length);
      console.log('serverqw=' + server[0]);
      await addServers(ctx, server, 'qw');
    }
    else if (data.startsWith('delserverqw_')) {
      //let playerName = [];
      const server = data.substring('delserverqw_'.length);
      console.log('serverqw=' + server);
      await delServer(ctx, server, 'qw');
    }
    else if (data.startsWith('searchmapq2_')) {
      //let playerName = [];
      const map = [];
      map[0] = data.substring('searchmapq2_'.length);
      console.log('map=' + map[0]);
      const userId = getUserID(ctx);
      await refreshServers(userId, '', map, true, 'q2');
    }
    else if (data.startsWith('sesearchmapqw_')) {
      //let playerName = [];
      const map = [];
      map[0] = data.substring('sesearchmapqw_'.length);
      console.log('map=' + map[0]);
      const userId = getUserID(ctx);
      await refreshServers(userId, '', map, true, 'qw');
    }

  } catch (error) { console.log('–û—à–∏–±–∫–∞:', error); }
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

function formatName(input) {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø—Ä–æ–±–µ–ª—ã –≤ —Å—Ç—Ä–æ–∫–µ
  if (input.includes(' ')) {
    // –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –∏–∑ –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü–∞ —Å—Ç—Ä–æ–∫–∏
    let trimmedInput = input.trim();

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞ –ª–∏ —Å—Ç—Ä–æ–∫–∞ –≤ –∫–∞–≤—ã—á–∫–∞—Ö
    if (!trimmedInput.startsWith('"') && !trimmedInput.endsWith('"')) {
      // –ï—Å–ª–∏ –Ω–µ—Ç, –¥–æ–±–∞–≤–ª—è–µ–º –∫–∞–≤—ã—á–∫–∏ –ø–æ –∫—Ä–∞—è–º
      return `"${trimmedInput}"`;
    } else if (!trimmedInput.startsWith('"')) {
      // –ï—Å–ª–∏ –Ω–µ—Ç –ø–µ—Ä–≤–æ–π –∫–∞–≤—ã—á–∫–∏, –¥–æ–±–∞–≤–ª—è–µ–º –µ—ë
      return `"${trimmedInput}`;
    } else if (!trimmedInput.endsWith('"')) {
      // –ï—Å–ª–∏ –Ω–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–π –∫–∞–≤—ã—á–∫–∏, –¥–æ–±–∞–≤–ª—è–µ–º –µ—ë
      return `${trimmedInput}"`;
    } else {
      // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ —É–∂–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞ –≤ –∫–∞–≤—ã—á–∫–∞—Ö, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ—ë –∫–∞–∫ –µ—Å—Ç—å
      return trimmedInput;
    }
  }

  // –ï—Å–ª–∏ –ø—Ä–æ–±–µ–ª–æ–≤ –Ω–µ—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç—Ä–æ–∫—É –∫–∞–∫ –µ—Å—Ç—å
  return input;
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

function normalName(input) { // –§—É–Ω–∫—Ü–∏—è —Å–ª—É–∂–∏—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø–ª–æ—Ö–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤ - –Ω–∞–ø—Ä–∏–º–µ—Ä, —Å –∏–º—ë–Ω –∏–≥—Ä–æ–∫–æ–≤
  return escapeHtmlForTelegram(input);
  let normal = input.replace("'", "");
  return normal;
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

function normalNameHard(input) { // –§—É–Ω–∫—Ü–∏—è —Å–ª—É–∂–∏—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø–ª–æ—Ö–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤ - –Ω–∞–ø—Ä–∏–º–µ—Ä, —Å –∏–º—ë–Ω –∏–≥—Ä–æ–∫–æ–≤
  if (!input || input == undefined || input.trim() == '') return '';

  return escapeHtmlForTelegram(input);

  let normal = input;
  normal = normal.replace(/[\'\n]/g, '');
  normal = normal.replace('<', '&lt');
  normal = normal.replace('>', '&gt');
  normal = normal.replace('\'', '&apos;');

  if (normal.trim() == '') return '';
  return normal;
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

function includesPlayer(playerArray, searchString) {
  searchString = searchString.toLowerCase(); // –î–µ–ª–∞–µ–º –ø–æ–∏—Å–∫ –Ω–µ—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º –∫ —Ä–µ–≥–∏—Å—Ç—Ä—É
  if (!playerArray || playerArray == undefined || playerArray.length == '') return '';
  for (let i = 0; i < playerArray.length; i++) {
    let player = normalName(playerArray[i].toLowerCase()); // –î–µ–ª–∞–µ–º –ø–æ–∏—Å–∫ –Ω–µ—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º –∫ —Ä–µ–≥–∏—Å—Ç—Ä—É

    if (player.startsWith('*') && player.endsWith('*')) { // –ü–æ–∏—Å–∫ –ø–æ –ø–æ–¥—Å—Ç—Ä–æ–∫–µ
      if (searchString.includes(player.slice(1, -1))) {
        return player; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç, –µ—Å–ª–∏ –ø–æ–¥—Å—Ç—Ä–æ–∫–∞ –Ω–∞–π–¥–µ–Ω–∞
      }
    } else if (player.startsWith('*')) { // –ü–æ–∏—Å–∫ –ø–æ –æ–∫–æ–Ω—á–∞–Ω–∏—é —Å—Ç—Ä–æ–∫–∏
      if (searchString.endsWith(player.slice(1))) {
        return player; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç, –µ—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ –∏—Å–∫–æ–º—É—é –ø–æ–¥—Å—Ç—Ä–æ–∫—É
      }
    } else if (player.endsWith('*')) { // –ü–æ–∏—Å–∫ –ø–æ –Ω–∞—á–∞–ª—É —Å—Ç—Ä–æ–∫–∏
      if (searchString.startsWith(player.slice(0, -1))) {
        return player; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç, –µ—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –Ω–∞ –∏—Å–∫–æ–º—É—é –ø–æ–¥—Å—Ç—Ä–æ–∫—É
      }
    } else { // –ü–æ–∏—Å–∫ –ø–æ —Ç–æ—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é
      if (player === searchString) {
        return player; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç, –µ—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ —Ç–æ—á–Ω–æ —Å–æ–≤–ø–∞–¥–∞–µ—Ç
      }
    }
  }

  return ''; // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

function includesServer(serverArray, searchString) {
  try {
    searchString = searchString.toLowerCase().trim(); // –î–µ–ª–∞–µ–º –ø–æ–∏—Å–∫ –Ω–µ—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º –∫ —Ä–µ–≥–∏—Å—Ç—Ä—É
    //console.log(serverArray);
    //console.log('searchString = ' + searchString);
    for (let i = 0; i < serverArray.length; i++) {
      let server = serverArray[i].toLowerCase().trim(); // –î–µ–ª–∞–µ–º –ø–æ–∏—Å–∫ –Ω–µ—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º –∫ —Ä–µ–≥–∏—Å—Ç—Ä—É
      //console.log("server=" + server);
      if (server === searchString) {
        log("fineded!");
        return server; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç, –µ—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ —Ç–æ—á–Ω–æ —Å–æ–≤–ø–∞–¥–∞–µ—Ç
      }
    }
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error) };

  return ''; // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
}


/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

async function refreshCommand(ctx) { //—Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ–≥–æ, —á—Ç–æ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
  try {
    const userId = getUserID(ctx);
    userContexts[userId] = ctx;
    const userSettings = await getUserSettings(userId);
    if (!userSettings || userSettings === undefined || (
      (userSettings.players === undefined || userSettings.players.join("").trim() === '')
      && (userSettings.q2servers === undefined || userSettings.q2servers.join("").trim() === '')
      && (userSettings.qwservers === undefined || userSettings.qwservers.join("").trim() === '')
      && (userSettings.q2maps === undefined || userSettings.q2maps.join("").trim() === '')
      && (userSettings.qwmaps === undefined || userSettings.qwmaps.join("").trim() === '')
    )) {
      //return await bot.telegram.sendMessage(ctx.chat.id, '–í–Ω–∞—á–∞–ª–µ –≤–Ω–µ—Å–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ (/addplayer , /addserverq2).');
      return await ctx.reply('–í–Ω–∞—á–∞–ª–µ –≤–Ω–µ—Å–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ (/addplayer , /addserverq2).');
    }
    console.log('–°—Ç–∞—Ä—Ç –ø–æ–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤');

    let msgId = 0;
    await ctx.reply('–°—Ç–∞—Ä—Ç –ø–æ–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤.\n–ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –ø–æ–∏—Å–∫–∞.').then((message) => {
      msgId = message.message_id;
      console.log('msgId:', msgId);

    });
    await refresh(userId, '', msgId);
    //const msgId = await ctx.reply('–°—Ç–∞—Ä—Ç –ø–æ–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤ –∏ —Å–µ—Ä–≤–µ—Ä–æ–≤.\n–ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –ø–æ–∏—Å–∫–∞.');
    //await refresh(userId, '', msgId);
  } catch (error) { console.log(`–û—à–∏–±–∫–∞:`, error) };
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ–≥–æ, —á—Ç–æ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
bot.command('refresh', async (ctx) => {
  try {
    await refreshCommand(ctx);
  } catch (error) { console.log(`–û—à–∏–±–∫–∞:`, error) };
});

bot.command('r', async (ctx) => {
  try {
    await refreshCommand(ctx);
  } catch (error) { console.log(`–û—à–∏–±–∫–∞:`, error) };
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –∏–≥—Ä–æ–∫–æ–≤
bot.command('rp', async (ctx) => {
  try {
    const userId = getUserID(ctx);
    userContexts[userId] = ctx;
    const userSettings = await getUserSettings(userId);
    if (!userSettings || userSettings === undefined || userSettings.players === undefined || userSettings.players.join("").trim() === '') {
      //return await bot.telegram.sendMessage(ctx.chat.id, '–í–Ω–∞—á–∞–ª–µ –≤–Ω–µ—Å–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ (/addplayer).');
      return await ctx.reply('–í–Ω–∞—á–∞–ª–µ –≤–Ω–µ—Å–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ (/addplayer).');
    }
    console.log('–°—Ç–∞—Ä—Ç –ø–æ–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤ –∏ —Å–µ—Ä–≤–µ—Ä–æ–≤');
    let msgId = 0;
    await ctx.reply('–°—Ç–∞—Ä—Ç –ø–æ–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤.\n–ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –ø–æ–∏—Å–∫–∞.').then((message) => {
      msgId = message.message_id;
      console.log('msgId:', msgId);
    });
    await refreshPlayersAllGames(userId, '', msgId);

    //const msgId = await ctx.reply('–°—Ç–∞—Ä—Ç –ø–æ–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤.\n–ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –ø–æ–∏—Å–∫–∞.');
    //await refreshPlayersAllGames(userId, msgId);

  }
  catch (error) { console.log(`–û—à–∏–±–∫–∞: ${error.message}`) };
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ —Å–µ—Ä–≤–µ—Ä–æ–≤
bot.command('rs', async (ctx) => {
  try {
    const userId = getUserID(ctx);
    userContexts[userId] = ctx;
    const userSettings = await getUserSettings(userId);
    if (!userSettings || userSettings === undefined || userSettings.q2servers === undefined || userSettings.q2servers.join("").trim() === '') {
      //return await bot.telegram.sendMessage(ctx.chat.id, '–í–Ω–∞—á–∞–ª–µ –≤–Ω–µ—Å–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ (/addserverq2).');
      return ctx.reply('–í–Ω–∞—á–∞–ª–µ –≤–Ω–µ—Å–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ (/addserverq2).');
    }
    /* -–¥–æ–ø–∏—Å–∞—Ç—å –ø–æ—Ç–æ–º
    let server = "";
    const serverId = ctx.message.text.split(' ')[1];
    if (serverId && serverId != undefined && serverId.trim() != "" && )
   */

    console.log('–°—Ç–∞—Ä—Ç –ø–æ–∏—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤');

    let msgId = 0;
    await ctx.reply('–°—Ç–∞—Ä—Ç –ø–æ–∏—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤.\n–ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –ø–æ–∏—Å–∫–∞.').then((message) => {
      msgId = message.message_id;
      console.log('msgId:', msgId);
    });
    await refreshServersAllGames(userId, msgId);
    //await ctx.reply('–°—Ç–∞—Ä—Ç –ø–æ–∏—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤.\n–ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –ø–æ–∏—Å–∫–∞.');
    //await refreshServers(userId);
    //await refreshServersAllGames(userId, );
  }
  catch (error) { console.log(`–û—à–∏–±–∫–∞: ${error.message}`) };
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Ä–∞–∑–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–∞ 
bot.command('sp', async (ctx) => {
  try {
    const userId = getUserID(ctx);
    userContexts[userId] = ctx;

    // –ü–æ–ª—É—á–∞–µ–º –∏–º—è –∏–≥—Ä–æ–∫–∞ —Å —É—á–µ—Ç–æ–º –ø—Ä–æ–±–µ–ª–æ–≤ –≤ –∫–∞–≤—ã—á–∫–∞—Ö –∏–ª–∏ –±–µ–∑ –Ω–∏—Ö
    let sp = ctx.message.text.match(/"([^"]*)"/);
    if (sp) { // –ï—Å–ª–∏ –≤ –∫–∞–≤—ã—á–∫–∞—Ö
      sp = sp[1]; // –ë–µ—Ä–µ–º —Ç–µ–∫—Å—Ç –≤ –∫–∞–≤—ã—á–∫–∞—Ö
    } else { // –ï—Å–ª–∏ –±–µ–∑ –∫–∞–≤—ã—á–µ–∫
      sp = ctx.message.text.split(' ')[1]; // –ë–µ—Ä–µ–º –≤—Ç–æ—Ä–æ–π —ç–ª–µ–º–µ–Ω—Ç
    }

    if (!isValidPlayerName(sp)) {
      return ctx.reply(`–ò–º—è –∏–≥—Ä–æ–∫–∞ –¥–æ–ª–∂–Ω–æ —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ –º–∏–Ω–∏–º—É–º ${config.PLAYERS_NICK_NAME_LIMIT} —Å–∏–º–≤–æ–ª–∞(–æ–≤).  + –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–∞—Å–∫–∞, —Ç–æ –º–∏–Ω–∏–º—É–º ${config.PLAYERS_NICK_NAME_MASK_LIMIT} —Å–∏–º–≤–æ–ª–∞(–æ–≤) + –æ–¥–Ω–∞ –∏–ª–∏ –¥–≤–µ –∑–≤–µ–∑–¥–æ—á–∫–∏.`);
    }
    //console.log('–°—Ç–∞—Ä—Ç –ø–æ–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤');
    //const msgId = await ctx.reply('–°—Ç–∞—Ä—Ç –ø–æ–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤');
    let msgId = 0;
    await ctx.reply('–°—Ç–∞—Ä—Ç –ø–æ–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤').then((message) => {
      msgId = message.message_id;
      console.log('msgId:', msgId);
    });
    let wasFinded = await refreshPlayersAllGames(userId, sp, msgId, false, true);

    //await refreshPlayersAllGames(userId, sp, msgId);

  }
  catch (error) { console.log('–û—à–∏–±–∫–∞:', error.message); };
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

async function searchServer(ctx, game, msg) { //–§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
  try {
    const userId = getUserID(ctx);
    userContexts[userId] = ctx;
    const ss = ctx.message.text.split(' ')[1];

    if (!isValidServer(ss)) {
      return ctx.reply(msg);
    }

    //await ctx.reply('–°—Ç–∞—Ä—Ç –ø–æ–∏—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤');

    //const userSettings = await getUserSettings(userId);
    //let wasFinded = false; let searchResult;
    let msgId = 0;
    await ctx.reply('–°—Ç–∞—Ä—Ç –ø–æ–∏—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤').then((message) => {
      msgId = message.message_id;
      console.log('msgId:', msgId);
    });

    const allMaps = []; allMaps[0] = '*';
    console.log('–°—Ç–∞—Ä—Ç –ø–æ–∏—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤');
    await refreshServers(userId, ss, allMaps, false, game, false, msgId, false, true);
  }
  catch (error) { console.log(`–û—à–∏–±–∫–∞: ${error.message}`) };
}


/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Ä–∞–∑–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ Q2
bot.command('ssq2', async (ctx) => {
  try {
    await searchServer(ctx, 'q2', `–ê–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞ –¥–æ–ª–∂–Ω–µ–Ω –±—ã—Ç—å —É–∫–∞–∑–∞–Ω –≤ –≤–∏–¥–µ IPAddress:Port –∏–ª–∏ Domen:Port, –Ω–∞–ø—Ä–∏–º–µ—Ä, 212.42.38.88:27910 –∏–ª–∏ q2.playground.ru:27910`);
  }
  catch (error) { console.log(`–û—à–∏–±–∫–∞: ${error.message}`) };
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Ä–∞–∑–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ QW
bot.command('ssqw', async (ctx) => {
  try {
    await searchServer(ctx, 'qw', `–ê–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞ –¥–æ–ª–∂–Ω–µ–Ω –±—ã—Ç—å —É–∫–∞–∑–∞–Ω –≤ –≤–∏–¥–µ IPAddress:Port –∏–ª–∏ Domen:Port, –Ω–∞–ø—Ä–∏–º–µ—Ä, 35.185.44.174:27500 –∏–ª–∏ qw.playground.ru:27500`);
  }
  catch (error) { console.log(`–û—à–∏–±–∫–∞: ${error.message}`) };
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

async function searchMap(ctx, game, msg) { //–§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–∞—Ä—Ç—ã
  try {
    const userId = getUserID(ctx);
    userContexts[userId] = ctx;
    const sm = ctx.message.text.split(' ');
    sm.shift();
    if (!sm || sm.join().trim() == '') {
      return ctx.reply(msg);
    }
    let msgId = 0;
    await ctx.reply('–°—Ç–∞—Ä—Ç –ø–æ–∏—Å–∫–∞ –∫–∞—Ä—Ç—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞—Ö...').then((message) => {
      msgId = message.message_id;
      console.log('msgId:', msgId);
    });
    refreshServers(userId, '', sm, true, game, false, msgId, false, true);
  }
  catch (error) { console.log(`–û—à–∏–±–∫–∞: ${error.message}`) };
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/


// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Ä–∞–∑–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∫–∞—Ä—Ç—ã Q2
bot.command('smq2', async (ctx) => {
  try {
    await searchMap(ctx, 'q2', `–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–∞—Ä—Ç(—ã), –Ω–∞–ø—Ä–∏–º–µ—Ä: /smq2 q2dm1 *rdm* *q2duel*`);
  }
  catch (error) { console.log(`–û—à–∏–±–∫–∞: ${error.message}`) };
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Ä–∞–∑–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∫–∞—Ä—Ç—ã QW
bot.command('smqw', async (ctx) => {
  try {
    await searchMap(ctx, 'qw', `–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–∞—Ä—Ç(—ã), –Ω–∞–ø—Ä–∏–º–µ—Ä: /smqw e1* *dm* *duel*`);
  }
  catch (error) { console.log(`–û—à–∏–±–∫–∞: ${error.message}`) };
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

async function searchInfo(ctx, game, msg) { //–§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–∑–æ–≤–∞ –æ—Ç—á–µ—Ç–∞ –ø–æ–∏—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤
  try {
    const userId = getUserID(ctx);
    userContexts[userId] = ctx;

    let sm = ctx.message.text.split(' ');
    sm.shift();
    if (!sm || sm.join().trim() == '') {
      sm = [];
      sm[0] = '*';
    }

    let msgId = 0;
    await ctx.reply(msg).then((message) => {
      msgId = message.message_id;
      //console.log('msgId:', msgId);
    });
    refreshServers(userId, '', sm, true, game, true, msgId);
  }
  catch (error) { console.log(`–û—à–∏–±–∫–∞: ${error.message}`) };
}


// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Ä–∞–∑–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤ Q2 —Å –Ω–∞–ª–∏—á–∏–µ–º –∏–≥—Ä–æ–∫–æ–≤.
bot.command('siq2', async (ctx) => {
  try {
    await searchInfo(ctx, 'q2', '–°—Ç–∞—Ä—Ç –ø–æ–∏—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤ Quake II ...');
  }
  catch (error) { console.log(`–û—à–∏–±–∫–∞: ${error.message}`) };
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Ä–∞–∑–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤ QW —Å –Ω–∞–ª–∏—á–∏–µ–º –∏–≥—Ä–æ–∫–æ–≤.
bot.command('siqw', async (ctx) => {
  try {
    await searchInfo(ctx, 'qw', '–°—Ç–∞—Ä—Ç –ø–æ–∏—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤ QuakeWorld ...');
  }
  catch (error) { console.log(`–û—à–∏–±–∫–∞: ${error.message}`) };
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

async function findInfo(ctx, game, msg) { //–§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–∑–æ–≤–∞ –æ—Ç—á–µ—Ç–∞ –ø–æ–∏—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤
  try {
    const userId = getUserID(ctx);
    userContexts[userId] = ctx;

    let fi = ctx.message.text.split(' ');
    fi.shift();
    if (!fi || fi.join().trim() == '') {
      //fi = [];
      //fi[0] = '*';
      let txt = '';
      if (game == 'q2') txt = '/fq2 playground';
      else if (game == 'qw') txt = '/fqw bot';
      await ctx.reply('–£–∫–∞–∂–∏—Ç–µ, —á—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –Ω–∞–π—Ç–∏ —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª –ø–æ—Å–ª–µ –≤–≤–æ–¥–∞ –∫–æ–º–∞–Ω–¥—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä: ' + txt);
      return;
    }

    if (String(fi[0]).trim().length < config.FIND_TEXT_LIMIT) {
      await ctx.reply('–º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏: ' + config.FIND_TEXT_LIMIT);
      return;
    }

    let msgId = 0;
    await ctx.reply(msg).then((message) => {
      msgId = message.message_id;
      //console.log('msgId:', msgId);
    });
    refreshServers(userId, '', ['*'], true, game, true, msgId, false, true, fi[0]);
  }
  catch (error) { console.log(`–û—à–∏–±–∫–∞: ${error.message}`) };
}


// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Ä–∞–∑–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤ Q2 —Å –Ω–∞–ª–∏—á–∏–µ–º –∏–≥—Ä–æ–∫–æ–≤.
bot.command('fq2', async (ctx) => {
  try {
    await findInfo(ctx, 'q2', '–°—Ç–∞—Ä—Ç –ø–æ–∏—Å–∫–∞ –ø–æ–∏—Å–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ Quake II ...');
  }
  catch (error) { console.log(`–û—à–∏–±–∫–∞: ${error.message}`) };
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Ä–∞–∑–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤ QW —Å –Ω–∞–ª–∏—á–∏–µ–º –∏–≥—Ä–æ–∫–æ–≤.
bot.command('fqw', async (ctx) => {
  try {
    await findInfo(ctx, 'qw', '–°—Ç–∞—Ä—Ç –ø–æ–∏—Å–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ QuakeWorld ...');
  }
  catch (error) { console.log(`–û—à–∏–±–∫–∞: ${error.message}`) };
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

async function stats(userId, ctx, game, displayMsg, shortStats) {
  try {

    if (typeof ctx === 'undefined' || !ctx || ctx == undefined) {
      //ctx = userContexts[userId];
    }
    else {
      userId = getUserID(ctx);
      userContexts[userId] = ctx;
    }

    if (typeof displayMsg === 'undefined' || displayMsg == undefined) {
      displayMsg = true;
    }

    if (typeof shortStats === 'undefined' || shortStats == undefined) {
      shortStats = false;
    }

    const userSettings = await getUserSettings(userId);
    let themeId = userSettings ? userSettings.themeId : null; // –ü–æ–ª—É—á–∞–µ–º themeId –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const chatId = userSettings ? userSettings.chatId : null; // –ü–æ–ª—É—á–∞–µ–º chatId –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    let autodelhistory = userSettings && userSettings.autodelhistory && userSettings.autodelhistory != undefined ? userSettings.autodelhistory : 0;

    let msgId = 0;
    if (displayMsg) {
      await ctx.reply(`–°—Ç–∞—Ä—Ç —Å–±–æ—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ –∏–≥—Ä–µ ${config.GAMES_TITLES[game]}...`).then((message) => {
        msgId = message.message_id;
        //console.log('msgId:', msgId);
      });
    }

    let statsRes = await GetServersStats(game);
    let statsMsg = `‚úç –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∏–≥—Ä–µ ${config.GAMES_TITLES[game]}:

üóÑÔ∏è –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ—Ä–≤–µ—Ä–æ–≤: ${statsRes.serverCount}

üïµÔ∏è –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤: ${statsRes.playersCount}

üõ£Ô∏è –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç:  ${statsRes.mapsCount}

„Ä∞Ô∏é„Ä∞Ô∏é„Ä∞Ô∏é„Ä∞Ô∏é„Ä∞Ô∏é„Ä∞Ô∏é„Ä∞Ô∏é„Ä∞Ô∏é„Ä∞Ô∏é„Ä∞Ô∏é„Ä∞Ô∏é„Ä∞Ô∏é
${!shortStats ? '\nüèùÔ∏è –ö–∞—Ä—Ç—ã:\n' + statsRes.uniqueMaps
        + '\n\n„Ä∞Ô∏é„Ä∞Ô∏é„Ä∞Ô∏é„Ä∞Ô∏é„Ä∞Ô∏é„Ä∞Ô∏é„Ä∞Ô∏é„Ä∞Ô∏é„Ä∞Ô∏é„Ä∞Ô∏é„Ä∞Ô∏é„Ä∞Ô∏é\n' : ''}
${!shortStats ? '\nüïπÔ∏è –†–µ–∂–∏–º—ã:\n' + statsRes.uniqueMatchTypes
        + '\n\n„Ä∞Ô∏é„Ä∞Ô∏é„Ä∞Ô∏é„Ä∞Ô∏é„Ä∞Ô∏é„Ä∞Ô∏é„Ä∞Ô∏é„Ä∞Ô∏é„Ä∞Ô∏é„Ä∞Ô∏é„Ä∞Ô∏é„Ä∞Ô∏é\n\n' : ''}‚õπ –ò–≥—Ä–æ–∫–∏:
${statsRes.uniquePlayers}
${!shortStats ? '\n\nüèã –¢–æ–ø-5 –∏–≥—Ä–æ–∫–æ–≤ –ø–æ —Ñ—Ä–∞–≥–∞–º' + statsRes.top5Players : ''}
`;
    let previousMessageId;
    let sentMessage;
    if (autodelhistory == 1) {
      if (!themeId) previousMessageId = messageIds['stats' + game + String(chatId)];
      else previousMessageId = messageIds['stats' + game + String(chatId) + String(themeId)];
    }
    if (msgId) {
      try {
        await bot.telegram.deleteMessage(userId, msgId);
      } catch (error) { };
    }
    let chunks = statsMsg.match(/(.|[\n\r]){1,4096}/g);
    for (const chunk of chunks) {
      if (ctx) {
        sentMessage = await ctx.reply(chunk);
        if (autodelhistory == 1) messageIds['stats' + game + String(chatId)] = sentMessage.message_id;
      }
      else if (!themeId) {
        sentMessage = await bot.telegram.sendMessage(chatId, chunk);
        if (autodelhistory == 1) messageIds[stats + game + chatId] = sentMessage.message_id;
      }
      else {
        sentMessage = await bot.telegram.sendMessage(chatId, chunk, { message_thread_id: themeId });
        if (autodelhistory == 1) messageIds['stats' + game + String(chatId) + String(themeId)] = sentMessage.message_id;
      }
    }
    //sentMessage.message_id

    log('stats -> autodelhistory' + autodelhistory + ', previousMessageId=' + previousMessageId + ', chatId=' + chatId + ', themeId=' + themeId);
    if (autodelhistory && previousMessageId) {
      if (!themeId) await bot.telegram.deleteMessage(chatId, previousMessageId);
      else await bot.telegram.deleteMessage(chatId, previousMessageId, { message_thread_id: themeId });
    }

  }
  catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error) };
}


/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

async function statsSetup(ctx, game) { //–≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ altview
  try {

    const userId = getUserID(ctx);
    userContexts[userId] = ctx; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    let statsMonitoring = parseInt(ctx.message.text.split(' ')[1]);
    let userSettings;

    if (game == 'q2') {

      if (isNaN(statsMonitoring) || statsMonitoring < 0 || (statsMonitoring > 1)) {
        userSettings = await getUserSettings(userId);
        statsMonitoring = userSettings && userSettings.sq2m != undefined ? userSettings.sq2m : 0;
        return ctx.reply('–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞:\n0 - –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤ ' + game + ' –≤—ã–∫–ª—é—á–µ–Ω\n1 - –≤–∫–ª—é—á—ë–Ω.\n\n–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: ' + statsMonitoring);
      }
      await updateUserSettings(userId, { sq2m: statsMonitoring });
      userSettings = await getUserSettings(userId);
      statsMonitoring = userSettings.sq2m;
    }
    else if (game == 'qw') {

      if (isNaN(statsMonitoring) || statsMonitoring < 0 || (statsMonitoring > 1)) {
        userSettings = await getUserSettings(userId);
        statsMonitoring = userSettings && userSettings.sqwm != undefined ? userSettings.sqwm : 0;
        return ctx.reply('–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞:\n0 - –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤ ' + game + ' –≤—ã–∫–ª—é—á–µ–Ω\n1 - –≤–∫–ª—é—á—ë–Ω.\n\n–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: ' + statsMonitoring);
      }
      await updateUserSettings(userId, { sqwm: statsMonitoring });
      userSettings = await getUserSettings(userId);
      statsMonitoring = userSettings.sqwm;
    }

    if (statsMonitoring > 0) {
      return ctx.reply('–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤ ' + game + ': –í–ö–õ–Æ–ß–ï–ù.');
    } else {
      return ctx.reply('–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤ ' + game + ': –í–´–ö–õ–Æ–ß–ï–ù.');
    }



  } catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error); }
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤ q2 –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
bot.command('sq2m', async (ctx) => {
  try {
    await statsSetup(ctx, 'q2');
  } catch (error) { console.log(`–û—à–∏–±–∫–∞:`, error) };
});

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤ qw –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
bot.command('sqwm', async (ctx) => {
  try {
    await statsSetup(ctx, 'qw');
  } catch (error) { console.log(`–û—à–∏–±–∫–∞:`, error) };
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Ä–∞–∑–æ–≤–æ–≥–æ –≤—ã–∑–æ–≤–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ —Å–µ—Ä–≤–µ—Ä–∞–º.
bot.command('stats', async (ctx) => {
  try {
    const userId = getUserID(ctx);
    userContexts[userId] = ctx;
    const userSettings = await getUserSettings(userId);
    const games = !userSettings || userSettings === undefined || userSettings.games === undefined || userSettings.games.join().trim() == '' ? [] : userSettings.games;
    //console.log('games=' + games.join(', ') + ', msgId='+msgId);
    if (games.length == 0) {
      await ctx.reply('–í–Ω–∞—á–∞–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∏–≥—Ä—ã –∫–æ–º–∞–Ω–¥–æ–π /ag');
      return;
    }
    for (i = 0; i < games.length; i++) {
      //console.log('1 - go to refreshPlayers: user=' + userId + ', game=' + games[i] + ', games.length=' + games.length);
      await stats('', ctx, games[i], true);
    };
  }
  catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error) };
});


// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Ä–∞–∑–æ–≤–æ–≥–æ –≤—ã–∑–æ–≤–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ —Å–µ—Ä–≤–µ—Ä–∞–º q2.
bot.command('sq2', async (ctx) => {
  try {
    const userId = getUserID(ctx);
    userContexts[userId] = ctx;
    await stats('', ctx, 'q2', true);
  }
  catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error) };
});

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Ä–∞–∑–æ–≤–æ–≥–æ –≤—ã–∑–æ–≤–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ —Å–µ—Ä–≤–µ—Ä–∞–º qw.
bot.command('sqw', async (ctx) => {
  try {
    const userId = getUserID(ctx);
    userContexts[userId] = ctx;
    await stats('', ctx, 'qw', true);
  }
  catch (error) { console.log(`–û—à–∏–±–∫–∞: `, error) };
});

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

async function GetServersStats(game) {
  try {
    const botSettings = await getUserSettings(0);
    const botFilterPlayers = botSettings && botSettings.botFilter != undefined ? botSettings.botFilter : [];
    if (botSettings && botSettings.allservers && botSettings.allservers[game]) {
      const servers = botSettings.allservers[game];

      const serverCount = servers.length;
      const uniqueMaps = new Set(); //—Å–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç
      const uniqueMatchTypes = new Set();
      const uniquePlayers = new Set(); //—Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤
      const playersCount = 0;
      const mapsCount = 0;
      const allPlayers = [];

      servers.forEach(server => {
        uniqueMaps.add(server.mapname);
        uniqueMatchTypes.add(server.match_type);
        server.serverPlayers.forEach(player => {
          const foundPlayer = includesPlayer(botFilterPlayers, normalNameHard(player.name));
          if (foundPlayer == '') {
            uniquePlayers.add(player.name);
            allPlayers.push(player);
          }
        });
      });

      // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é
      const sortedMaps = Array.from(uniqueMaps).sort();
      const sortedMatchTypes = Array.from(uniqueMatchTypes).sort();
      const sortedPlayers = Array.from(uniquePlayers).sort();
      // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏–≥—Ä–æ–∫–æ–≤ –ø–æ –æ—á–∫–∞–º
      const sortedPlayersByScore = allPlayers.sort((a, b) => b.score - a.score).slice(0, 5); // –ë–µ—Ä—ë–º —Ç–æ–ø-5 –∏–≥—Ä–æ–∫–æ–≤

      return {
        serverCount: serverCount,
        playersCount: uniquePlayers.size,
        mapsCount: uniqueMaps.size,
        uniqueMaps: sortedMaps.join(', '),
        uniqueMatchTypes: sortedMatchTypes.join(', '),
        uniquePlayers: sortedPlayers.join(', '),
        top5Players: sortedPlayersByScore.map((player, index) => `${index + 1}. ${player.name} (${player.score})`).join(', ') // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–æ–ø-5 –∏–≥—Ä–æ–∫–æ–≤ —Å —Ü–∏—Ñ—Ä–∞–º–∏
      };
    } else {
      return {
        serverCount: 0,
        playersCount: 0,
        mapsCount: 0,
        uniqueMaps: '',
        uniqueMatchTypes: '',
        uniquePlayers: '',
        top5Players: ''
      };
    }
  } catch (error) {
    console.log('GetServersStats error: ', error);
  }
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/
function canDetailsLog() {
  try {
    if (config.PROD == 1) {
      return true;
    }
    else return false;
  } catch (error) {
    console.log(`–û—à–∏–±–∫–∞: ${error.message}`);
    return true;
  };
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

function log(msg, msg2) {
  if (canDetailsLog()) {
    if (typeof msg2 === 'undefined') console.log(msg);
    else console.log(msg, msg2);
  }
}


// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–≤
async function initializeAutoServersUpdate() {
  try {
    const updateServersEnabled = true;
    const timerUpdate = config.SERVERS_UPDATE_TIMER;// 30;
    console.log('–°—Ç–∞—Ä—Ç –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–æ–≤');
    if (updateServersEnabled) {
      await startAutoServersUpdate(timerUpdate); // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º —Ç–∞–π–º–µ—Ä–æ–º
    }

  } catch (error) {
    console.log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∞–≤—Ç–æ–ø–æ–∏—Å–∫–∞: `, error);
  }
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–ø–¥–µ–π—Ç–∞
async function startAutoServersUpdate(interval) {
  try {

    if (typeof interval === 'undefined') {
      interval = 30; // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ —Ç–∞–π–º–µ—Ä –Ω–µ —É–∫–∞–∑–∞–Ω
    }

    setInterval(async () => {

      const games = config.GAMES.split(',');
      let allServers = {
        q2: [],
        qw: []
      };
      //const botSettings = await getUserSettings(0);

      for (curGameIdx = 0; curGameIdx < games.length; curGameIdx++) {
        let serverList;
        let serverPlayers;
        let serverInfo;

        if (games[curGameIdx] == 'q2') {
          console.log('–°—Ç–∞—Ä—Ç –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–æ–≤ ', games[curGameIdx]);
          serverList = await getServerListQ2();
          const promises = serverList.map(async (server) => {
            const [ip, port] = server.split(':');
            ({ players: serverPlayers, serverInfo } = await queryServerQ2(ip, port));
            serverInfo.serverPlayers = serverPlayers;
            allServers.q2.push(serverInfo);
          });
          // –ñ–¥–µ–º, –ø–æ–∫–∞ –≤—Å–µ –ø—Ä–æ–º–∏—Å—ã –∑–∞–≤–µ—Ä—à–∞—Ç—Å—è
          await Promise.allSettled(promises);
          console.log('allServers.length=', allServers.q2.length);
        }
        else if (games[curGameIdx] == 'qw') {
          console.log('–°—Ç–∞—Ä—Ç –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–æ–≤ ', games[curGameIdx]);
          serverList = await getServerListQW();
          const promises = serverList.map(async (server) => {
            const [ip, port] = server.split(':');
            ({ players: serverPlayers, serverInfo } = await queryServerQW(ip, port));
            serverInfo.serverPlayers = serverPlayers;
            allServers.qw.push(serverInfo);
          });
          // –ñ–¥–µ–º, –ø–æ–∫–∞ –≤—Å–µ –ø—Ä–æ–º–∏—Å—ã –∑–∞–≤–µ—Ä—à–∞—Ç—Å—è
          await Promise.allSettled(promises);
          console.log('allServers.length=', allServers.qw.length);
        }

      }
      await updateUserSettings(0, { allservers: allServers });
      console.log('–î–∞–Ω–Ω—ã–µ –ø–æ —Å–µ—Ä–≤–µ—Ä–∞–º –∏ –∏–≥—Ä–æ–∫–∞–º –æ–±–Ω–æ–≤–ª–µ–Ω—ã –≤ –ë–î');

    }, interval * 1000);
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: ${error.message}`) };
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

async function getServerList(game) {
  try {
    log('getServerList - game:', game);
    const botSettings = await getUserSettings(0);
    if (botSettings && botSettings.allservers && botSettings.allservers[game]) {
      return botSettings.allservers[game].map(server => `${server.serverIp}:${server.serverPort}`);
    } else {
      return [];
    }
  } catch (error) {
    log('getServerList:', error);
    return [];
  }
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

async function getServerListFromCache(game) { //–¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–æ–≤ –∏–∑ –∫—ç—à–∞ –Ω–∞–ø—Ä—è–º—É—é
  let servers = [];
  try {
    log('getServerListFromCache - game:', game);
    if (game == 'q2') servers = await getServerListQ2();
    else if (game == 'qw') servers = await getServerListQW();
  } catch (error) {
    console.log('getServerListFromCache:', error);
    return [];
  }
  return servers;
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

async function queryServer(game, ip, port) {
  let serverPlayers;
  let serverInfo;
  try {
    //log('queryServer - game:', game);
    const botSettings = await getUserSettings(0);
    if (botSettings && botSettings.allservers && botSettings.allservers[game]) {
      const server = botSettings.allservers[game].find(server => {
        return server.serverIp === ip && server.serverPort === port;
      });
      if (server) {
        serverPlayers = server.serverPlayers;
        serverInfo = { ...server }; // –°–æ–∑–¥–∞–µ–º –∫–æ–ø–∏—é, —á—Ç–æ–±—ã –Ω–µ –∏–∑–º–µ–Ω—è—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–π –æ–±—ä–µ–∫—Ç
        delete serverInfo.serverPlayers; // –£–¥–∞–ª—è–µ–º serverPlayers –∏–∑ serverInfo
        return { serverPlayers, serverInfo };
      } else {
        return { serverPlayers: [], serverInfo: {} }; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç—ã–µ –æ–±—ä–µ–∫—Ç—ã, –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω
      }
    } else {
      return { serverPlayers: [], serverInfo: {} }; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç—ã–µ –æ–±—ä–µ–∫—Ç—ã, –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤ –Ω–µ—Ç
    }
  } catch (error) {
    log('getServerList:', error);
    return { serverPlayers: [], serverInfo: {} }; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç—ã–µ –æ–±—ä–µ–∫—Ç—ã, –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤ –Ω–µ—Ç
  }
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

async function queryServerDirect(game, ip, port) {
  let serverPlayers = [];
  let serverInfo = {};
  try {
    if (game == 'q2') {
      ({ players: serverPlayers, serverInfo } = await queryServerQ2(ip, port));
    } else if (game == 'qw') {
      ({ players: serverPlayers, serverInfo } = await queryServerQW(ip, port));
    }
    return { serverPlayers, serverInfo };

  } catch (error) {
    //log('getServerList:', error);
    return { serverPlayers: [], serverInfo: {} }; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç—ã–µ –æ–±—ä–µ–∫—Ç—ã, –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤ –Ω–µ—Ç
  }
}

/* -------------------------------------------------------------...--------------------------------------------------------------*/

async function queryServerDirect(game, ip, port) {
  let serverPlayers = [];
  let serverInfo = {};
  try {
    if (game == 'q2') {
      ({ players: serverPlayers, serverInfo } = await queryServerQ2(ip, port));
    } else if (game == 'qw') {
      ({ players: serverPlayers, serverInfo } = await queryServerQW(ip, port));
    }
    return { serverPlayers, serverInfo };

  } catch (error) {
    log('getServerList:', error);
    return { serverPlayers: [], serverInfo: {} }; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç—ã–µ –æ–±—ä–µ–∫—Ç—ã, –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤ –Ω–µ—Ç
  }
}

/* -------------------------------------------------------------...--------------------------------------------------------------*/
// üîÅ –ì–õ–û–ë–ê–õ–¨–ù–´–ô –û–ü–†–û–° –°–ï–†–í–ï–†–û–í –ò –ó–ê–ü–û–õ–ù–ï–ù–ò–ï –ö–≠–®–ê –í –ü–ê–ú–Ø–¢–ò –ë–û–¢–ê

async function refreshGlobalServersCache() {
  if (isGlobalServerCacheRefreshing) {
    console.log('refreshGlobalServersCache: –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –µ—â—ë –Ω–µ –∑–∞–∫–æ–Ω—á–µ–Ω–æ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Ç–∏–∫');
    return;
  }

  isGlobalServerCacheRefreshing = true;

  try {
    console.log('refreshGlobalServersCache: —Å—Ç–∞—Ä—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤');
    const games = config.GAMES ? config.GAMES.split(',') : ['q2', 'qw'];
    const now = new Date();

    // –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∫—ç—à, —á—Ç–æ–±—ã –ø–æ—Ç–æ–º –∞—Ç–æ–º–∞—Ä–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å —Å—Å—ã–ª–∫—É
    const newCache = {
      q2: {},
      qw: {}
    };

    // –ø–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–¥–∏–Ω —Ä–∞–∑
    let allUsers = [];
    try {
      allUsers = await getAllUsers();
    } catch (e) {
      console.log('refreshGlobalServersCache: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', e);
    }

    for (let i = 0; i < games.length; i++) {
      const game = games[i].trim();
      if (!game) continue;

      // –º–Ω–æ–∂–µ—Å—Ç–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤ –¥–ª—è —ç—Ç–æ–π –∏–≥—Ä—ã
      const uniqueServers = new Set();

      // 1) —Å–µ—Ä–≤–µ—Ä–∞ –∏–∑ –º–∞—Å—Ç–µ—Ä-—Å–ø–∏—Å–∫–∞
      let serverList = [];
      if (game === 'q2') {
        serverList = await getServerListQ2();
      } else if (game === 'qw') {
        serverList = await getServerListQW();
      } else {
        continue;
      }

      if (Array.isArray(serverList)) {
        serverList.forEach((s) => {
          if (s && typeof s === 'string') {
            uniqueServers.add(s.trim());
          }
        });
      }

      // 2) —Å–µ—Ä–≤–µ—Ä–∞ –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
      if (Array.isArray(allUsers) && allUsers.length > 0) {
        for (const user of allUsers) {
          try {
            // –µ—Å–ª–∏ getAllUsers —É–∂–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –º–æ–∂–Ω–æ –±—É–¥–µ—Ç —É–ø—Ä–æ—Å—Ç–∏—Ç—å;
            // –Ω–æ –Ω–∞–¥—ë–∂–Ω–µ–µ —Å–µ–π—á–∞—Å –µ—â—ë —Ä–∞–∑ –ø–æ–ª—É—á–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ userId
            const userId = user.userId !== undefined ? user.userId : null;
            if (userId === null || userId === undefined) continue;

            const userSettings = await getUserSettings(userId);
            if (!userSettings) continue;

            let userServers = [];
            if (game === 'q2') {
              userServers = userSettings.q2servers || [];
            } else if (game === 'qw') {
              userServers = userSettings.qwservers || [];
            }

            if (Array.isArray(userServers)) {
              userServers.forEach((s) => {
                if (s && typeof s === 'string') {
                  uniqueServers.add(s.trim());
                }
              });
            }
          } catch (e) {
            console.log('refreshGlobalServersCache: –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–±–æ—Ä–µ —Å–µ—Ä–≤–µ—Ä–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', user, e);
          }
        }
      }

      const allServers = Array.from(uniqueServers);

      if (!Array.isArray(allServers) || allServers.length === 0) {
        console.log(`refreshGlobalServersCache: –¥–ª—è –∏–≥—Ä—ã ${game} —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤ –ø—É—Å—Ç (master+users)`);
        continue;
      }

      console.log(
        `refreshGlobalServersCache: –∏–≥—Ä–∞=${game}, —Å–µ—Ä–≤–µ—Ä–æ–≤ –∏–∑ master=${Array.isArray(serverList) ? serverList.length : 0}, ` +
        `–≤—Å–µ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö (master+users)=${allServers.length}`
      );

      const promises = allServers.map(async (server) => {
        const [ip, port] = server.split(':');
        const key = `${ip}:${port}`;
        try {
          const { serverPlayers, serverInfo } = await queryServerDirect(game, ip, port);

          newCache[game][key] = {
            game,
            ip,
            port,
            server: key,
            serverInfo,
            serverPlayers,
            lastUpdated: now
          };
        } catch (err) {
          console.log(`refreshGlobalServersCache: –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ ${server} (${game})`, err);
          // –ø—Ä–∏ –æ—à–∏–±–∫–µ –ø—Ä–æ—Å—Ç–æ –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º —ç—Ç–æ—Ç —Å–µ—Ä–≤–µ—Ä –≤ –Ω–æ–≤—ã–π —Å–Ω—ç–ø—à–æ—Ç
        }
      });

      await Promise.allSettled(promises);
    }

    // üëá –∞—Ç–æ–º–∞—Ä–Ω–∞—è –∑–∞–º–µ–Ω–∞ —Å—Å—ã–ª–æ–∫ –Ω–∞ –Ω–æ–≤—ã–π —Å–Ω—ç–ø—à–æ—Ç
    globalServerCache.q2 = newCache.q2;
    globalServerCache.qw = newCache.qw;

    //console.log('refreshGlobalServersCache: –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∫—ç—à –ø–æ —Å–µ—Ä–≤–µ—Ä–∞–º –æ–±–Ω–æ–≤–ª—ë–Ω');
  } catch (error) {
    console.log('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –∫—ç—à–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤:', error);
    // –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ —Å—Ç–∞—Ä—ã–π globalServerCache –æ—Å—Ç–∞—ë—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω—ã–º
  } finally {
    isGlobalServerCacheRefreshing = false;
  }
}


/* -------------------------------------------------------------...--------------------------------------------------------------*/

// –ó–∞–ø—É—Å–∫ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–≥–æ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –æ–ø—Ä–æ—Å–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤
function startGlobalServerPolling() {
  try {
    const intervalSec = config.GLOBAL_REFRESH_INTERVAL || 10;
    if (intervalSec <= 0) {
      console.log('GLOBAL_REFRESH_INTERVAL <= 0, –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–ø—Ä–æ—Å —Å–µ—Ä–≤–µ—Ä–æ–≤ –æ—Ç–∫–ª—é—á—ë–Ω');
      return;
    }

    const intervalMs = intervalSec * 1000;

    if (globalServerTimer) {
      clearTimeout(globalServerTimer);
      globalServerTimer = null;
    }

    console.log(`–ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–ø—Ä–æ—Å —Å–µ—Ä–≤–µ—Ä–æ–≤ –∑–∞–ø—É—â–µ–Ω, –∏–Ω—Ç–µ—Ä–≤–∞–ª = ${intervalSec} —Å–µ–∫`);

    const tick = async () => {
      await refreshGlobalServersCache();
      globalServerTimer = setTimeout(tick, intervalMs);
    };

    // –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ —Å—Ä–∞–∑—É
    tick();
  } catch (error) {
    console.log('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –æ–ø—Ä–æ—Å–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤:', error);
  }
}

function getServerFromGlobalCache(game, ip, port) {
  const gameCache = globalServerCache[game];
  if (!gameCache) return null;
  const key = `${ip}:${port}`;
  return gameCache[key] || null;
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/


// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤
async function startAutoSearch(userId, interval) {

  try {
    if (userTimers[userId]) {
      clearInterval(userTimers[userId]);
    }
    if (typeof interval === 'undefined') {
      interval = 30; // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ —Ç–∞–π–º–µ—Ä –Ω–µ —É–∫–∞–∑–∞–Ω
    }

    userTimers[userId] = setInterval(async () => {

      const userSettings = await getUserSettings(userId);
      if (userSettings && userSettings != undefined) {
        const sleepTime = userSettings.sleepTime; // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ "HH:MM-HH:MM"
        const isBanned = userSettings && userSettings.banned && userSettings.banned != undefined ? userSettings.banned : false;
        const statsMonitoringQ2 = userSettings && userSettings.sq2m != undefined ? userSettings.sq2m : 0;
        const statsMonitoringQW = userSettings && userSettings.sqwm != undefined ? userSettings.sqwm : 0;
        if (isBanned !== false) {
          console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –¥–ª—è –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ' + userId);
          return;
        }

        const currentTime = new Date();

        if (isInSleepTime(currentTime, sleepTime)) {
          console.log('–í—Ä–µ–º—è —Å–Ω–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ', userId);
          return; // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –º–æ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –ø–µ—Ä–∏–æ–¥ —Å–Ω–∞, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
        }

        if (statsMonitoringQ2 > 0) await stats(userId, null, 'q2', false, true);
        if (statsMonitoringQW > 0) await stats(userId, null, 'qw', false, true);

        await refresh(userId);
      }
    }, interval * 1000);
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: ${error.message}`) };
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞
async function stopAutoSearch(userId) {
  try {
    if (userTimers[userId]) {
      clearInterval(userTimers[userId]);
      delete userTimers[userId];
    }
  } catch (error) { console.log(`–û—à–∏–±–∫–∞: ${error.message}`) };
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –ø–æ–ø–∞–¥–∞–µ—Ç –ª–∏ —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ –ø–µ—Ä–∏–æ–¥ —Å–Ω–∞
function isInSleepTime(currentTime, sleepTime) {
  try {
    if (!sleepTime) return false;

    const [startStr, endStr] = sleepTime.split('-');
    const [startHours, startMinutes] = startStr.split(':').map(Number);
    const [endHours, endMinutes] = endStr.split(':').map(Number);

    const start = new Date(currentTime.getFullYear(), currentTime.getMonth(), currentTime.getDate(), startHours, startMinutes);
    const end = new Date(currentTime.getFullYear(), currentTime.getMonth(), currentTime.getDate(), endHours, endMinutes);

    // –ï—Å–ª–∏ –∫–æ–Ω–µ—Ü –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ —Ä–∞–Ω—å—à–µ –Ω–∞—á–∞–ª–∞, –∑–Ω–∞—á–∏—Ç –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç –ø–æ–ª–Ω–æ—á—å
    if (end < start) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–ø–∞–¥–∞–µ—Ç –ª–∏ —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ –æ–¥–∏–Ω –∏–∑ –¥–≤—É—Ö –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤:
      // 1. –û—Ç –Ω–∞—á–∞–ª–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –¥–æ –∫–æ–Ω—Ü–∞ –¥–Ω—è
      // 2. –û—Ç –Ω–∞—á–∞–ª–∞ –¥–Ω—è –¥–æ –∫–æ–Ω—Ü–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞
      return currentTime >= start || currentTime <= end;
    }

    // –û–±—ã—á–Ω—ã–π —Å–ª—É—á–∞–π, –∫–æ–≥–¥–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª –Ω–µ –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç –ø–æ–ª–Ω–æ—á—å
    return currentTime >= start && currentTime <= end;
  } catch (error) {
    console.log(`–û—à–∏–±–∫–∞: ${error.message}`);
  }
}
/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
async function initializeAutoSearch() {
  try {
    console.log('–°—Ç–∞—Ä—Ç –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
    const users = await getAllUsers(); // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    for (const user of users) {
      const timerEnabledExists = (user.timerEnabled && user.timerEnabled != undefined && user.timerEnabled == 1) ? true : await checkCanTimer(user.userId);
      const monitoringEnabled = (user.timer && user.timer != undefined && user.timer > 0) && timerEnabledExists ? true : false;
      const userSettings = await getUserSettings(user.userId);
      const timerEnabled = userSettings && userSettings != undefined && userSettings.timerEnabled && userSettings.timerEnabled != undefined ? userSettings.timerEnabled : 0;
      if (monitoringEnabled && timerEnabled != 1) await updateUserSettings(user.userId, { timerEnabled: 1 });

      console.log('monitoringEnabled', user.userId + ' : ' + monitoringEnabled);
      //const isBanned = banCheck(user.userId);
      if (monitoringEnabled && await checkCanTimer(user.userId)) {
        console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ', user.userId);
        await startAutoSearch(user.userId, user.timer); // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º —Ç–∞–π–º–µ—Ä–æ–º
      }
    }
  } catch (error) {
    console.log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∞–≤—Ç–æ–ø–æ–∏—Å–∫–∞: `, error);
  }
}

/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

async function deleteBotMessagesInTopic(chatId, messageThreadId) {
  try {

    if (typeof messageThreadId === 'undefined') {
      messageThreadId = null; // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    }

    // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –±–æ—Ç–∞ –≤ —Ç–µ–º–µ
    if (messageThreadId) {
      const messages = await bot.telegram.getChatMessages(chatId, {
        message_thread_id: messageThreadId,
        from_id: botId, // ID –±–æ—Ç–∞ (—É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏)
      });

      // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞ –≤ —Ç–µ–º–µ
      for (const message of messages) {
        await bot.telegram.deleteMessage(chatId, message.message_id, {
          message_thread_id: messageThreadId,
        });
      }
    }
    else {
      const messages = await bot.telegram.getChatMessages(chatId, {
        from_id: botId, // ID –±–æ—Ç–∞ (—É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏)
      });

      // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞ –≤ —Ç–µ–º–µ
      for (const message of messages) {
        await bot.telegram.deleteMessage(chatId, message.message_id);
      }
    }

    log('–í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞ –≤ —Ç–µ–º–µ —É–¥–∞–ª–µ–Ω—ã');
  } catch (error) {
    log('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –±–æ—Ç–∞ –≤ —Ç–µ–º–µ:', error);
  }
}


/* --------------------------------------------------------------------------------------------------------------------------------------------------------*/

// –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
bot.launch()
  .then(() => {
    try {
      console.log('–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω');
      //initializeAutoServersUpdate(); //–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–æ–≤
      console.log('–ó–∞–ø—É—Å–∫ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–ø—Ä–æ—Å–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤...');
      startGlobalServerPolling();    // üîÅ –Ω–æ–≤—ã–π –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–ø—Ä–æ—Å —Å–µ—Ä–≤–µ—Ä–æ–≤ –∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∫—ç—à–∞ –≤ –ø–∞–º—è—Ç–∏
      console.log('–ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞ –ø–æ –¥–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...');
      initializeAutoSearch(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
    }
    catch (error) { console.log('error:', error); }
  })
  .catch(err => console.log('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞:', err)
  );